<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Pacific Coast Ponds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabase.js"></script>
  <style>
    :root{ --green:#1E5E37; --blue:#2CA7DF; --dark:#0F1C12; }
    body { font-family: Inter, ui-sans-serif, system-ui; }
    h1,h2,h3 { font-family: Oswald, sans-serif; text-transform: uppercase; letter-spacing: .5px; }
    .sidebar-link { display:flex; align-items:center; gap:.75rem; padding:.65rem 1rem; border-radius:.5rem; font-weight:600; font-size:.9rem; color:rgba(255,255,255,.75); transition:background .15s; cursor:pointer; }
    .sidebar-link:hover, .sidebar-link.active { background:rgba(255,255,255,.12); color:#fff; }
    .stat-card { background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1.5rem; }
    .btn-green { background:var(--green); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; transition:background .15s; }
    .btn-green:hover { background:var(--dark); }
    .btn-blue { background:var(--blue); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; }
    .btn-outline { border:2px solid #e5e7eb; background:#fff; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; font-size:.85rem; cursor:pointer; }
    .btn-outline:hover { border-color:#9ca3af; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; display:flex; align-items:center; justify-content:center; padding:1rem; }
    .modal { background:#fff; border-radius:.75rem; box-shadow:0 25px 50px rgba(0,0,0,.25); width:100%; max-width:32rem; max-height:90vh; overflow-y:auto; padding:1.5rem; }
    .field { width:100%; padding:.65rem .75rem; border:2px solid #e5e7eb; border-radius:.5rem; font-size:.9rem; outline:none; }
    .field:focus { border-color:var(--green); }
    .badge { display:inline-block; padding:.2rem .65rem; border-radius:9999px; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.4px; }
    .badge-green  { background:#dcfce7; color:#166534; }
    .badge-blue   { background:#dbeafe; color:#1e40af; }
    .badge-gray   { background:#f3f4f6; color:#6b7280; }
    .badge-yellow { background:#fef9c3; color:#854d0e; }
    .badge-red    { background:#fee2e2; color:#991b1b; }
    table { width:100%; border-collapse:collapse; }
    th { text-align:left; font-size:.7rem; text-transform:uppercase; letter-spacing:.5px; color:#9ca3af; padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
    td { padding:.75rem; border-bottom:1px solid #f3f4f6; font-size:.875rem; vertical-align:middle; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:#f9fafb; }
    /* Tom Select â€” match .field style */
    .ts-control { border:2px solid #e5e7eb !important; border-radius:.5rem !important; font-size:.9rem !important; padding:.45rem .75rem !important; box-shadow:none !important; background:#fff !important; min-height:unset !important; }
    .ts-wrapper.focus .ts-control { border-color:#1E5E37 !important; }
    .ts-wrapper.single.input-hidden .ts-control { cursor:pointer; }
    .ts-dropdown { border:1px solid #e5e7eb !important; border-radius:.5rem !important; font-size:.875rem !important; margin-top:2px !important; }
    .ts-dropdown .option { padding:.5rem .75rem; }
    .ts-dropdown .option.active { background:#1E5E37 !important; color:#fff !important; }
    .ts-dropdown .option:hover { background:#1E5E37 !important; color:#fff !important; }
    .ts-control .placeholder { color:#9ca3af !important; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center bg-[var(--dark)]">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
    <img src="https://paccoastponds.com/assets/logo.webp" alt="Pacific Coast Ponds" class="h-12 mx-auto mb-6">
    <h1 class="text-2xl text-center mb-6">Admin Login</h1>
    <form id="loginForm" class="space-y-4">
      <input id="loginEmail"    type="email"    placeholder="Email"    required class="field" />
      <input id="loginPassword" type="password" placeholder="Password" required class="field" />
      <button type="submit" class="btn-green w-full py-3 text-base">Sign In</button>
    </form>
    <p id="loginError" class="mt-3 text-red-600 text-sm text-center hidden"></p>
  </div>
</div>

<!-- â”€â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="appShell" class="hidden min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-56 bg-[var(--dark)] flex flex-col fixed inset-y-0 left-0 z-30">
    <div class="p-5 border-b border-white/10">
      <p class="text-white font-bold uppercase text-sm">Pacific Coast Ponds</p>
      <p class="text-white/40 text-xs mt-0.5">Admin</p>
    </div>
    <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
      <div class="sidebar-link active" data-page="dashboard">âŠ &nbsp;Dashboard</div>
      <div class="sidebar-link" data-page="customers">ğŸ‘¤ &nbsp;Customers</div>
      <div class="sidebar-link" data-page="jobs">ğŸ”¨ &nbsp;Jobs</div>
      <div class="sidebar-link" data-page="proposals">ğŸ“‹ &nbsp;Proposals</div>
      <div class="sidebar-link" data-page="techs">ğŸ”§ &nbsp;Technicians</div>
      <div class="sidebar-link" data-page="products">ğŸ“¦ &nbsp;Products</div>
      <div class="sidebar-link" data-page="requests">ğŸ“¥ &nbsp;Requests</div>
      <div class="sidebar-link" data-page="billing">ğŸ’³ &nbsp;Billing</div>
      <div class="sidebar-link" data-page="messages">ğŸ’¬ &nbsp;Messages</div>
      <div class="sidebar-link" data-page="map">ğŸ—º &nbsp;Map</div>
      <div class="sidebar-link" data-page="build">ğŸ— &nbsp;Build</div>
    </nav>
    <div class="p-3 border-t border-white/10">
      <div id="logoutBtn" class="sidebar-link">â†’ &nbsp;Sign Out</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="ml-56 flex-1 p-8 overflow-y-auto min-h-screen">
    <div id="pageContent"></div>
  </main>
</div>

<script>
// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}
function fmtMoney(n) { return n != null ? '$' + parseFloat(n).toFixed(2) : 'â€”'; }
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
  if (diff < 60)    return 'just now';
  if (diff < 3600)  return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}
function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function _searchable(id, onChange) {
  const el = document.getElementById(id); if (!el) return null;
  if (el.tomselect) el.tomselect.destroy();
  return new TomSelect(el, { create:false, maxOptions:500, closeAfterSelect:true, ...(onChange ? {onChange} : {}) });
}
function show(id)  { const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
function hide(id)  { const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
function toast(msg, ok=true) {
  const t = document.createElement('div');
  t.className = `fixed bottom-6 right-6 z-[100] px-5 py-3 rounded-lg text-white font-semibold shadow-xl ${ok?'bg-green-600':'bg-red-600'}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    const { data: p } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
    if (p?.role === 'admin') { showApp(); return; }
    await sb.auth.signOut();
  }
  showLogin();
}

function showLogin() {
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('appShell').classList.add('hidden');
}
function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  loadPage('dashboard');
}

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');
  const { error } = await sb.auth.signInWithPassword({
    email: document.getElementById('loginEmail').value,
    password: document.getElementById('loginPassword').value
  });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  checkAuth();
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await sb.auth.signOut(); showLogin();
});

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('[data-page]').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('[data-page]').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
    loadPage(el.dataset.page);
  });
});

function loadPage(page) {
  const pages = {
    dashboard:  renderDashboard,
    customers:  renderCustomers,
    jobs:       renderJobs,
    proposals:  renderProposals,
    techs:      renderTechs,
    products:  renderProducts,
    requests:  renderRequests,
    build:     renderBuild,
    billing:   renderBilling,
    messages:  renderMessages,
    map:       renderMap,
  };
  const el = document.getElementById('pageContent');
  if (pages[page]) pages[page](el);
}

// â”€â”€â”€ INVITE HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callInvite(email, full_name, phone, role, service_account_id) {
  const { data: { session } } = await sb.auth.getSession();
  const res = await fetch('/.netlify/functions/invite-user', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({ email, full_name, phone, role, service_account_id })
  });
  const json = await res.json();
  if (!res.ok) throw new Error(json.error || 'Invite failed');
  return json;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDashboard(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-8">Dashboard</h1>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Active Customers</p><p class="text-4xl font-bold mt-2" id="sC">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Jobs This Week</p><p class="text-4xl font-bold mt-2" id="sV">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Technicians</p><p class="text-4xl font-bold mt-2" id="sT">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Open Tickets</p><p class="text-4xl font-bold mt-2" id="sM">â€”</p></div>
    </div>
    <div class="bg-white rounded-xl border p-6">
      <h2 class="text-xl font-bold mb-4">Upcoming Visits</h2>
      <div id="upcomingList" class="text-gray-400 text-sm">Loading...</div>
    </div>
  `;

  const now = new Date();
  const week = new Date(now); week.setDate(now.getDate() + 7);

  const [cRes, vRes, tRes, mRes] = await Promise.all([
    sb.from('service_accounts').select('id', { count:'exact', head:true }).not('customer_id','is',null),
    sb.from('jobs').select('id', { count:'exact', head:true }).gte('scheduled_date', now.toISOString().split('T')[0]).lte('scheduled_date', week.toISOString().split('T')[0]).not('status','in','("cancelled","completed")'),
    sb.from('technicians').select('id', { count:'exact', head:true }),
    sb.from('tickets').select('id', { count:'exact', head:true }).eq('status', 'open'),
  ]);

  if (document.getElementById('sC')) {
    document.getElementById('sC').textContent = cRes.count ?? 0;
    document.getElementById('sV').textContent = vRes.count ?? 0;
    document.getElementById('sT').textContent = tRes.count ?? 0;
    document.getElementById('sM').textContent = mRes.count ?? 0;
  }

  const { data: upcoming } = await sb.from('jobs')
    .select('id, scheduled_date, status, service_accounts(contact_name), technicians(profiles(full_name))')
    .gte('scheduled_date', now.toISOString().split('T')[0])
    .not('status', 'in', '("completed","cancelled")')
    .order('scheduled_date', { ascending: true })
    .limit(8);

  const uvEl = document.getElementById('upcomingList');
  if (!uvEl) return;
  if (!upcoming?.length) { uvEl.innerHTML = '<p class="text-gray-400">No upcoming jobs scheduled.</p>'; return; }
  uvEl.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Status</th></tr></thead>
    <tbody>${upcoming.map(v => `<tr>
      <td>${fmtDate(v.scheduled_date)}</td>
      <td class="font-medium">${v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”'}</td>
      <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
      <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderCustomers(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Customers</h1>
      <button class="btn-green" onclick="openModal('addCustomerModal')">+ Add Customer</button>
    </div>
    <div class="flex gap-2 mb-4" id="custFilterBar">
      <button class="filter-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" data-filter="active" onclick="setCustFilter(this,'active')">Active</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="all" onclick="setCustFilter(this,'all')">All</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="inactive" onclick="setCustFilter(this,'inactive')">Inactive</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="invited" onclick="setCustFilter(this,'invited')">Invited</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="not_invited" onclick="setCustFilter(this,'not_invited')">Not Invited</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="customerTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Customer</h2>
        <form id="addCustomerForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <input name="contact_name"  placeholder="Full Name *" required class="field col-span-2" />
            <input name="contact_email" type="email" placeholder="Email *" required class="field" />
            <input name="contact_phone" type="tel" placeholder="Phone" class="field" />
          </div>
          <input name="address" placeholder="Service Address" class="field" />
          <input name="billing_address" placeholder="Billing Address (leave blank if same as service)" class="field" />
          <label class="flex items-center gap-3 py-1 cursor-pointer select-none">
            <input type="checkbox" name="is_subscription" id="addSubCheck"
                   onchange="document.getElementById('addFeeWrap').classList.toggle('hidden',!this.checked)"
                   class="w-4 h-4 rounded accent-[var(--green)]" />
            <span class="text-sm font-medium text-gray-700">Monthly Subscription</span>
          </label>
          <div id="addFeeWrap" class="hidden">
            <input name="monthly_service_fee" type="number" step="0.01" min="0"
                   placeholder="Monthly Service Fee ($)" class="field" />
          </div>
          <textarea name="pond_notes" rows="2" placeholder="Pond notes (size, fish count...)" class="field"></textarea>
          <textarea name="equipment_notes" rows="2" placeholder="Equipment (pump model, filter type, UV, aerator...)" class="field"></textarea>
          <p class="text-xs text-gray-400">No account invite will be sent yet. You control when that happens.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Customer</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addCustomerModal')">Cancel</button>
          </div>
          <p id="addCustErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadCustomerTable('active');
  loadAdminMaps().then(() => {
    attachAddressAC(document.querySelector('#addCustomerForm [name=address]'));
    attachAddressAC(document.querySelector('#addCustomerForm [name=billing_address]'));
  });

  document.getElementById('addCustomerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addCustErr');
    errEl.classList.add('hidden');
    const isSub = document.getElementById('addSubCheck').checked;
    const { error } = await sb.from('service_accounts').insert({
      contact_name:        fd.get('contact_name'),
      contact_email:       fd.get('contact_email'),
      contact_phone:       fd.get('contact_phone'),
      address:             fd.get('address'),
      billing_address:     fd.get('billing_address') || null,
      is_subscription:     isSub,
      monthly_service_fee: isSub ? (parseFloat(fd.get('monthly_service_fee')) || 0) : 0,
      pond_notes:          fd.get('pond_notes') || null,
      equipment_notes:     fd.get('equipment_notes') || null,
    });
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addCustomerModal');
    e.target.reset();
    document.getElementById('addFeeWrap').classList.add('hidden');
    toast('Customer added');
    loadCustomerTable();
  });
}

let _custFilter = 'active';
function setCustFilter(btn, filter) {
  _custFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadCustomerTable(filter);
}

async function loadCustomerTable(filter = _custFilter) {
  let query = sb.from('service_accounts')
    .select('id, active, contact_name, contact_email, contact_phone, address, is_subscription, monthly_service_fee, invite_sent_at, customer_id, profiles(full_name)')
    .order('created_at', { ascending: false });

  if (filter === 'active')      query = query.eq('active', true).not('customer_id', 'is', null);
  if (filter === 'inactive')    query = query.eq('active', false);
  if (filter === 'invited')     query = query.eq('active', true).not('invite_sent_at', 'is', null).is('customer_id', null);
  if (filter === 'not_invited') query = query.is('invite_sent_at', null);

  const { data, error } = await query;

  const el = document.getElementById('customerTableWrap');
  if (!el) return;
  if (error) { el.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`; return; }
  if (!data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No customers yet.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr>
      <th>Name</th><th>Email</th><th>Phone</th><th>Service Address</th><th>Plan</th><th>Status</th>
    </tr></thead>
    <tbody>
      ${data.map(c => {
        const name  = c.profiles?.full_name || c.contact_name  || 'â€”';
        const email = c.contact_email || 'â€”';
        const phone = c.contact_phone || 'â€”';
        let badge, statusLabel;
        if (!c.active)             { badge = 'badge-gray';   statusLabel = 'Inactive'; }
        else if (c.customer_id)    { badge = 'badge-green';  statusLabel = 'Active'; }
        else if (c.invite_sent_at) { badge = 'badge-yellow'; statusLabel = 'Invited'; }
        else                       { badge = 'badge-gray';   statusLabel = 'Not Invited'; }
        const plan = c.is_subscription
          ? `<span class="badge badge-green">${fmtMoney(c.monthly_service_fee)}/mo</span>`
          : '<span class="text-gray-400 text-xs">One-off</span>';
        return `<tr class="cursor-pointer" onclick="openCustomerDetail('${c.id}')">
          <td class="font-semibold">${name}</td>
          <td class="text-gray-500">${email}</td>
          <td class="text-gray-500">${phone}</td>
          <td class="text-gray-500">${c.address || 'â€”'}</td>
          <td>${plan}</td>
          <td><span class="badge ${badge}">${statusLabel}</span></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function sendCustomerInvite(saId, email, name, phone) {
  const label = document.getElementById('inviteBtnLabel')?.textContent || 'Send Invite';
  if (!confirm(`${label} to ${email}?`)) return;
  try {
    await callInvite(email, name, phone, 'customer', saId);
    toast('Invite sent to ' + email);
    openCustomerDetail(saId);
  } catch(err) {
    toast(err.message, false);
  }
}

// â”€â”€â”€ CUSTOMER DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _currentAccountId = null;

async function openCustomerDetail(accountId) {
  _currentAccountId = accountId;
  const el = document.getElementById('pageContent');
  el.innerHTML = '<p class="text-gray-400">Loading...</p>';

  const { data: c, error } = await sb.from('service_accounts')
    .select('id, active, contact_name, contact_email, contact_phone, address, billing_address, is_subscription, monthly_service_fee, pond_notes, equipment_notes, invite_sent_at, customer_id, created_at, stripe_customer_id, is_build_customer, profiles(full_name, email, phone)')
    .eq('id', accountId)
    .single();

  if (error || !c) { el.innerHTML = `<p class="text-red-500">Error: ${error?.message}</p>`; return; }

  const { data: visits } = await sb.from('jobs')
    .select('id, scheduled_date, status, notes, technicians(profiles(full_name))')
    .eq('service_account_id', accountId)
    .order('scheduled_date', { ascending: false })
    .limit(10);

  const name  = c.profiles?.full_name || c.contact_name  || 'â€”';
  const email = c.profiles?.email     || c.contact_email || 'â€”';
  const phone = c.profiles?.phone     || c.contact_phone || 'â€”';
  // customer_id is set immediately on invite, so we check auth.users to know
  // whether the customer has actually clicked the link and set their password.
  let portalConfirmed = false;
  if (c.customer_id) {
    const { data: confirmed } = await sb.rpc('is_user_confirmed', { uid: c.customer_id });
    portalConfirmed = confirmed === true;
  }
  const canInvite = !portalConfirmed && c.contact_email;
  const inviteLabel = c.invite_sent_at ? 'Resend Invite' : 'Send Invite';

  let statusBadge;
  if (!c.active)             statusBadge = '<span class="badge badge-gray">Inactive</span>';
  else if (portalConfirmed)  statusBadge = '<span class="badge badge-green">Active</span>';
  else if (c.invite_sent_at) statusBadge = '<span class="badge badge-yellow">Invited</span>';
  else                       statusBadge = '<span class="badge badge-gray">Not Invited</span>';

  const toggleLabel = c.active ? 'Mark Inactive' : 'Reactivate';
  const toggleClass = c.active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700';

  el.innerHTML = `
    <!-- Back + actions -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <button onclick="loadPage('customers')" class="text-sm text-gray-500 hover:text-gray-900 font-semibold">
        â† Back to Customers
      </button>
      <div class="flex gap-2 flex-wrap">
        ${canInvite ? `<button class="btn-blue" onclick="sendCustomerInvite('${c.id}','${c.contact_email}','${(c.contact_name||'').replace(/'/g,"\\'")}','${(c.contact_phone||'')}')"><span id="inviteBtnLabel">${inviteLabel}</span></button>` : ''}
        <button class="btn-green" onclick="openEditCustomer()">Edit</button>
        <button class="px-4 py-2 ${toggleClass} text-white rounded-lg font-bold text-sm uppercase" onclick="toggleCustomerActive('${c.id}', ${c.active})">${toggleLabel}</button>
        <button class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm uppercase hover:bg-red-700" onclick="deleteCustomer('${c.id}','${c.customer_id||''}')">Delete</button>
      </div>
    </div>

    <!-- Header card -->
    <div class="bg-white rounded-xl border p-6 mb-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-3xl font-extrabold">${escHtml(name)}</h1>
          <p class="text-gray-500 mt-1">${escHtml(email)}</p>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          ${c.is_subscription ? '<span class="badge badge-green">Subscription</span>' : '<span class="badge badge-gray">One-off</span>'}
          ${statusBadge}
        </div>
      </div>
    </div>

    <!-- Info grid -->
    <div class="grid md:grid-cols-2 gap-5 mb-5">
      <div class="bg-white rounded-xl border p-5">
        <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Contact</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-gray-500">Phone</span><span class="font-medium">${escHtml(phone)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Email</span><span class="font-medium">${escHtml(email)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Customer since</span><span class="font-medium">${fmtDate(c.created_at)}</span></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border p-5">
        <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Service &amp; Billing</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between gap-2"><span class="text-gray-500 shrink-0">Service Address</span><span class="font-medium text-right">${escHtml(c.address || 'â€”')}</span></div>
          <div class="flex justify-between gap-2"><span class="text-gray-500 shrink-0">Billing Address</span><span class="font-medium text-right">${c.billing_address ? escHtml(c.billing_address) : '<span class="text-gray-400">Same as service</span>'}</span></div>
          ${c.is_subscription ? `<div class="flex justify-between pt-1 border-t"><span class="text-gray-500">Monthly Fee</span><span class="font-bold text-lg text-[var(--green)]">${fmtMoney(c.monthly_service_fee)}/mo</span></div>` : ''}
          <div class="flex justify-between items-center pt-1 border-t gap-2">
            <span class="text-gray-500 shrink-0">Stripe</span>
            ${c.stripe_customer_id
              ? `<span class="text-xs text-gray-400 truncate max-w-[160px]">${escHtml(c.stripe_customer_id)}</span>`
              : `<button onclick="adminCreateStripeCustomer('${c.id}')" class="btn-green text-xs px-3 py-1.5">Set Up Billing</button>`
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Pond notes -->
    ${c.pond_notes ? `
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Pond Notes</h3>
      <p class="text-sm text-gray-700 whitespace-pre-wrap">${escHtml(c.pond_notes)}</p>
    </div>` : ''}

    <!-- Equipment -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Equipment</h3>
      ${c.equipment_notes
        ? `<p class="text-sm text-gray-700 whitespace-pre-wrap">${escHtml(c.equipment_notes)}</p>`
        : '<p class="text-gray-400 text-sm">No equipment recorded. Click Edit to add.</p>'}
    </div>

    <!-- Pond Photos -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xs font-bold uppercase text-gray-400">Pond Photos</h3>
        <label class="btn-outline text-xs cursor-pointer" id="uploadPhotoBtn">
          + Upload Photos
          <input type="file" class="hidden" multiple accept="image/*"
                 onchange="uploadPondPhotos(this)">
        </label>
      </div>
      <div id="pondPhotosGrid" class="grid grid-cols-3 gap-3">
        <p class="text-gray-400 text-sm col-span-3">Loading photos...</p>
      </div>
    </div>

    <!-- Visit history -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-4">Service History</h3>
      ${!visits?.length ? '<p class="text-gray-400 text-sm">No visits yet.</p>' : `
      <table>
        <thead><tr><th>Date</th><th>Tech</th><th>Notes</th><th>Status</th></tr></thead>
        <tbody>
          ${visits.map(v => `<tr>
            <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
            <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
            <td class="text-gray-400 text-xs max-w-xs truncate">${escHtml(v.notes || '')}</td>
            <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
          </tr>`).join('')}
        </tbody>
      </table>`}
    </div>

    <!-- Edit Modal -->
    <div id="editCustomerModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Edit Customer</h2>
        <form id="editCustomerForm" class="space-y-3">
          <input name="contact_name" class="field" placeholder="Full Name" value="${escHtml(c.contact_name || '')}" />
          <div class="grid grid-cols-2 gap-3">
            <input name="contact_email" type="email" class="field" placeholder="Email" value="${escHtml(c.contact_email || '')}" />
            <input name="contact_phone" type="tel"   class="field" placeholder="Phone" value="${escHtml(c.contact_phone || '')}" />
          </div>
          <input name="address" class="field" placeholder="Service Address" value="${escHtml(c.address || '')}" />
          <input name="billing_address" class="field" placeholder="Billing Address (leave blank if same as service)" value="${escHtml(c.billing_address || '')}" />
          <label class="flex items-center gap-3 py-1 cursor-pointer select-none">
            <input type="checkbox" name="is_subscription" id="editSubCheck"
                   ${c.is_subscription ? 'checked' : ''}
                   onchange="document.getElementById('editFeeWrap').classList.toggle('hidden',!this.checked)"
                   class="w-4 h-4 rounded accent-[var(--green)]" />
            <span class="text-sm font-medium text-gray-700">Monthly Subscription</span>
          </label>
          <div id="editFeeWrap" class="${c.is_subscription ? '' : 'hidden'}">
            <input name="monthly_service_fee" type="number" step="0.01" min="0"
                   class="field" placeholder="Monthly Fee ($)" value="${c.monthly_service_fee || ''}" />
          </div>
          <textarea name="pond_notes" rows="2" class="field" placeholder="Pond notes...">${escHtml(c.pond_notes || '')}</textarea>
          <textarea name="equipment_notes" rows="2" class="field" placeholder="Equipment (pump model, filter type, UV, aerator...)">${escHtml(c.equipment_notes || '')}</textarea>
          <label class="flex items-center gap-3 py-1 cursor-pointer select-none">
            <input type="checkbox" id="editBuildCheck" name="is_build_customer"
                   ${c.is_build_customer ? 'checked' : ''}
                   class="w-4 h-4 rounded accent-[var(--green)]" />
            <span class="text-sm font-medium text-gray-700">Build Customer Portal</span>
          </label>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Changes</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('editCustomerModal')">Cancel</button>
          </div>
          <p id="editCustErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadPondPhotos(accountId);
  loadAdminMaps().then(() => {
    attachAddressAC(document.querySelector('#editCustomerForm [name=address]'));
    attachAddressAC(document.querySelector('#editCustomerForm [name=billing_address]'));
  });

  document.getElementById('editCustomerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('editCustErr');
    errEl.classList.add('hidden');
    const isSub = document.getElementById('editSubCheck').checked;
    const { error } = await sb.from('service_accounts').update({
      contact_name:        fd.get('contact_name'),
      contact_email:       fd.get('contact_email'),
      contact_phone:       fd.get('contact_phone'),
      address:             fd.get('address'),
      billing_address:     fd.get('billing_address') || null,
      is_subscription:     isSub,
      monthly_service_fee: isSub ? (parseFloat(fd.get('monthly_service_fee')) || 0) : 0,
      pond_notes:          fd.get('pond_notes') || null,
      equipment_notes:     fd.get('equipment_notes') || null,
      is_build_customer:   document.getElementById('editBuildCheck').checked,
    }).eq('id', accountId);
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('editCustomerModal');
    toast('Customer updated');
    openCustomerDetail(accountId);
  });
}

function openEditCustomer() { openModal('editCustomerModal'); }

// â”€â”€â”€ POND PHOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPondPhotos(accountId) {
  const gridEl = document.getElementById('pondPhotosGrid');
  if (!gridEl) return;

  const { data: files, error } = await sb.storage
    .from('pond-photos')
    .list(accountId, { sortBy: { column: 'created_at', order: 'desc' } });

  if (error) { gridEl.innerHTML = `<p class="text-red-500 text-sm col-span-3">${error.message}</p>`; return; }
  if (!files?.length) { gridEl.innerHTML = '<p class="text-gray-400 text-sm col-span-3">No photos yet.</p>'; return; }

  const urlResults = await Promise.all(
    files.map(f => sb.storage.from('pond-photos').createSignedUrl(`${accountId}/${f.name}`, 3600))
  );

  gridEl.innerHTML = files.map((f, i) => {
    const url = urlResults[i]?.data?.signedUrl || '';
    const path = `${accountId}/${f.name}`;
    return `
      <div class="relative group rounded-xl overflow-hidden bg-gray-100" style="aspect-ratio:1">
        <img src="${url}" class="w-full h-full object-cover" loading="lazy" />
        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 p-2">
          <a href="${url}" target="_blank"
             class="text-white text-xs font-bold px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition">
            View Full
          </a>
          <button onclick="deletePondPhoto('${path}')"
                  class="text-white text-xs font-bold px-3 py-1.5 bg-red-500/80 rounded-lg hover:bg-red-600/80 transition">
            Delete
          </button>
        </div>
      </div>`;
  }).join('');
}

async function uploadPondPhotos(input) {
  const files = Array.from(input.files);
  if (!files.length || !_currentAccountId) return;
  const labelEl = document.getElementById('uploadPhotoBtn');
  if (labelEl) labelEl.textContent = `Uploading ${files.length} photo${files.length>1?'s':''}...`;

  await Promise.all(files.map(f => {
    const ext = f.name.split('.').pop().toLowerCase();
    const path = `${_currentAccountId}/${crypto.randomUUID()}.${ext}`;
    return sb.storage.from('pond-photos').upload(path, f);
  }));

  input.value = '';
  if (labelEl) labelEl.innerHTML = '+ Upload Photos<input type="file" class="hidden" multiple accept="image/*" onchange="uploadPondPhotos(this)">';
  toast(`${files.length} photo${files.length>1?'s':''} uploaded`);
  loadPondPhotos(_currentAccountId);
}

async function deletePondPhoto(path) {
  if (!confirm('Delete this photo?')) return;
  const { error } = await sb.storage.from('pond-photos').remove([path]);
  if (error) { toast(error.message, false); return; }
  loadPondPhotos(_currentAccountId);
}

async function deleteCustomer(accountId, userId) {
  if (!confirm('Permanently delete this customer and all their data? This cannot be undone.')) return;
  const { data: { session } } = await sb.auth.getSession();
  try {
    const res = await fetch('/.netlify/functions/delete-customer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
      body: JSON.stringify({ service_account_id: accountId, user_id: userId || null })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error);
    toast('Customer deleted');
    loadPage('customers');
  } catch(err) {
    toast(err.message, false);
  }
}

async function toggleCustomerActive(accountId, currentActive) {
  const newState = !currentActive;
  const { error } = await sb.from('service_accounts').update({ active: newState }).eq('id', accountId);
  if (error) { toast(error.message, false); return; }
  toast(newState ? 'Customer reactivated' : 'Customer marked inactive');
  openCustomerDetail(accountId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECHNICIANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTechs(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Technicians</h1>
      <button class="btn-green" onclick="openModal('addTechModal')">+ Add Technician</button>
    </div>
    <div class="flex gap-2 mb-4">
      <button class="tech-filter-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" onclick="setTechFilter(this,'active')">Active</button>
      <button class="tech-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setTechFilter(this,'all')">All</button>
      <button class="tech-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setTechFilter(this,'inactive')">Inactive</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="techTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Tech Modal -->
    <div id="addTechModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Technician</h2>
        <form id="addTechForm" class="space-y-3">
          <input name="full_name" placeholder="Full Name *" required class="field" />
          <input name="email" type="email" placeholder="Email *" required class="field" />
          <input name="phone" type="tel" placeholder="Phone" class="field" />
          <p class="text-xs text-gray-400">An account invite will be sent immediately to their email.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Add & Send Invite</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addTechModal')">Cancel</button>
          </div>
          <p id="addTechErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadTechTable('active');

  document.getElementById('addTechForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addTechErr');
    errEl.classList.add('hidden');

    const btn = e.target.querySelector('button[type=submit]');
    btn.textContent = 'Sending...'; btn.disabled = true;

    try {
      await callInvite(fd.get('email'), fd.get('full_name'), fd.get('phone'), 'tech', null);
      closeModal('addTechModal');
      e.target.reset();
      toast('Technician added and invite sent');
      loadTechTable(_techFilter);
    } catch(err) {
      errEl.textContent = err.message; errEl.classList.remove('hidden');
    } finally {
      btn.textContent = 'Add & Send Invite'; btn.disabled = false;
    }
  });
}

let _techFilter = 'active';
function setTechFilter(btn, filter) {
  _techFilter = filter;
  document.querySelectorAll('.tech-filter-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadTechTable(filter);
}

async function loadTechTable(filter = _techFilter) {
  let query = sb.from('technicians')
    .select('id, active, created_at, profiles(full_name, email, phone)')
    .order('created_at', { ascending: false });

  if (filter === 'active')   query = query.eq('active', true);
  if (filter === 'inactive') query = query.eq('active', false);

  const { data, error } = await query;

  const el = document.getElementById('techTableWrap');
  if (!el) return;
  if (error || !data?.length) {
    el.innerHTML = '<p class="text-gray-400 p-2">No technicians yet.</p>'; return;
  }
  el.innerHTML = `<table>
    <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Added</th></tr></thead>
    <tbody>
      ${data.map(t => `<tr class="cursor-pointer" onclick="openTechDetail('${t.id}')">
        <td class="font-semibold">${t.profiles?.full_name || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.email || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.phone || 'â€”'}</td>
        <td><span class="badge ${t.active !== false ? 'badge-green' : 'badge-gray'}">${t.active !== false ? 'Active' : 'Inactive'}</span></td>
        <td class="text-gray-400">${fmtDate(t.created_at)}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

// â”€â”€â”€ TECH DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openTechDetail(techId) {
  const el = document.getElementById('pageContent');
  el.innerHTML = '<p class="text-gray-400">Loading...</p>';

  const { data: t, error } = await sb.from('technicians')
    .select('id, active, created_at, user_id, profiles(full_name, email, phone)')
    .eq('id', techId)
    .single();

  if (error || !t) { el.innerHTML = `<p class="text-red-500">Error: ${error?.message}</p>`; return; }

  const { data: visits } = await sb.from('jobs')
    .select('id, scheduled_date, status, service_accounts(contact_name)')
    .eq('tech_id', techId)
    .order('scheduled_date', { ascending: false })
    .limit(10);

  const name  = t.profiles?.full_name || 'â€”';
  const email = t.profiles?.email     || 'â€”';
  const phone = t.profiles?.phone     || 'â€”';
  const isActive = t.active !== false;
  const toggleLabel = isActive ? 'Mark Inactive' : 'Reactivate';
  const toggleClass = isActive ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700';

  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <button onclick="loadPage('techs')" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-900 font-semibold">
        â† Back to Technicians
      </button>
      <div class="flex gap-2">
        <button class="btn-green" onclick="openModal('editTechModal')">Edit</button>
        <button class="px-4 py-2 ${toggleClass} text-white rounded-lg font-bold text-sm uppercase" onclick="toggleTechActive('${t.id}', ${isActive})">${toggleLabel}</button>
        <button class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm uppercase hover:bg-red-700" onclick="deleteTech('${t.id}','${t.user_id||''}')">Delete</button>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-6 mb-5">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl font-extrabold">${name}</h1>
          <p class="text-gray-500 mt-1">${email}</p>
        </div>
        <span class="badge ${isActive ? 'badge-green' : 'badge-gray'}">${isActive ? 'Active' : 'Inactive'}</span>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Contact</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-gray-500">Phone</span><span class="font-medium">${phone}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Email</span><span class="font-medium">${email}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Added</span><span class="font-medium">${fmtDate(t.created_at)}</span></div>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-4">Job History</h3>
      ${!visits?.length ? '<p class="text-gray-400 text-sm">No jobs yet.</p>' : `
      <table>
        <thead><tr><th>Date</th><th>Customer</th><th>Status</th></tr></thead>
        <tbody>
          ${visits.map(v => {
            const cust = v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”';
            return `<tr>
              <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
              <td>${cust}</td>
              <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>`}
    </div>

    <!-- Edit Modal -->
    <div id="editTechModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Edit Technician</h2>
        <form id="editTechForm" class="space-y-3">
          <input name="full_name" class="field" placeholder="Full Name" value="${name !== 'â€”' ? name : ''}" />
          <input name="phone" type="tel" class="field" placeholder="Phone" value="${phone !== 'â€”' ? phone : ''}" />
          <p class="text-xs text-gray-400">Email cannot be changed here â€” contact Supabase to update auth email.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Changes</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('editTechModal')">Cancel</button>
          </div>
          <p id="editTechErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  document.getElementById('editTechForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('editTechErr');
    errEl.classList.add('hidden');
    const { error } = await sb.from('profiles').update({
      full_name: fd.get('full_name'),
      phone:     fd.get('phone'),
    }).eq('id', t.user_id);
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('editTechModal');
    toast('Technician updated');
    openTechDetail(techId);
  });
}

async function toggleTechActive(techId, currentActive) {
  const { error } = await sb.from('technicians').update({ active: !currentActive }).eq('id', techId);
  if (error) { toast(error.message, false); return; }
  toast(!currentActive ? 'Technician reactivated' : 'Technician marked inactive');
  openTechDetail(techId);
}

async function deleteTech(techId, userId) {
  if (!confirm('Permanently delete this technician? Their past job history will be preserved but future visits will be unassigned.')) return;
  const { data: { session } } = await sb.auth.getSession();
  try {
    const res = await fetch('/.netlify/functions/delete-tech', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
      body: JSON.stringify({ tech_id: techId, user_id: userId || null })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error);
    toast('Technician deleted');
    loadPage('techs');
  } catch(err) {
    toast(err.message, false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOBS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _jobsWeekStart = null;
let _jobsView = 'calendar';
let _jobsTechFilter = 'all';
let _jobTypes = [];
let _jobsTechs = [];
let _jobsAccounts = [];

function startOfWeek(d) {
  const date = new Date(d); const day = date.getDay();
  date.setDate(date.getDate() - day); date.setHours(0,0,0,0); return date;
}
function addDays(d, n) { const date = new Date(d); date.setDate(date.getDate() + n); return date; }
function isoDate(d) { return d.toISOString().split('T')[0]; }
function fmtWeekRange(s) {
  const e = addDays(s, 6);
  return s.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' \u2013 ' +
         e.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}
function fmtJobTime(t) {
  if (!t) return ''; const [h,m] = t.split(':'); const hr = parseInt(h);
  return `${hr%12||12}:${m} ${hr>=12?'PM':'AM'}`;
}
function techDisplayName(t) { return t?.profiles?.full_name || 'Unknown'; }

async function renderJobs(el) {
  if (!_jobsWeekStart) _jobsWeekStart = startOfWeek(new Date());
  if (!_jobTypes.length) {
    const [jtR, tR, aR] = await Promise.all([
      sb.from('job_types').select('id,name,color').eq('active',true).order('name'),
      sb.from('technicians').select('id,profiles(full_name)').eq('active',true).order('created_at'),
      sb.from('service_accounts').select('id,contact_name,address,phone,sms_opted_in').order('contact_name'),
    ]);
    _jobTypes = jtR.data||[]; _jobsTechs = tR.data||[]; _jobsAccounts = aR.data||[];
  }
  const techOpts = `<option value="all">All Techs</option>` +
    _jobsTechs.map(t => `<option value="${t.id}">${escHtml(techDisplayName(t))}</option>`).join('');
  el.innerHTML = `
    <div class="flex flex-wrap items-center justify-between gap-3 mb-5">
      <h1 class="text-3xl font-extrabold">Jobs</h1>
      <div class="flex items-center gap-2 flex-wrap">
        <select id="jobTechFilterSel" onchange="_jobsTechFilter=this.value;loadJobsView()"
                class="field text-sm py-1.5" style="width:auto">${techOpts}</select>
        <button onclick="_jobsWeekStart=startOfWeek(new Date());loadJobsView()"
                class="btn-outline text-sm py-1.5 px-3">Today</button>
        <button id="jobViewToggle" onclick="_jobsView=_jobsView==='calendar'?'list':'calendar';loadJobsView()"
                class="btn-outline text-sm py-1.5 px-3">ğŸ“‹ List</button>
        <button onclick="openCreateJob(null)" class="btn-green text-sm py-1.5">+ New Job</button>
      </div>
    </div>
    <div class="flex items-center gap-3 mb-5">
      <button onclick="_jobsWeekStart=addDays(_jobsWeekStart,-7);loadJobsView()" class="btn-outline py-1 px-3 text-xl">&#8249;</button>
      <span id="jobWeekLabel" class="font-semibold text-sm min-w-max"></span>
      <button onclick="_jobsWeekStart=addDays(_jobsWeekStart,7);loadJobsView()"  class="btn-outline py-1 px-3 text-xl">&#8250;</button>
    </div>
    <div id="jobsViewContent"></div>

    <!-- Job Modal -->
    <div id="jobModal" class="modal-bg hidden">
      <div class="modal max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold" id="jobModalTitle">Create Job</h2>
          <button onclick="closeModal('jobModal')" class="text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>
        <input type="hidden" id="jobId" /><input type="hidden" id="jobProposalId" />
        <div class="space-y-3">
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Customer</label>
            <select id="jobAccountId" class="field mt-1"></select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Address</label>
            <input id="jobAddress" type="text" class="field mt-1" placeholder="Auto-filled from customer" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Job Type</label><select id="jobTypeId" class="field mt-1"></select></div>
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Technician</label><select id="jobTechId" class="field mt-1"></select></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Date</label><input id="jobDate" type="date" class="field mt-1" /></div>
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Time (optional)</label><input id="jobTime" type="time" class="field mt-1" /></div>
          </div>
          <div><label class="text-xs font-semibold text-gray-500 uppercase">Notes</label><textarea id="jobNotes" rows="2" class="field mt-1" placeholder="Optional"></textarea></div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="jobRecurring" class="w-4 h-4 accent-[var(--green)]"
                   onchange="document.getElementById('jobRecurrenceWrap').classList.toggle('hidden',!this.checked)" />
            <span class="text-sm font-semibold">Recurring Job</span>
          </label>
          <div id="jobRecurrenceWrap" class="hidden">
            <select id="jobPattern" class="field text-sm">
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly (every 2 weeks)</option>
              <option value="monthly">Monthly</option>
            </select>
            <p class="text-xs text-gray-400 mt-1">Creates 1 year of instances. A new one auto-generates each time one completes.</p>
          </div>
          <div id="jobRecurringInfo"></div>
        </div>
        <div class="mt-5 flex gap-2">
          <button onclick="saveJob()" class="btn-green flex-1">Save Job</button>
          <button id="jobCancelBtn" onclick="cancelJobFromModal()"
                  class="btn-outline flex-1 hidden text-red-600 border-red-200 hover:border-red-400">Cancel Job</button>
          <button onclick="closeModal('jobModal')" class="btn-outline">Close</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('jobTechFilterSel').value = _jobsTechFilter;
  await loadJobsView();
}

async function loadJobsView() {
  const el = document.getElementById('jobsViewContent');
  if (!el) return;
  el.innerHTML = '<p class="text-gray-400 text-sm py-4">Loading...</p>';
  document.getElementById('jobWeekLabel').textContent = fmtWeekRange(_jobsWeekStart);
  document.getElementById('jobViewToggle').textContent = _jobsView === 'calendar' ? 'ğŸ“‹ List' : 'ğŸ“… Calendar';
  const weekEnd = addDays(_jobsWeekStart, 7);
  let query = sb.from('jobs')
    .select('id,status,scheduled_date,scheduled_time,is_recurring,recurring_parent_id,service_accounts(id,contact_name),technicians(id,profiles(full_name)),job_types(id,name,color)')
    .gte('scheduled_date', isoDate(_jobsWeekStart))
    .lt('scheduled_date', isoDate(weekEnd))
    .not('status','eq','cancelled')
    .order('scheduled_time',{ascending:true,nullsFirst:false});
  if (_jobsTechFilter !== 'all') query = query.eq('tech_id', _jobsTechFilter);
  const { data: jobs } = await query;
  const today = isoDate(new Date());
  const weekDays = Array.from({length:7},(_,i) => addDays(_jobsWeekStart,i));
  if (_jobsView === 'calendar') renderJobCalendar(el, jobs||[], weekDays, today);
  else renderJobList(el, jobs||[]);
}

function renderJobCalendar(el, jobs, weekDays, today) {
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const byDate = {};
  jobs.forEach(j => { if (!byDate[j.scheduled_date]) byDate[j.scheduled_date]=[]; byDate[j.scheduled_date].push(j); });
  el.innerHTML = `
    <div class="bg-white rounded-xl border overflow-hidden">
      <div class="grid grid-cols-7 border-b">
        ${weekDays.map(d => {
          const ds = isoDate(d); const isT = ds===today;
          return `<div class="p-2 text-center border-r last:border-r-0 ${isT?'bg-green-50':''}">
            <p class="text-xs text-gray-400 font-semibold">${dayNames[d.getDay()]}</p>
            <p class="text-sm font-bold mt-0.5 w-7 h-7 flex items-center justify-center mx-auto rounded-full ${isT?'bg-[var(--green)] text-white':''}">${d.getDate()}</p>
          </div>`;
        }).join('')}
      </div>
      <div class="grid grid-cols-7 divide-x min-h-96">
        ${weekDays.map(d => {
          const ds = isoDate(d); const dayJobs = byDate[ds]||[];
          return `<div class="p-1 hover:bg-gray-50 cursor-pointer" onclick="openCreateJob('${ds}')">
            ${dayJobs.map(j => {
              const color = j.job_types?.color||'#1E5E37';
              const dot = {on_the_way:'&#128663; ',in_progress:'&#128295; ',completed:'&#10003; '}[j.status]||'';
              return `<div onclick="event.stopPropagation();openJobDetail('${j.id}')"
                          class="rounded p-1.5 mb-1 text-xs cursor-pointer hover:opacity-75"
                          style="border-left:3px solid ${color};background:${color}18">
                <div class="font-bold truncate">${dot}${escHtml(j.service_accounts?.contact_name||'â€”')}</div>
                <div class="text-gray-500 truncate" style="font-size:10px">${escHtml(j.job_types?.name||'')}</div>
                <div class="text-gray-400" style="font-size:10px">${escHtml(techDisplayName(j.technicians))}${j.scheduled_time?' &middot; '+fmtJobTime(j.scheduled_time):''}</div>
              </div>`;
            }).join('')}
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

function renderJobList(el, jobs) {
  if (!jobs.length) { el.innerHTML = '<div class="bg-white rounded-xl border p-8 text-center text-gray-400 text-sm">No jobs this week.</div>'; return; }
  const sb2 = s => {
    const m = {scheduled:'badge-blue',on_the_way:'badge-yellow',in_progress:'badge-green',completed:'badge-gray',cancelled:'badge-red'};
    return `<span class="badge ${m[s]||'badge-gray'}">${s.replace('_',' ')}</span>`;
  };
  el.innerHTML = `
    <div class="bg-white rounded-xl border overflow-hidden">
      <table>
        <thead><tr><th>Date</th><th>Time</th><th>Customer</th><th>Type</th><th>Tech</th><th>Status</th><th></th></tr></thead>
        <tbody>
          ${jobs.map(j => `
            <tr class="cursor-pointer" onclick="openJobDetail('${j.id}')">
              <td>${fmtDate(j.scheduled_date)}</td>
              <td class="text-gray-500">${j.scheduled_time?fmtJobTime(j.scheduled_time):'â€”'}</td>
              <td class="font-semibold">${escHtml(j.service_accounts?.contact_name||'â€”')}</td>
              <td>${j.job_types?`<span class="text-xs font-semibold px-2 py-0.5 rounded" style="background:${j.job_types.color}20;color:${j.job_types.color}">${escHtml(j.job_types.name)}</span>`:'â€”'}</td>
              <td class="text-gray-500">${escHtml(techDisplayName(j.technicians))}</td>
              <td>${sb2(j.status)}</td>
              <td class="text-right"><button class="text-xs text-[var(--green)] font-semibold hover:underline">View</button></td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

function _populateJobModal() {
  document.getElementById('jobAccountId').innerHTML = `<option value="">Select Customer</option>` +
    _jobsAccounts.map(a => `<option value="${a.id}" data-address="${escHtml(a.address||'')}">${escHtml(a.contact_name||'â€”')}</option>`).join('');
  document.getElementById('jobTypeId').innerHTML = `<option value="">Select Job Type</option>` +
    _jobTypes.map(t => `<option value="${t.id}">${escHtml(t.name)}</option>`).join('');
  document.getElementById('jobTechId').innerHTML = `<option value="">Unassigned</option>` +
    _jobsTechs.map(t => `<option value="${t.id}">${escHtml(techDisplayName(t))}</option>`).join('');
}

function openCreateJob(prefillDate) {
  document.getElementById('jobModalTitle').textContent = 'Create Job';
  document.getElementById('jobId').value = ''; document.getElementById('jobProposalId').value = '';
  _populateJobModal();
  document.getElementById('jobAddress').value = '';
  document.getElementById('jobDate').value = prefillDate||''; document.getElementById('jobTime').value = '';
  document.getElementById('jobNotes').value = '';
  document.getElementById('jobRecurring').checked = false;
  document.getElementById('jobRecurrenceWrap').classList.add('hidden');
  document.getElementById('jobPattern').value = 'weekly';
  document.getElementById('jobRecurringInfo').innerHTML = '';
  document.getElementById('jobCancelBtn').classList.add('hidden');
  openModal('jobModal');
  setTimeout(() => {
    _searchable('jobAccountId', v => { const a = _jobsAccounts.find(a => a.id===v); document.getElementById('jobAddress').value = a?.address||''; });
    _searchable('jobTechId');
    loadAdminMaps().then(() => attachAddressAC(document.getElementById('jobAddress')));
  }, 50);
}

async function openJobDetail(jobId) {
  const { data: job } = await sb.from('jobs')
    .select('*,service_accounts(id,contact_name,address,phone,sms_opted_in),technicians(id,profiles(full_name)),job_types(id,name,color)')
    .eq('id', jobId).single();
  if (!job) { toast('Job not found', false); return; }
  document.getElementById('jobModalTitle').textContent = 'Edit Job';
  document.getElementById('jobId').value = job.id;
  document.getElementById('jobProposalId').value = job.proposal_id||'';
  _populateJobModal();
  document.getElementById('jobAccountId').value = job.service_account_id||'';
  document.getElementById('jobAddress').value = job.address||'';
  document.getElementById('jobTypeId').value = job.job_type_id||'';
  document.getElementById('jobTechId').value = job.tech_id||'';
  document.getElementById('jobDate').value = job.scheduled_date||'';
  document.getElementById('jobTime').value = job.scheduled_time ? job.scheduled_time.slice(0,5) : '';
  document.getElementById('jobNotes').value = job.notes||'';
  document.getElementById('jobRecurring').checked = job.is_recurring;
  document.getElementById('jobRecurrenceWrap').classList.toggle('hidden', !job.is_recurring);
  document.getElementById('jobPattern').value = job.recurrence_pattern||'weekly';
  document.getElementById('jobCancelBtn').classList.remove('hidden');
  const isParent = job.is_recurring && !job.recurring_parent_id;
  const isChild  = !!job.recurring_parent_id;
  const infoEl   = document.getElementById('jobRecurringInfo');
  if (isParent) {
    const { count } = await sb.from('jobs').select('id',{count:'exact',head:true})
      .eq('recurring_parent_id', job.id).not('status','in','("completed","cancelled")');
    infoEl.innerHTML = `
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-800">
        <div class="flex items-start justify-between gap-2 flex-wrap">
          <span><strong>Recurring Series</strong> &mdash; ${count||0} future instances scheduled. Saving cascades changes to all future jobs.</span>
          <div class="flex gap-2 flex-wrap shrink-0">
            <button onclick="cancelAllFuture('${job.id}')"
                    class="px-2 py-1 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded font-semibold whitespace-nowrap">
              Cancel All Future
            </button>
            <button onclick="deleteEntireSeries('${job.id}')"
                    class="px-2 py-1 bg-red-100 text-red-700 border border-red-300 rounded font-semibold whitespace-nowrap">
              Delete Series
            </button>
          </div>
        </div>
      </div>`;
  } else if (isChild) {
    infoEl.innerHTML = `
      <div class="bg-gray-50 border rounded-lg p-3 text-xs text-gray-600">
        <div class="flex items-start justify-between gap-2 flex-wrap">
          <span><strong>Part of a recurring series.</strong></span>
          <div class="flex gap-2 flex-wrap shrink-0">
            <button onclick="closeModal('jobModal');openJobDetail('${job.recurring_parent_id}')"
                    class="text-[var(--green)] underline font-semibold">Edit parent</button>
            <button onclick="cancelJobAndFuture('${job.id}','${job.recurring_parent_id}','${job.scheduled_date}')"
                    class="px-2 py-1 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded font-semibold whitespace-nowrap">
              Cancel This &amp; Future
            </button>
          </div>
        </div>
      </div>`;
  } else { infoEl.innerHTML = ''; }
  openModal('jobModal');
  setTimeout(() => {
    _searchable('jobAccountId', v => { const a = _jobsAccounts.find(a => a.id===v); document.getElementById('jobAddress').value = a?.address||''; });
    _searchable('jobTechId');
    loadAdminMaps().then(() => attachAddressAC(document.getElementById('jobAddress')));
  }, 50);
}

function generateRecurringDates(startDate, pattern, count) {
  const dates = [];
  for (let i = 1; i <= count; i++) {
    const d = new Date(startDate + 'T12:00:00');
    if      (pattern==='weekly')   d.setDate(d.getDate() + i*7);
    else if (pattern==='biweekly') d.setDate(d.getDate() + i*14);
    else if (pattern==='monthly')  d.setMonth(d.getMonth() + i);
    dates.push(d.toISOString().split('T')[0]);
  }
  return dates;
}

async function saveJob() {
  const jobId      = document.getElementById('jobId').value;
  const proposalId = document.getElementById('jobProposalId').value||null;
  const accountId  = document.getElementById('jobAccountId').value;
  const address    = document.getElementById('jobAddress').value.trim();
  const jobTypeId  = document.getElementById('jobTypeId').value||null;
  const techId     = document.getElementById('jobTechId').value||null;
  const date       = document.getElementById('jobDate').value;
  const time       = document.getElementById('jobTime').value||null;
  const notes      = document.getElementById('jobNotes').value.trim();
  const isRecurring = document.getElementById('jobRecurring').checked;
  const pattern    = document.getElementById('jobPattern').value;
  if (!accountId) { toast('Select a customer', false); return; }
  if (!date)      { toast('Select a date', false); return; }
  const payload = { service_account_id:accountId, address, job_type_id:jobTypeId, tech_id:techId,
    scheduled_date:date, scheduled_time:time, notes, is_recurring:isRecurring,
    recurrence_pattern:isRecurring?pattern:null, proposal_id:proposalId };
  if (jobId) {
    const { data: ex } = await sb.from('jobs').select('is_recurring,recurring_parent_id').eq('id',jobId).single();
    const isParent = ex?.is_recurring && !ex?.recurring_parent_id;
    await sb.from('jobs').update({...payload,updated_at:new Date().toISOString()}).eq('id',jobId);
    if (isParent) {
      const { data: futures } = await sb.from('jobs').select('id').eq('recurring_parent_id',jobId).not('status','in','("completed","cancelled")');
      const cascade = {job_type_id:jobTypeId,tech_id:techId,address,notes,scheduled_time:time};
      for (const f of (futures||[])) await sb.from('jobs').update({...cascade,updated_at:new Date().toISOString()}).eq('id',f.id);
      toast(`Job updated â€” cascaded to ${futures?.length||0} future instances`);
    } else { toast('Job updated'); }
  } else {
    const { data: newJob, error } = await sb.from('jobs').insert({...payload,status:'scheduled'}).select().single();
    if (error) { toast(error.message, false); return; }
    if (isRecurring) {
      const count = pattern==='weekly'?51:pattern==='biweekly'?25:11;
      await sb.from('jobs').insert(generateRecurringDates(date,pattern,count).map(d => ({
        service_account_id:accountId, address, job_type_id:jobTypeId, tech_id:techId,
        scheduled_date:d, scheduled_time:time, notes, status:'scheduled',
        is_recurring:true, recurrence_pattern:pattern, recurring_parent_id:newJob.id,
      })));
      toast(`Recurring job created â€” ${count+1} total instances`);
    } else { toast('Job created'); }
  }
  closeModal('jobModal'); await loadJobsView();
}

async function cancelJob(jobId) {
  if (!confirm('Cancel this job?')) return;
  await sb.from('jobs').update({status:'cancelled',updated_at:new Date().toISOString()}).eq('id',jobId);
  toast('Job cancelled'); closeModal('jobModal'); await loadJobsView();
}
function cancelJobFromModal() { const id = document.getElementById('jobId').value; if (id) cancelJob(id); }

async function cancelAllFuture(parentJobId) {
  if (!confirm('Cancel all future (non-completed) instances of this recurring series?')) return;
  await sb.from('jobs')
    .update({ status:'cancelled', updated_at:new Date().toISOString() })
    .eq('recurring_parent_id', parentJobId)
    .in('status', ['scheduled','on_the_way','in_progress']);
  toast('All future instances cancelled');
  closeModal('jobModal'); await loadJobsView();
}

async function cancelJobAndFuture(jobId, parentJobId, scheduledDate) {
  if (!confirm('Cancel this job and all future instances on or after this date?')) return;
  await sb.from('jobs')
    .update({ status:'cancelled', updated_at:new Date().toISOString() })
    .eq('id', jobId);
  await sb.from('jobs')
    .update({ status:'cancelled', updated_at:new Date().toISOString() })
    .eq('recurring_parent_id', parentJobId)
    .gte('scheduled_date', scheduledDate)
    .in('status', ['scheduled','on_the_way','in_progress']);
  toast('This job and all future instances cancelled');
  closeModal('jobModal'); await loadJobsView();
}

async function deleteEntireSeries(parentJobId) {
  if (!confirm('PERMANENTLY DELETE this entire recurring series?\n\nCompleted jobs will be kept as historical records. All scheduled and cancelled instances will be removed. This cannot be undone.')) return;
  // Gather all non-completed jobs in the series (parent + children)
  const { data: toDelete } = await sb.from('jobs').select('id')
    .or(`id.eq.${parentJobId},recurring_parent_id.eq.${parentJobId}`)
    .neq('status', 'completed');
  const ids = (toDelete||[]).map(j => j.id);
  if (!ids.length) { toast('No jobs to delete (all completed)'); closeModal('jobModal'); return; }
  // Null out basket_items references to avoid FK constraint failure
  await sb.from('basket_items').update({ job_id:null }).in('job_id', ids);
  await sb.from('jobs').delete().in('id', ids);
  toast(`Series deleted â€” ${ids.length} job${ids.length!==1?'s':''} removed`);
  closeModal('jobModal'); await loadJobsView();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPOSALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _editingProposalId = null;
let _proposalLineItems = [];
let _proposalProducts = [];

async function renderProposals(el) {
  if (!_jobsAccounts.length) {
    const { data } = await sb.from('service_accounts').select('id,contact_name,address').order('contact_name');
    _jobsAccounts = data||[];
  }
  if (!_proposalProducts.length) {
    const { data: prods } = await sb.from('products').select('id,name,price').eq('active',true).order('name');
    _proposalProducts = prods||[];
  }
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Proposals</h1>
      <button onclick="openCreateProposal()" class="btn-green">+ New Proposal</button>
    </div>
    <div id="proposalsList" class="text-gray-400 text-sm">Loading...</div>

    <!-- Proposal Create/Edit Modal -->
    <div id="proposalModal" class="modal-bg hidden">
      <div class="modal" style="max-width:42rem">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold" id="propModalTitle">New Proposal</h2>
          <button onclick="closeModal('proposalModal')" class="text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Customer</label><select id="propAccountId" class="field mt-1"></select></div>
            <div><label class="text-xs font-semibold text-gray-500 uppercase">Title</label><input id="propTitle" type="text" class="field mt-1" placeholder="e.g. Custom Pond Build" /></div>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Line Items</label>
            <div class="text-xs text-gray-400 mb-1 mt-1">Description &middot; Qty &middot; Unit Price</div>
            <div id="propLineItems"></div>
          </div>
          <div><label class="text-xs font-semibold text-gray-500 uppercase">Notes for Customer</label><textarea id="propNotes" rows="2" class="field mt-1" placeholder="Optional notes visible to customer"></textarea></div>
        </div>
        <div class="mt-5 flex gap-2">
          <button onclick="saveProposal(false)" class="btn-outline flex-1">Save Draft</button>
          <button onclick="saveProposal(true)" class="btn-green flex-1">Send to Customer</button>
          <button onclick="closeModal('proposalModal')" class="btn-outline">Close</button>
        </div>
      </div>
    </div>

    <!-- Proposal Detail Modal -->
    <div id="proposalDetailModal" class="modal-bg hidden">
      <div class="modal" style="max-width:42rem">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Proposal</h2>
          <button onclick="closeModal('proposalDetailModal')" class="text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>
        <div id="proposalDetailBody"></div>
      </div>
    </div>
  `;
  await loadProposalsList();
}

async function loadProposalsList() {
  const el = document.getElementById('proposalsList'); if (!el) return;
  const { data: proposals } = await sb.from('proposals')
    .select('id,title,status,updated_at,service_accounts(contact_name)').order('updated_at',{ascending:false});
  const sb2 = s => {
    const m = {draft:'badge-gray',sent:'badge-blue',accepted:'badge-green',changes_requested:'badge-yellow',declined:'badge-red'};
    return `<span class="badge ${m[s]||'badge-gray'}">${s.replace('_',' ')}</span>`;
  };
  if (!proposals?.length) { el.innerHTML = '<div class="bg-white rounded-xl border p-8 text-center text-gray-400">No proposals yet.</div>'; return; }
  el.innerHTML = `
    <div class="bg-white rounded-xl border overflow-hidden">
      <table>
        <thead><tr><th>Customer</th><th>Title</th><th>Status</th><th>Updated</th><th></th></tr></thead>
        <tbody>
          ${proposals.map(p => `
            <tr class="cursor-pointer" onclick="openProposalDetail('${p.id}')">
              <td class="font-semibold">${escHtml(p.service_accounts?.contact_name||'â€”')}</td>
              <td>${escHtml(p.title)}</td><td>${sb2(p.status)}</td>
              <td class="text-gray-400 text-xs">${fmtDate(p.updated_at)}</td>
              <td class="text-right"><button class="text-xs text-[var(--green)] font-semibold hover:underline">Open</button></td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}

function openCreateProposal() {
  _editingProposalId = null; _proposalLineItems = [];
  document.getElementById('propModalTitle').textContent = 'New Proposal';
  document.getElementById('propAccountId').innerHTML = `<option value="">Select Customer</option>` +
    _jobsAccounts.map(a => `<option value="${a.id}">${escHtml(a.contact_name||'â€”')}</option>`).join('');
  document.getElementById('propTitle').value = ''; document.getElementById('propNotes').value = '';
  _renderProposalLineItems(); openModal('proposalModal');
  setTimeout(() => _searchable('propAccountId'), 50);
}

async function openEditProposal(proposalId) {
  closeModal('proposalDetailModal'); _editingProposalId = proposalId;
  const { data: prop  } = await sb.from('proposals').select('*').eq('id',proposalId).single();
  const { data: items } = await sb.from('proposal_line_items').select('*').eq('proposal_id',proposalId).order('sort_order');
  _proposalLineItems = (items||[]).map(i => ({id:i.id,description:i.description,quantity:i.quantity,unit_price:i.unit_price}));
  document.getElementById('propModalTitle').textContent = 'Edit Proposal';
  document.getElementById('propAccountId').innerHTML = `<option value="">Select Customer</option>` +
    _jobsAccounts.map(a => `<option value="${a.id}" ${a.id===prop.service_account_id?'selected':''}>${escHtml(a.contact_name||'â€”')}</option>`).join('');
  document.getElementById('propTitle').value = prop.title||''; document.getElementById('propNotes').value = prop.notes||'';
  _renderProposalLineItems(); openModal('proposalModal');
  setTimeout(() => _searchable('propAccountId'), 50);
}

function _renderProposalLineItems() {
  const el = document.getElementById('propLineItems'); if (!el) return;
  const total = _proposalLineItems.reduce((s,i) => s+(parseFloat(i.quantity)||0)*(parseFloat(i.unit_price)||0), 0);
  el.innerHTML = `
    ${_proposalLineItems.map((item,idx) => `
      <div class="flex gap-2 items-center mb-2">
        <input type="text" value="${escHtml(String(item.description||''))}" placeholder="Description"
               oninput="_proposalLineItems[${idx}].description=this.value"
               class="field flex-[3] py-2 text-sm" />
        <input type="number" value="${item.quantity}" min="0.01" step="any"
               oninput="_proposalLineItems[${idx}].quantity=parseFloat(this.value)||1;_updatePropTotal()"
               class="field w-16 py-2 text-sm text-center" placeholder="Qty" />
        <input type="number" value="${item.unit_price}" min="0" step="0.01"
               oninput="_proposalLineItems[${idx}].unit_price=parseFloat(this.value)||0;_updatePropTotal()"
               class="field w-24 py-2 text-sm" placeholder="$" />
        <button onclick="_proposalLineItems.splice(${idx},1);_renderProposalLineItems()"
                class="text-red-400 hover:text-red-600 text-xl font-bold px-1">&times;</button>
      </div>`).join('')}
    <div class="flex gap-2 mt-1">
      <select id="propCatalogPicker" class="field flex-1 text-sm py-1.5">
        <option value="">+ From Catalogâ€¦</option>
        ${_proposalProducts.map(p => `<option value="${p.id}">${escHtml(p.name)}${p.price!=null?' â€” '+fmtMoney(p.price):''}</option>`).join('')}
      </select>
      <button onclick="_proposalLineItems.push({id:null,description:'',quantity:1,unit_price:0});_renderProposalLineItems()"
              class="btn-outline text-sm py-1.5 whitespace-nowrap">+ Custom Line</button>
    </div>
    <div id="propTotal" class="text-right mt-2 font-bold">Total: ${fmtMoney(total)}</div>`;
  _searchable('propCatalogPicker', function(val) {
    if (val) { _addProductLine(val); setTimeout(() => this.clear(), 0); }
  });
}

function _addProductLine(productId) {
  if (!productId) return;
  const p = _proposalProducts.find(p => p.id === productId);
  if (!p) return;
  _proposalLineItems.push({id:null, description:p.name, quantity:1, unit_price:parseFloat(p.price)||0});
  _renderProposalLineItems();
}

function _updatePropTotal() {
  const el = document.getElementById('propTotal'); if (!el) return;
  el.textContent = `Total: ${fmtMoney(_proposalLineItems.reduce((s,i) => s+(parseFloat(i.quantity)||0)*(parseFloat(i.unit_price)||0),0))}`;
}

async function saveProposal(sendNow) {
  const accountId = document.getElementById('propAccountId').value;
  const title     = document.getElementById('propTitle').value.trim();
  const notes     = document.getElementById('propNotes').value.trim();
  if (!accountId) { toast('Select a customer', false); return; }
  if (!title)     { toast('Enter a title', false); return; }
  if (!_proposalLineItems.length) { toast('Add at least one line item', false); return; }
  const { data:{ user } } = await sb.auth.getUser();
  const status = sendNow ? 'sent' : 'draft';
  let proposalId = _editingProposalId;
  if (proposalId) {
    await sb.from('proposals').update({service_account_id:accountId,title,notes,status,updated_at:new Date().toISOString()}).eq('id',proposalId);
    await sb.from('proposal_line_items').delete().eq('proposal_id',proposalId);
  } else {
    const { data: newP } = await sb.from('proposals').insert({service_account_id:accountId,title,notes,status,created_by:user.id}).select().single();
    proposalId = newP.id;
  }
  await sb.from('proposal_line_items').insert(_proposalLineItems.map((item,i) => ({
    proposal_id:proposalId, description:item.description, quantity:item.quantity, unit_price:item.unit_price, sort_order:i,
  })));
  toast(sendNow ? 'Proposal sent to customer' : 'Proposal saved as draft');
  closeModal('proposalModal'); await loadProposalsList();
}

async function openProposalDetail(proposalId) {
  const [{ data:prop },{ data:items },{ data:msgs }] = await Promise.all([
    sb.from('proposals').select('*,service_accounts(contact_name)').eq('id',proposalId).single(),
    sb.from('proposal_line_items').select('*').eq('proposal_id',proposalId).order('sort_order'),
    sb.from('proposal_messages').select('id,body,created_at,profiles(full_name,role)').eq('proposal_id',proposalId).order('created_at'),
  ]);
  const total = (items||[]).reduce((s,i) => s+parseFloat(i.quantity)*parseFloat(i.unit_price), 0);
  const sb2 = s => { const m={draft:'badge-gray',sent:'badge-blue',accepted:'badge-green',changes_requested:'badge-yellow',declined:'badge-red'}; return `<span class="badge ${m[s]||'badge-gray'}">${s.replace('_',' ')}</span>`; };
  const { data:{ user } } = await sb.auth.getUser();
  const buildBubble = m => {
    const isA = m.profiles?.role==='admin';
    return `<div class="flex ${isA?'justify-end':'justify-start'}">
      <div class="max-w-xs rounded-2xl px-4 py-2.5 ${isA?'bg-[var(--green)] text-white':'bg-gray-100 text-gray-900'}">
        <p class="text-xs font-semibold mb-1 ${isA?'text-white/70':'text-gray-500'}">${escHtml(m.profiles?.full_name||(isA?'Admin':'Customer'))}</p>
        <p class="text-sm leading-relaxed">${escHtml(m.body)}</p>
        <p class="text-xs mt-1 ${isA?'text-white/50':'text-gray-400'}">${timeAgo(m.created_at)}</p>
      </div></div>`;
  };
  document.getElementById('proposalDetailBody').innerHTML = `
    <div class="flex items-start justify-between mb-4 gap-3">
      <div>
        <p class="text-lg font-extrabold">${escHtml(prop.title)}</p>
        <p class="text-sm text-gray-500 mt-0.5">${escHtml(prop.service_accounts?.contact_name||'â€”')}</p>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        ${sb2(prop.status)}
        ${prop.status!=='accepted'&&prop.status!=='declined'?`<button onclick="openEditProposal('${prop.id}')" class="btn-outline text-xs py-1">Edit</button>`:''}
        ${prop.status==='accepted'?`<button onclick="openCreateJobFromProposal('${prop.id}')" class="btn-green text-xs py-1">+ Create Job</button>`:''}
      </div>
    </div>
    <div class="bg-gray-50 rounded-xl border overflow-hidden mb-4">
      <table>
        <thead><tr><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
        <tbody>
          ${(items||[]).map(i => `<tr><td>${escHtml(i.description)}</td><td>${i.quantity}</td><td>${fmtMoney(i.unit_price)}</td><td class="font-semibold">${fmtMoney(parseFloat(i.quantity)*parseFloat(i.unit_price))}</td></tr>`).join('')}
        </tbody>
        <tfoot><tr><td colspan="3" class="text-right font-bold">Total</td><td class="font-bold text-lg">${fmtMoney(total)}</td></tr></tfoot>
      </table>
    </div>
    ${prop.notes?`<div class="bg-white border rounded-xl p-3 mb-4 text-sm text-gray-600"><strong>Notes:</strong> ${escHtml(prop.notes)}</div>`:''}
    ${prop.status==='changes_requested'?`<div class="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-4 text-sm text-amber-800 font-semibold">Customer has requested changes â€” see thread below.</div>`:''}
    <div class="bg-white rounded-xl border">
      <div class="p-3 border-b font-semibold text-sm">Message Thread</div>
      <div id="propThread" class="p-3 space-y-3 max-h-56 overflow-y-auto">
        ${(msgs||[]).map(buildBubble).join('')||'<p class="text-xs text-gray-400 text-center py-2">No messages yet.</p>'}
      </div>
      <div class="p-3 border-t flex gap-2">
        <input id="propReplyText" type="text" placeholder="Reply to customer..."
               class="field flex-1 py-2 text-sm" onkeydown="if(event.key==='Enter')proposalAdminReply('${prop.id}')" />
        <button onclick="proposalAdminReply('${prop.id}')" class="btn-green text-sm py-2">Send</button>
      </div>
    </div>`;
  openModal('proposalDetailModal');
  const thread = document.getElementById('propThread'); if (thread) thread.scrollTop = thread.scrollHeight;
}

async function proposalAdminReply(proposalId) {
  const textEl = document.getElementById('propReplyText');
  const body = textEl?.value?.trim(); if (!body) return;
  const { data:{ user } } = await sb.auth.getUser();
  await sb.from('proposal_messages').insert({proposal_id:proposalId, sender_id:user.id, body});
  textEl.value = ''; openProposalDetail(proposalId);
}

function openCreateJobFromProposal(proposalId) {
  closeModal('proposalDetailModal');
  document.querySelectorAll('[data-page]').forEach(l => l.classList.remove('active'));
  document.querySelector('[data-page="jobs"]')?.classList.add('active');
  loadPage('jobs');
  setTimeout(async () => {
    const { data: prop } = await sb.from('proposals').select('service_account_id,title,service_accounts(address)').eq('id',proposalId).single();
    openCreateJob(null);
    if (prop) {
      document.getElementById('jobProposalId').value = proposalId;
      document.getElementById('jobAddress').value    = prop.service_accounts?.address||'';
      document.getElementById('jobRecurringInfo').innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-xs text-green-800"><strong>From proposal:</strong> ${escHtml(prop.title)}</div>`;
      // Set account via Tom Select API once it has initialised (50ms delay in openCreateJob)
      setTimeout(() => {
        const ts = document.getElementById('jobAccountId')?.tomselect;
        if (ts) ts.setValue(prop.service_account_id||'');
        else document.getElementById('jobAccountId').value = prop.service_account_id||'';
      }, 100);
    }
  }, 250);
}

// DEAD CODE kept for reference: renderSchedule
async function renderSchedule(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Schedule</h1>
      <button class="btn-green" onclick="openModal('addVisitModal')">+ Schedule Visit</button>
    </div>

    <!-- Filters -->
    <div class="flex gap-3 mb-5">
      <select id="schedFilter" class="field" style="width:auto">
        <option value="upcoming">Upcoming</option>
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="visitTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Visit Modal -->
    <div id="addVisitModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Schedule a Visit</h2>
        <form id="addVisitForm" class="space-y-3">
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Customer *</label>
            <select name="service_account_id" required class="field mt-1" id="visitCustomerSelect">
              <option value="">Loading customers...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Technician *</label>
            <select name="tech_id" required class="field mt-1" id="visitTechSelect">
              <option value="">Loading techs...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Date & Time *</label>
            <input name="scheduled_date" type="datetime-local" required class="field mt-1" />
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Notes (visible to customer)</label>
            <textarea name="notes" rows="2" placeholder="Optional notes..." class="field mt-1"></textarea>
          </div>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Schedule Visit</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addVisitModal')">Cancel</button>
          </div>
          <p id="addVisitErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadVisitTable('upcoming');
  populateVisitSelects();

  document.getElementById('schedFilter').addEventListener('change', e => {
    loadVisitTable(e.target.value);
  });

  document.getElementById('addVisitForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addVisitErr');
    errEl.classList.add('hidden');

    const { error } = await sb.from('service_visits').insert({
      service_account_id: fd.get('service_account_id'),
      tech_id:            fd.get('tech_id') || null,
      scheduled_date:     new Date(fd.get('scheduled_date')).toISOString(),
      notes:              fd.get('notes') || null,
    });

    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addVisitModal');
    e.target.reset();
    toast('Visit scheduled');
    loadVisitTable(document.getElementById('schedFilter').value);
  });
}

async function populateVisitSelects() {
  const [{ data: accounts }, { data: techs }] = await Promise.all([
    sb.from('service_accounts').select('id, contact_name, profiles(full_name)').eq('active', true).order('contact_name'),
    sb.from('technicians').select('id, profiles(full_name)').eq('active', true).order('created_at'),
  ]);

  const custSel = document.getElementById('visitCustomerSelect');
  const techSel = document.getElementById('visitTechSelect');
  if (!custSel || !techSel) return;

  custSel.innerHTML = '<option value="">Select customer...</option>' +
    (accounts||[]).map(a => `<option value="${a.id}">${a.profiles?.full_name || a.contact_name || 'Unknown'}</option>`).join('');

  techSel.innerHTML = '<option value="">Select tech (optional)...</option>' +
    (techs||[]).map(t => `<option value="${t.id}">${t.profiles?.full_name || 'Unknown'}</option>`).join('');
}

async function loadVisitTable(filter) {
  let query = sb.from('service_visits')
    .select('id, scheduled_date, status, notes, service_accounts(contact_name, profiles(full_name)), technicians(profiles(full_name))')
    .order('scheduled_date', { ascending: filter !== 'completed' });

  const now = new Date().toISOString();
  if (filter === 'upcoming')   query = query.gte('scheduled_date', now).not('status','eq','cancelled');
  if (filter === 'completed')  query = query.eq('status', 'completed');
  if (filter === 'cancelled')  query = query.eq('status', 'cancelled');

  const { data, error } = await query.limit(50);

  const el = document.getElementById('visitTableWrap');
  if (!el) return;
  if (error || !data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No visits found.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Notes</th><th>Status</th><th></th></tr></thead>
    <tbody>
      ${data.map(v => {
        const customer = v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”';
        return `<tr>
          <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
          <td>${customer}</td>
          <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
          <td class="text-gray-400 text-xs max-w-xs truncate">${v.notes || ''}</td>
          <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
          <td class="text-right">
            ${v.status==='scheduled' ? `<button class="btn-outline text-xs px-2 py-1" onclick="cancelVisit('${v.id}')">Cancel</button>` : ''}
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function cancelVisit(id) {
  if (!confirm('Cancel this visit?')) return;
  await sb.from('service_visits').update({ status: 'cancelled' }).eq('id', id);
  toast('Visit cancelled');
  loadVisitTable(document.getElementById('schedFilter')?.value || 'upcoming');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _prodCategoryFilter = 'all';

async function renderProducts(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Products</h1>
      <div class="flex gap-2">
        <button class="btn-outline" onclick="openModal('manageCatsModal')">Manage Categories</button>
        <button class="btn-green" onclick="openAddProduct()">+ Add Product</button>
      </div>
    </div>

    <!-- Category filter pills -->
    <div class="flex flex-wrap gap-2 mb-5" id="prodCatPills">
      <button class="prod-cat-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]"
        onclick="setProdCatFilter(this,'all')">All</button>
      <button class="prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500"
        onclick="setProdCatFilter(this,'uncategorized')">Uncategorized</button>
    </div>

    <!-- Product table -->
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="productTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="manageCatsModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-4">Manage Categories</h2>
        <div id="catList" class="space-y-2 mb-4 max-h-64 overflow-y-auto">Loading...</div>
        <form id="addCatForm" class="flex gap-2 mt-2">
          <select id="catParentSelect" class="field flex-1">
            <option value="">Top-level category</option>
          </select>
          <input name="catName" placeholder="Category name" required class="field flex-1" />
          <button type="submit" class="btn-green px-4">Add</button>
        </form>
        <p id="addCatErr" class="text-red-600 text-sm mt-2 hidden"></p>
        <div class="mt-4 text-right">
          <button class="btn-outline" onclick="closeModal('manageCatsModal')">Done</button>
        </div>
      </div>
    </div>

    <!-- Add / Edit Product Modal -->
    <div id="productModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-4" id="productModalTitle">Add Product</h2>
        <form id="productForm" class="space-y-3">
          <input type="hidden" name="product_id" />
          <input name="name" placeholder="Product Name *" required class="field" />
          <input name="sku" placeholder="SKU (optional)" class="field" />
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-gray-500 uppercase">Category</label>
              <select name="category_id" class="field mt-1" id="productCatSelect">
                <option value="">Uncategorized</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-500 uppercase">Price *</label>
              <input name="price" type="number" step="0.01" placeholder="0.00" required class="field mt-1" />
            </div>
          </div>
          <textarea name="description" rows="2" placeholder="Description (optional)" class="field"></textarea>
          <!-- Image upload -->
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase block mb-1">Product Image</label>
            <div id="productImagePreview" class="flex items-center gap-3 mb-2 hidden">
              <img id="productImagePreviewImg" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg border" />
              <button type="button" onclick="removeProductImage()" class="text-red-500 text-xs hover:text-red-700 underline">Remove image</button>
            </div>
            <input type="hidden" name="image_url" />
            <input type="file" id="productImageFile" accept="image/jpeg,image/png,image/webp,image/gif"
                   class="text-sm text-gray-500 file:mr-2 file:py-1.5 file:px-3 file:rounded file:border file:border-gray-300 file:text-xs file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100 cursor-pointer" />
            <p class="text-xs text-gray-400 mt-0.5">JPG, PNG, WebP â€” max 5 MB</p>
          </div>
          <!-- Visibility -->
          <div class="flex flex-col gap-1.5 pt-2 border-t border-gray-100">
            <p class="text-xs font-semibold text-gray-500 uppercase mb-0.5">Visibility</p>
            <label class="flex items-center gap-2 text-sm font-medium cursor-pointer select-none">
              <input type="checkbox" name="tech_visible" class="w-4 h-4 rounded accent-[var(--green)]" />
              Available to techs (billing catalog)
            </label>
            <label class="flex items-center gap-2 text-sm font-medium cursor-pointer select-none">
              <input type="checkbox" name="customer_visible" class="w-4 h-4 rounded accent-[var(--green)]" />
              Show in customer shop
            </label>
          </div>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5" id="productSubmitBtn">Save Product</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('productModal')">Cancel</button>
          </div>
          <p id="productFormErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  await loadCategoryPills();
  loadProductTable('all');
  bindProductModalForm();
  loadManageCategories();

  document.getElementById('manageCatsModal').addEventListener('click', e => {
    if (e.target.id === 'manageCatsModal') closeModal('manageCatsModal');
  });
  document.getElementById('addCatForm').addEventListener('submit', addCategory);
}

function setProdCatFilter(btn, filter) {
  _prodCategoryFilter = filter;
  document.querySelectorAll('.prod-cat-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadProductTable(filter);
}

async function loadCategoryPills() {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  if (!cats?.length) return;

  const pills = document.getElementById('prodCatPills');
  if (!pills) return;

  // Only show top-level categories as pills
  const topLevel = cats.filter(c => !c.parent_id);
  topLevel.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500';
    btn.textContent = cat.name;
    btn.onclick = function() { setProdCatFilter(this, cat.id); };
    pills.appendChild(btn);
  });
}

async function loadProductTable(filter) {
  let query = sb.from('products')
    .select('id, name, sku, price, description, active, customer_visible, tech_visible, category_id, image_url, product_categories(id, name, parent_id, product_categories(name))')
    .order('name');

  if (filter === 'uncategorized') query = query.is('category_id', null);
  else if (filter !== 'all') {
    // filter by top-level category: include products in this cat or any sub-cat of it
    const { data: subcats } = await sb.from('product_categories').select('id').eq('parent_id', filter);
    const ids = [filter, ...(subcats||[]).map(s => s.id)];
    query = query.in('category_id', ids);
  }

  const { data, error } = await query;
  const el = document.getElementById('productTableWrap');
  if (!el) return;
  if (error) { el.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`; return; }
  if (!data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No products yet.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr>
      <th class="w-12"></th><th>Name</th><th>SKU</th><th>Category</th><th>Price</th><th>Visibility</th><th>Status</th><th class="text-right">Actions</th>
    </tr></thead>
    <tbody>
      ${data.map(p => {
        const cat = p.product_categories
          ? (p.product_categories.product_categories?.name
              ? `${p.product_categories.product_categories.name} â€º ${p.product_categories.name}`
              : p.product_categories.name)
          : 'â€”';
        return `<tr>
          <td>${p.image_url ? `<img src="${escHtml(p.image_url)}" alt="" class="w-10 h-10 object-cover rounded-lg border" />` : '<div class="w-10 h-10 rounded-lg border border-dashed border-gray-200 flex items-center justify-center text-gray-300 text-lg">ğŸ“¦</div>'}</td>
          <td class="font-semibold">${p.name}${p.description ? `<p class="text-xs text-gray-400 font-normal mt-0.5 truncate max-w-xs">${p.description}</p>` : ''}</td>
          <td class="text-gray-400 text-xs">${p.sku || 'â€”'}</td>
          <td class="text-gray-500 text-sm">${cat}</td>
          <td class="font-semibold">${fmtMoney(p.price)}</td>
          <td>
            <div class="flex flex-wrap gap-1">
              ${p.tech_visible ? '<span class="badge badge-blue">Tech</span>' : ''}
              ${p.customer_visible ? '<span class="badge badge-green">Shop</span>' : ''}
              ${!p.tech_visible && !p.customer_visible ? '<span class="badge badge-gray">Admin only</span>' : ''}
            </div>
          </td>
          <td><span class="badge ${p.active ? 'badge-green' : 'badge-gray'}">${p.active ? 'Active' : 'Inactive'}</span></td>
          <td class="text-right">
            <div class="flex justify-end gap-2">
              <button class="btn-outline text-xs px-2 py-1" onclick="openEditProduct('${p.id}')">Edit</button>
              <button class="btn-outline text-xs px-2 py-1" onclick="toggleProductActive('${p.id}',${p.active})">${p.active ? 'Deactivate' : 'Activate'}</button>
              <button class="text-xs px-2 py-1 bg-red-50 text-red-600 border border-red-200 rounded" onclick="deleteProduct('${p.id}','${(p.name).replace(/'/g,"\\'")}')">Delete</button>
            </div>
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function openAddProduct() {
  document.getElementById('productModalTitle').textContent = 'Add Product';
  document.getElementById('productForm').reset();
  document.querySelector('[name=product_id]').value = '';
  document.querySelector('[name=image_url]').value  = '';
  document.getElementById('productImagePreview').classList.add('hidden');
  document.getElementById('productSubmitBtn').textContent = 'Save Product';
  await populateProductCatSelect();
  openModal('productModal');
}

async function openEditProduct(productId) {
  const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
  if (!p) return;
  document.getElementById('productModalTitle').textContent = 'Edit Product';
  document.getElementById('productSubmitBtn').textContent = 'Save Changes';
  await populateProductCatSelect(p.category_id);
  const f = document.getElementById('productForm');
  f.querySelector('[name=product_id]').value = p.id;
  f.querySelector('[name=name]').value       = p.name || '';
  f.querySelector('[name=sku]').value        = p.sku  || '';
  f.querySelector('[name=price]').value      = p.price || '';
  f.querySelector('[name=description]').value    = p.description || '';
  f.querySelector('[name=tech_visible]').checked     = !!p.tech_visible;
  f.querySelector('[name=customer_visible]').checked = !!p.customer_visible;
  // Image
  f.querySelector('[name=image_url]').value  = p.image_url || '';
  document.getElementById('productImageFile').value = '';
  const preview    = document.getElementById('productImagePreview');
  const previewImg = document.getElementById('productImagePreviewImg');
  if (p.image_url) { previewImg.src = p.image_url; preview.classList.remove('hidden'); }
  else { preview.classList.add('hidden'); }
  openModal('productModal');
}

async function populateProductCatSelect(selectedId = '') {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  const sel = document.getElementById('productCatSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Uncategorized</option>';
  if (!cats?.length) return;
  const top = cats.filter(c => !c.parent_id);
  top.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat.id; opt.textContent = cat.name;
    if (cat.id === selectedId) opt.selected = true;
    sel.appendChild(opt);
    // Sub-categories indented
    cats.filter(c => c.parent_id === cat.id).forEach(sub => {
      const sopt = document.createElement('option');
      sopt.value = sub.id; sopt.textContent = `  â”” ${sub.name}`;
      if (sub.id === selectedId) sopt.selected = true;
      sel.appendChild(sopt);
    });
  });
}

function removeProductImage() {
  document.querySelector('[name=image_url]').value = '';
  document.getElementById('productImagePreview').classList.add('hidden');
  document.getElementById('productImageFile').value = '';
}

function bindProductModalForm() {
  // Show preview when file selected
  document.getElementById('productImageFile').addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('productImagePreviewImg').src = ev.target.result;
      document.getElementById('productImagePreview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('productForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd    = new FormData(e.target);
    const errEl = document.getElementById('productFormErr');
    const btn   = document.getElementById('productSubmitBtn');
    errEl.classList.add('hidden');
    btn.disabled = true;

    const productId = fd.get('product_id');

    // Handle image upload
    let imageUrl = fd.get('image_url') || null;
    const fileInput = document.getElementById('productImageFile');
    const file = fileInput.files[0];
    if (file) {
      const ext  = file.name.split('.').pop();
      const path = `${crypto.randomUUID()}.${ext}`;
      const { error: uploadErr } = await sb.storage.from('product-images').upload(path, file, { upsert: true, contentType: file.type });
      if (uploadErr) {
        errEl.textContent = 'Image upload failed: ' + uploadErr.message;
        errEl.classList.remove('hidden');
        btn.disabled = false;
        return;
      }
      const { data: { publicUrl } } = sb.storage.from('product-images').getPublicUrl(path);
      imageUrl = publicUrl;
    }

    const payload = {
      name:             fd.get('name'),
      sku:              fd.get('sku') || null,
      price:            parseFloat(fd.get('price')),
      description:      fd.get('description') || null,
      category_id:      fd.get('category_id') || null,
      tech_visible:     fd.get('tech_visible') === 'on',
      customer_visible: fd.get('customer_visible') === 'on',
      image_url:        imageUrl,
    };
    const { error } = productId
      ? await sb.from('products').update(payload).eq('id', productId)
      : await sb.from('products').insert(payload);
    btn.disabled = false;
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('productModal');
    toast(productId ? 'Product updated' : 'Product added');
    loadProductTable(_prodCategoryFilter);
  });
}

async function toggleProductActive(productId, current) {
  await sb.from('products').update({ active: !current }).eq('id', productId);
  toast(!current ? 'Product activated' : 'Product deactivated');
  loadProductTable(_prodCategoryFilter);
}

async function deleteProduct(productId, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  const { error } = await sb.from('products').delete().eq('id', productId);
  if (error) { toast(error.message, false); return; }
  toast('Product deleted');
  loadProductTable(_prodCategoryFilter);
}

// â”€â”€â”€ CATEGORY MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadManageCategories() {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  const el = document.getElementById('catList');
  if (!el) return;
  if (!cats?.length) { el.innerHTML = '<p class="text-gray-400 text-sm">No categories yet.</p>'; return; }

  const top = cats.filter(c => !c.parent_id);
  el.innerHTML = top.map(cat => {
    const subs = cats.filter(c => c.parent_id === cat.id);
    return `<div class="border rounded-lg overflow-hidden">
      <div class="flex items-center justify-between px-3 py-2 bg-gray-50">
        <span class="font-semibold text-sm">${cat.name}</span>
        <button class="text-red-500 text-xs hover:text-red-700" onclick="deleteCategory('${cat.id}','${cat.name.replace(/'/g,"\\'")}')">Delete</button>
      </div>
      ${subs.map(s => `
        <div class="flex items-center justify-between px-4 py-1.5 border-t text-sm text-gray-600">
          <span>â”” ${s.name}</span>
          <button class="text-red-400 text-xs hover:text-red-600" onclick="deleteCategory('${s.id}','${s.name.replace(/'/g,"\\'")}')">Delete</button>
        </div>`).join('')}
    </div>`;
  }).join('');

  // Populate parent select in add form
  const parentSel = document.getElementById('catParentSelect');
  if (parentSel) {
    parentSel.innerHTML = '<option value="">Top-level category</option>' +
      top.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  }
}

async function addCategory(e) {
  e.preventDefault();
  const name = e.target.catName.value.trim();
  const parent_id = document.getElementById('catParentSelect').value || null;
  const errEl = document.getElementById('addCatErr');
  errEl.classList.add('hidden');
  if (!name) return;
  const { error } = await sb.from('product_categories').insert({ name, parent_id });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  e.target.catName.value = '';
  toast('Category added');
  loadManageCategories();
  // Refresh pills
  const pills = document.getElementById('prodCatPills');
  if (pills) {
    pills.innerHTML = `
      <button class="prod-cat-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" onclick="setProdCatFilter(this,'all')">All</button>
      <button class="prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setProdCatFilter(this,'uncategorized')">Uncategorized</button>`;
    await loadCategoryPills();
  }
}

async function deleteCategory(catId, name) {
  if (!confirm(`Delete category "${name}"? Products in this category will become uncategorized.`)) return;
  const { error } = await sb.from('product_categories').delete().eq('id', catId);
  if (error) { toast(error.message, false); return; }
  toast('Category deleted');
  loadManageCategories();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILLING (placeholder â€” next build)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP â€” Today's visits overview
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADMIN_MAPS_KEY  = 'AIzaSyB5aX6BD0W83Z6AhjoaGnW2k_cTtIQWWo4';
const TECH_DOT_COLORS = ['#1E5E37','#2CA7DF','#f59e0b','#8b5cf6','#ef4444','#06b6d4','#84cc16','#f97316','#ec4899','#6366f1'];

let _adminMapsPromise = null;
function loadAdminMaps() {
  if (_adminMapsPromise) return _adminMapsPromise;
  _adminMapsPromise = new Promise(resolve => {
    if (window.google?.maps?.places) { resolve(); return; }
    window._adminGmReady = resolve;
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${ADMIN_MAPS_KEY}&libraries=places&callback=_adminGmReady`;
    s.async = true; s.defer = true;
    document.head.appendChild(s);
  });
  return _adminMapsPromise;
}

// Attach Google Places autocomplete to a single-line address field.
// For split-field forms, pass onFill({street,city,state,zip}).
function attachAddressAC(inputEl, onFill) {
  if (!inputEl || !window.google?.maps?.places) return;
  const ac = new google.maps.places.Autocomplete(inputEl, {
    componentRestrictions: { country: 'us' },
    fields: ['formatted_address', 'address_components'],
    types: ['address'],
  });
  ac.addListener('place_changed', () => {
    const place = ac.getPlace();
    if (!place.address_components) return;
    const get = (type, short = false) => {
      const c = place.address_components.find(c => c.types.includes(type));
      return c ? (short ? c.short_name : c.long_name) : '';
    };
    const street = [get('street_number'), get('route')].filter(Boolean).join(' ');
    if (onFill) {
      onFill({ street, city: get('locality') || get('sublocality_level_1') || '', state: get('administrative_area_level_1', true), zip: get('postal_code') });
    } else {
      inputEl.value = place.formatted_address || street;
    }
  });
}

// Preload Maps+Places in the background so autocomplete is ready when modals open
loadAdminMaps();

async function renderMap(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Today's Map</h1>
    <div id="adminMap" class="rounded-xl overflow-hidden bg-gray-200 border"
         style="height:calc(100vh - 15rem);min-height:420px;"></div>
    <div id="mapLegend" class="mt-4 flex flex-wrap gap-3">
      <p class="text-gray-400 text-sm">Loading...</p>
    </div>`;

  await loadAdminMaps();

  const today    = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1);

  const { data: visits } = await sb.from('jobs')
    .select('id, status, scheduled_date, scheduled_time, address, service_accounts(contact_name, address), technicians(id, profiles(full_name))')
    .eq('scheduled_date', today.toISOString().split('T')[0])
    .not('status', 'in', '("cancelled")')
    .order('scheduled_time', { ascending: true, nullsFirst: false });

  const mapEl    = document.getElementById('adminMap');
  const legendEl = document.getElementById('mapLegend');
  if (!mapEl) return;

  const map = new google.maps.Map(mapEl, {
    center: { lat: 34.05, lng: -118.24 },
    zoom: 10,
    disableDefaultUI: false,
    zoomControl: true,
    fullscreenControl: true,
    mapTypeControl: true,
    streetViewControl: false,
  });

  if (!visits?.length) {
    if (legendEl) legendEl.innerHTML = '<p class="text-gray-400 text-sm">No jobs scheduled today.</p>';
    return;
  }

  // Assign a colour per technician
  const techIds   = [...new Set(visits.map(v => v.technicians?.id).filter(Boolean))];
  const techColor = Object.fromEntries(techIds.map((id, i) => [id, TECH_DOT_COLORS[i % TECH_DOT_COLORS.length]]));
  const techNames = Object.fromEntries(
    visits.filter(v => v.technicians?.id)
          .map(v => [v.technicians.id, v.technicians.profiles?.full_name || 'Tech'])
  );

  const geocoder   = new google.maps.Geocoder();
  const infoWindow = new google.maps.InfoWindow();
  const bounds     = new google.maps.LatLngBounds();

  await Promise.all(visits.map(visit => new Promise(resolve => {
    const address = visit.address || visit.service_accounts?.address;
    if (!address) { resolve(); return; }

    geocoder.geocode({ address }, (results, status) => {
      if (status !== 'OK') { resolve(); return; }

      const pos      = results[0].geometry.location;
      const techId   = visit.technicians?.id;
      const color    = techColor[techId] || '#6b7280';
      const done     = visit.status === 'completed';
      const custName = visit.service_accounts?.contact_name || 'Unknown';
      const techName = visit.technicians?.profiles?.full_name || 'Unassigned';
      const time     = visit.scheduled_time ? fmtJobTime(visit.scheduled_time) : 'â€”';

      const marker = new google.maps.Marker({
        position: pos, map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE, scale: 13,
          fillColor: done ? '#9ca3af' : color,
          fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2,
        },
        title: custName,
      });

      bounds.extend(pos);

      marker.addListener('click', () => {
        infoWindow.setContent(`
          <div style="font-family:Inter,sans-serif;font-size:13px;line-height:1.6;min-width:170px;padding:2px 0;">
            <p style="font-weight:700;margin:0 0 2px;font-size:14px;">${custName}</p>
            <p style="color:#6b7280;margin:0 0 6px;font-size:12px;">${address}</p>
            <p style="margin:0;">Tech: <strong>${techName}</strong></p>
            <p style="margin:2px 0;">Time: <strong>${time}</strong></p>
            <p style="margin:4px 0 0;">
              <span style="background:${done?'#dcfce7':'#dbeafe'};color:${done?'#166534':'#1e40af'};
                           padding:2px 10px;border-radius:9999px;font-size:11px;font-weight:700;text-transform:uppercase;">
                ${visit.status}
              </span>
            </p>
          </div>`);
        infoWindow.open(map, marker);
      });

      resolve();
    });
  })));

  if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 60 });

  // Legend
  if (legendEl) {
    legendEl.innerHTML = techIds.map(id => `
      <div class="flex items-center gap-2 bg-white border rounded-lg px-3 py-1.5 shadow-sm">
        <span style="background:${techColor[id]}" class="w-3 h-3 rounded-full shrink-0"></span>
        <span class="text-sm font-medium">${techNames[id]}</span>
      </div>`).join('') + `
      <div class="flex items-center gap-2 bg-white border rounded-lg px-3 py-1.5 shadow-sm">
        <span style="background:#9ca3af" class="w-3 h-3 rounded-full shrink-0"></span>
        <span class="text-sm font-medium text-gray-500">Completed</span>
      </div>`;
  }
}

// â”€â”€â”€ BUILD PROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _currentBuildId = null;

async function renderBuild(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Build Projects</h1>
      <button onclick="createBuildProject()" class="btn-primary px-4 py-2 rounded-lg text-sm font-semibold">+ New Project</button>
    </div>
    <div id="buildList" class="grid gap-4"></div>
  `;
  await loadBuildList();
}

async function loadBuildList() {
  const { data, error } = await sb.from('build_projects')
    .select('id, title, status, created_at, service_accounts(contact_name)')
    .order('created_at', { ascending: false });
  const el = document.getElementById('buildList');
  if (error || !data) { el.innerHTML = '<p class="text-red-500">Failed to load projects.</p>'; return; }
  if (!data.length) { el.innerHTML = '<p class="text-gray-500">No build projects yet.</p>'; return; }
  const statusColor = { planning:'bg-blue-100 text-blue-700', in_progress:'bg-yellow-100 text-yellow-700', completed:'bg-green-100 text-green-700', on_hold:'bg-gray-100 text-gray-600' };
  el.innerHTML = data.map(p => `
    <div class="bg-white border rounded-xl p-5 shadow-sm cursor-pointer hover:shadow-md transition" onclick="openBuildProject('${p.id}')">
      <div class="flex items-center justify-between">
        <div>
          <p class="font-bold text-lg">${p.title}</p>
          <p class="text-sm text-gray-500">${p.service_accounts?.contact_name || 'No customer'}</p>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor[p.status] || 'bg-gray-100 text-gray-600'}">${p.status.replace('_',' ')}</span>
      </div>
    </div>`).join('');
}

async function createBuildProject() {
  const { data: customers } = await sb.from('service_accounts')
    .select('id, contact_name')
    .eq('is_build_customer', true)
    .order('contact_name');
  if (!customers?.length) {
    alert('No build customers found. Mark a customer as a Build Customer first.');
    return;
  }
  const opts = customers.map(c => `<option value="${c.id}">${c.contact_name}</option>`).join('');
  // Show a small inline modal
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-4">
      <h2 class="text-xl font-bold mb-4">New Build Project</h2>
      <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
      <select id="_bpCust" class="w-full border rounded-lg px-3 py-2 mb-3 text-sm">${opts}</select>
      <label class="block text-sm font-medium text-gray-700 mb-1">Project Title</label>
      <input id="_bpTitle" type="text" placeholder="e.g. Backyard Koi Pond" class="w-full border rounded-lg px-3 py-2 mb-4 text-sm"/>
      <div class="flex gap-3">
        <button id="_bpCreate" class="btn-green flex-1 py-2">Create</button>
        <button id="_bpCancel" class="btn-outline flex-1 py-2">Cancel</button>
      </div>
      <p id="_bpErr" class="text-red-500 text-sm mt-2 hidden"></p>
    </div>`;
  document.body.appendChild(overlay);
  document.getElementById('_bpCancel').onclick = () => document.body.removeChild(overlay);
  document.getElementById('_bpCreate').onclick = async () => {
    const title = document.getElementById('_bpTitle').value.trim();
    const saId  = document.getElementById('_bpCust').value;
    const errEl = document.getElementById('_bpErr');
    if (!title) { errEl.textContent = 'Please enter a project title.'; errEl.classList.remove('hidden'); return; }
    const { data, error } = await sb.from('build_projects').insert({
      title, service_account_id: saId, status: 'planning',
    }).select('id').single();
    document.body.removeChild(overlay);
    if (error || !data) { alert('Error: ' + (error?.message || 'unknown')); return; }
    openBuildProject(data.id);
  };
}

async function openBuildProject(id) {
  _currentBuildId = id;
  const { data: p, error } = await sb.from('build_projects')
    .select('*, service_accounts(id, contact_name)')
    .eq('id', id).single();
  if (error || !p) { alert('Failed to load project'); return; }

  const mainEl = document.getElementById('pageContent');
  const statusColor = { planning:'bg-blue-100 text-blue-700', in_progress:'bg-yellow-100 text-yellow-700', completed:'bg-green-100 text-green-700', on_hold:'bg-gray-100 text-gray-600' };
  mainEl.innerHTML = `
    <div class="mb-4 flex items-center gap-3">
      <button onclick="loadPage('build')" class="text-gray-400 hover:text-gray-700 text-2xl">&larr;</button>
      <div class="flex-1">
        <input id="bpTitle" value="${p.title}" class="text-3xl font-extrabold bg-transparent border-b-2 border-transparent focus:border-[var(--green)] outline-none w-full"
          onblur="saveBuildProjectField('title', this.value)"/>
      </div>
      <select onchange="saveBuildProjectField('status', this.value)" class="border rounded-lg px-3 py-1.5 text-sm font-semibold ${statusColor[p.status]}">
        ${['planning','in_progress','completed','on_hold'].map(s =>
          `<option value="${s}" ${p.status===s?'selected':''}>${s.replace('_',' ')}</option>`).join('')}
      </select>
    </div>

    <!-- Customer link -->
    <div class="bg-white border rounded-xl p-4 mb-4 flex items-center gap-4">
      <span class="text-sm text-gray-500 w-28">Customer</span>
      <span class="font-semibold">${p.service_accounts?.contact_name || 'â€”'}</span>
    </div>

    <!-- Description -->
    <div class="bg-white border rounded-xl p-4 mb-4">
      <label class="text-sm text-gray-500 block mb-1">Project Description</label>
      <textarea id="bpDesc" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--green)] outline-none"
        onblur="saveBuildProjectField('description', this.value)">${p.description || ''}</textarea>
    </div>

    <!-- Sub-tabs -->
    <div class="flex gap-2 mb-4 flex-wrap" id="buildSubTabs">
      ${['milestones','scope','equipment','photos','payments','documents','messages'].map((t,i) => `
        <button onclick="loadBuildSubTab('${t}')" data-tab="${t}"
          class="build-tab px-4 py-1.5 rounded-full text-sm font-semibold border-2 ${i===0?'border-[var(--green)] text-[var(--green)]':'border-gray-200 text-gray-500'}">
          ${t.charAt(0).toUpperCase()+t.slice(1)}
        </button>`).join('')}
    </div>
    <div id="buildSubContent"></div>
  `;
  loadBuildSubTab('milestones');
}

async function saveBuildProjectField(field, value) {
  if (!_currentBuildId) return;
  await sb.from('build_projects').update({ [field]: value }).eq('id', _currentBuildId);
}

function loadBuildSubTab(tab) {
  document.querySelectorAll('.build-tab').forEach(b => {
    const active = b.dataset.tab === tab;
    b.className = `build-tab px-4 py-1.5 rounded-full text-sm font-semibold border-2 ${active ? 'border-[var(--green)] text-[var(--green)]' : 'border-gray-200 text-gray-500'}`;
  });
  const el = document.getElementById('buildSubContent');
  if (tab === 'milestones') renderBuildMilestones(el);
  else if (tab === 'scope') renderBuildScope(el);
  else if (tab === 'equipment') renderBuildEquipment(el);
  else if (tab === 'photos') renderBuildPhotos(el);
  else if (tab === 'payments') renderBuildPayments(el);
  else if (tab === 'documents') renderBuildDocuments(el);
  else if (tab === 'messages') renderBuildMessages(el);
}

// â”€â”€ Milestones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderBuildMilestones(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_milestones')
    .select('*').eq('project_id', _currentBuildId).order('sort_order');
  const statusOpts = ['pending','in_progress','completed'].map(s =>
    `<option value="${s}">${s.replace('_',' ')}</option>`).join('');
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">Milestones</h2>
        <button onclick="addMilestone()" class="btn-primary px-3 py-1.5 text-sm rounded-lg">+ Add</button>
      </div>
      ${(data||[]).length ? `
        <div class="divide-y" id="milestoneList">
          ${(data||[]).map(m => `
            <div class="py-3 flex items-start gap-3" id="ml-${m.id}">
              <div class="flex-1">
                <input value="${m.title}" class="font-semibold w-full border-b border-transparent focus:border-[var(--green)] outline-none bg-transparent"
                  onblur="sb.from('build_milestones').update({title:this.value}).eq('id','${m.id}')"/>
                <input value="${m.description||''}" placeholder="Descriptionâ€¦" class="text-sm text-gray-500 w-full border-b border-transparent focus:border-[var(--green)] outline-none bg-transparent mt-0.5"
                  onblur="sb.from('build_milestones').update({description:this.value}).eq('id','${m.id}')"/>
                ${m.due_date ? `<p class="text-xs text-gray-400 mt-0.5">Due: ${m.due_date}</p>` : ''}
              </div>
              <select onchange="updateMilestoneStatus('${m.id}', this.value)" class="border rounded-lg px-2 py-1 text-xs">
                ${['pending','in_progress','completed'].map(s =>
                  `<option value="${s}" ${m.status===s?'selected':''}>${s.replace('_',' ')}</option>`).join('')}
              </select>
              <button onclick="deleteMilestone('${m.id}')" class="text-red-400 hover:text-red-600 text-lg leading-none">&times;</button>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No milestones yet.</p>'}
    </div>`;
}

async function addMilestone() {
  const title = prompt('Milestone title:');
  if (!title) return;
  await sb.from('build_milestones').insert({ project_id: _currentBuildId, title: title.trim(), status: 'pending', sort_order: 999 });
  loadBuildSubTab('milestones');
}

async function updateMilestoneStatus(id, status) {
  await sb.from('build_milestones').update({ status }).eq('id', id);
}

async function deleteMilestone(id) {
  if (!confirm('Delete milestone?')) return;
  await sb.from('build_milestones').delete().eq('id', id);
  loadBuildSubTab('milestones');
}

// â”€â”€ Scope (renderings / drawings) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderBuildScope(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_scope_files')
    .select('*').eq('project_id', _currentBuildId).order('sort_order');
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">Scope â€” Renderings &amp; Drawings</h2>
        <label class="btn-primary px-3 py-1.5 text-sm rounded-lg cursor-pointer">
          + Upload <input type="file" accept="image/*,application/pdf" multiple class="hidden" onchange="uploadScopeFiles(this.files)"/>
        </label>
      </div>
      ${(data||[]).length ? `
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="scopeGrid">
          ${(data||[]).map(f => f.file_type === 'pdf' ? `
            <div class="border rounded-xl p-3 flex flex-col gap-2">
              <a href="${f.file_url}" target="_blank" class="text-[var(--green)] text-sm font-medium truncate">ğŸ“„ ${f.title||'Document'}</a>
              <input value="${escHtml(f.title||'')}" placeholder="Labelâ€¦" class="text-xs border rounded px-2 py-1 w-full"
                onblur="sb.from('build_scope_files').update({title:this.value}).eq('id','${f.id}')"/>
              <button onclick="deleteScopeFile('${f.id}')" class="text-red-400 text-xs hover:underline self-start">Delete</button>
            </div>` : `
            <div class="border rounded-xl overflow-hidden">
              <img src="${f.file_url}" class="w-full h-40 object-cover cursor-pointer" onclick="openImageLightbox('${f.file_url}','${escHtml(f.title||'')}')"/>
              <div class="p-2">
                <input value="${escHtml(f.title||'')}" placeholder="Labelâ€¦" class="text-xs border rounded px-2 py-1 w-full"
                  onblur="sb.from('build_scope_files').update({title:this.value}).eq('id','${f.id}')"/>
                <button onclick="deleteScopeFile('${f.id}')" class="text-red-400 text-xs hover:underline mt-1 block">Delete</button>
              </div>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No scope files uploaded yet.</p>'}
    </div>`;
}

async function uploadScopeFiles(files) {
  for (const file of files) {
    const ext = file.name.split('.').pop();
    const path = `${_currentBuildId}/${crypto.randomUUID()}.${ext}`;
    const { data: up, error: upErr } = await sb.storage.from('build-scope').upload(path, file, { upsert: true });
    if (upErr) { alert('Upload failed: ' + upErr.message); continue; }
    const { data: { publicUrl } } = sb.storage.from('build-scope').getPublicUrl(path);
    const isImg = file.type.startsWith('image/');
    await sb.from('build_scope_files').insert({
      project_id: _currentBuildId, file_url: publicUrl,
      file_type: isImg ? 'image' : 'pdf', title: file.name, sort_order: 0
    });
  }
  loadBuildSubTab('scope');
}

async function deleteScopeFile(id) {
  if (!confirm('Delete this file?')) return;
  await sb.from('build_scope_files').delete().eq('id', id);
  loadBuildSubTab('scope');
}

// â”€â”€ Equipment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _eqMap = {};
let _editingEquipmentId = null;
let _eqPendingPhotoFile = null;

async function renderBuildEquipment(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_equipment')
    .select('*').eq('project_id', _currentBuildId).order('sort_order');
  (data||[]).forEach(eq => { _eqMap[eq.id] = eq; });
  const fmtDate = d => d ? new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">Equipment</h2>
        <button class="btn-primary px-3 py-1.5 text-sm rounded-lg" onclick="openAddEquipment()">+ Add Equipment</button>
      </div>
      ${(data||[]).length ? `
        <div class="space-y-3">
          ${(data||[]).map(eq => `
            <div class="border rounded-xl overflow-hidden flex">
              <div class="w-28 shrink-0 bg-gray-50">
                ${eq.image_url
                  ? `<img src="${eq.image_url}" class="w-full h-full object-cover" style="min-height:100px" onclick="openImageLightbox('${eq.image_url}','${escHtml(eq.name||'')}')"/>`
                  : '<div class="w-full min-h-[100px] h-full flex items-center justify-center text-gray-200 text-4xl">ğŸ”§</div>'}
              </div>
              <div class="flex-1 p-4">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <p class="font-bold text-sm">${escHtml(eq.name||'Unnamed')}</p>
                    ${(eq.brand||eq.model) ? `<p class="text-xs text-gray-500">${escHtml([eq.brand,eq.model].filter(Boolean).join(' Â· '))}</p>` : ''}
                    ${eq.serial_number ? `<p class="text-xs text-gray-400 font-mono mt-0.5">S/N: ${escHtml(eq.serial_number)}</p>` : ''}
                  </div>
                  <div class="flex gap-2 shrink-0">
                    <button onclick="openEditEquipment('${eq.id}')" class="btn-outline text-xs px-2 py-1">Edit</button>
                    <button onclick="deleteEquipment('${eq.id}')" class="text-red-400 text-xs hover:underline">Delete</button>
                  </div>
                </div>
                ${(eq.warranty_provider||eq.warranty_expires) ? `
                  <div class="mt-2 pt-2 border-t flex flex-wrap gap-x-4 gap-y-0.5">
                    ${eq.warranty_provider ? `<span class="text-xs text-gray-500">ğŸ›¡ï¸ ${escHtml(eq.warranty_provider)}</span>` : ''}
                    ${eq.warranty_expires ? `<span class="text-xs text-gray-400">Expires ${fmtDate(eq.warranty_expires)}</span>` : ''}
                  </div>` : ''}
              </div>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No equipment added yet.</p>'}
    </div>`;
}

function openAddEquipment() {
  _editingEquipmentId = null;
  _eqPendingPhotoFile = null;
  document.getElementById('eqModalTitle').textContent = 'Add Equipment';
  ['eqName','eqBrand','eqModel','eqSerial','eqWarrantyProvider','eqWarrantyExpires','eqWarrantyNotes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('eqPhotoImg').classList.add('hidden');
  document.getElementById('eqPhotoPlaceholder').classList.remove('hidden');
  document.getElementById('eqDocsSection').classList.add('hidden');
  openModal('equipmentModal');
}

function openEditEquipment(id) {
  const eq = _eqMap[id];
  if (!eq) return;
  _editingEquipmentId = id;
  _eqPendingPhotoFile = null;
  document.getElementById('eqModalTitle').textContent = 'Edit Equipment';
  document.getElementById('eqName').value = eq.name || '';
  document.getElementById('eqBrand').value = eq.brand || '';
  document.getElementById('eqModel').value = eq.model || '';
  document.getElementById('eqSerial').value = eq.serial_number || '';
  document.getElementById('eqWarrantyProvider').value = eq.warranty_provider || '';
  document.getElementById('eqWarrantyExpires').value = eq.warranty_expires || '';
  document.getElementById('eqWarrantyNotes').value = eq.warranty_notes || '';
  if (eq.image_url) {
    document.getElementById('eqPhotoImg').src = eq.image_url;
    document.getElementById('eqPhotoImg').classList.remove('hidden');
    document.getElementById('eqPhotoPlaceholder').classList.add('hidden');
  } else {
    document.getElementById('eqPhotoImg').classList.add('hidden');
    document.getElementById('eqPhotoPlaceholder').classList.remove('hidden');
  }
  document.getElementById('eqDocsSection').classList.remove('hidden');
  renderEqDocs(id);
  openModal('equipmentModal');
}

function eqHandlePhoto(file) {
  if (!file) return;
  _eqPendingPhotoFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById('eqPhotoImg');
    img.src = e.target.result;
    img.classList.remove('hidden');
    document.getElementById('eqPhotoPlaceholder').classList.add('hidden');
  };
  reader.readAsDataURL(file);
}

async function saveEquipment() {
  const name = document.getElementById('eqName').value.trim();
  if (!name) { alert('Name is required'); return; }
  const fields = {
    name,
    brand: document.getElementById('eqBrand').value.trim() || null,
    model: document.getElementById('eqModel').value.trim() || null,
    serial_number: document.getElementById('eqSerial').value.trim() || null,
    warranty_provider: document.getElementById('eqWarrantyProvider').value.trim() || null,
    warranty_expires: document.getElementById('eqWarrantyExpires').value || null,
    warranty_notes: document.getElementById('eqWarrantyNotes').value.trim() || null,
  };
  let eqId = _editingEquipmentId;
  if (!eqId) {
    const { data, error } = await sb.from('build_equipment')
      .insert({ project_id: _currentBuildId, ...fields, sort_order: 0 }).select().single();
    if (error) { alert('Save failed: ' + error.message); return; }
    eqId = data.id;
  } else {
    const { error } = await sb.from('build_equipment').update(fields).eq('id', eqId);
    if (error) { alert('Save failed: ' + error.message); return; }
  }
  if (_eqPendingPhotoFile) {
    const ext = _eqPendingPhotoFile.name.split('.').pop();
    const path = `${_currentBuildId}/${eqId}.${ext}`;
    const { data: up } = await sb.storage.from('build-equipment').upload(path, _eqPendingPhotoFile, { upsert: true });
    if (up) {
      const { data: { publicUrl } } = sb.storage.from('build-equipment').getPublicUrl(path);
      await sb.from('build_equipment').update({ image_url: publicUrl }).eq('id', eqId);
    }
    _eqPendingPhotoFile = null;
  }
  closeModal('equipmentModal');
  loadBuildSubTab('equipment');
}

async function renderEqDocs(equipmentId) {
  const container = document.getElementById('eqDocsList');
  if (!container) return;
  const { data } = await sb.from('build_equipment_docs').select('*').eq('equipment_id', equipmentId).order('created_at');
  container.innerHTML = (data||[]).length
    ? (data||[]).map(d => `
        <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
          <span class="text-sm flex-1 truncate">ğŸ“„ ${escHtml(d.name)}</span>
          <a href="${d.file_url}" target="_blank" class="text-[var(--green)] text-xs hover:underline shrink-0">Download</a>
          <button onclick="deleteEqDoc('${d.id}')" class="text-red-400 text-xs hover:underline shrink-0">Delete</button>
        </div>`).join('')
    : '<p class="text-xs text-gray-400">No documents uploaded yet.</p>';
}

async function eqUploadDoc(file) {
  if (!file || !_editingEquipmentId) return;
  const ext = file.name.split('.').pop();
  const path = `${_currentBuildId}/docs/${_editingEquipmentId}/${crypto.randomUUID()}.${ext}`;
  const { data: up, error } = await sb.storage.from('build-equipment').upload(path, file, { upsert: true });
  if (error) { alert('Upload failed: ' + error.message); return; }
  const { data: { publicUrl } } = sb.storage.from('build-equipment').getPublicUrl(path);
  await sb.from('build_equipment_docs').insert({
    equipment_id: _editingEquipmentId, project_id: _currentBuildId, name: file.name, file_url: publicUrl
  });
  renderEqDocs(_editingEquipmentId);
}

async function deleteEqDoc(docId) {
  if (!confirm('Delete this document?')) return;
  await sb.from('build_equipment_docs').delete().eq('id', docId);
  renderEqDocs(_editingEquipmentId);
}

async function deleteEquipment(id) {
  if (!confirm('Delete this equipment item?')) return;
  await sb.from('build_equipment').delete().eq('id', id);
  loadBuildSubTab('equipment');
}

// â”€â”€ Progress Photos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderBuildPhotos(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_progress_photos')
    .select('*').eq('project_id', _currentBuildId).order('taken_at', { ascending: false });
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">Build Progress Photos</h2>
        <label class="btn-primary px-3 py-1.5 text-sm rounded-lg cursor-pointer">
          + Upload Photos <input type="file" accept="image/*" multiple class="hidden" onchange="uploadBuildPhotos(this.files)"/>
        </label>
      </div>
      ${(data||[]).length ? `
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
          ${(data||[]).map(ph => `
            <div class="border rounded-xl overflow-hidden">
              <img src="${ph.photo_url}" class="w-full h-36 object-cover cursor-pointer" onclick="openImageLightbox('${ph.photo_url}','${ph.caption||''}')"/>
              <div class="p-2">
                <input value="${ph.caption||''}" placeholder="Captionâ€¦" class="text-xs border rounded px-2 py-1 w-full"
                  onblur="sb.from('build_progress_photos').update({caption:this.value}).eq('id','${ph.id}')"/>
                <p class="text-xs text-gray-400 mt-1">${ph.taken_at ? new Date(ph.taken_at).toLocaleDateString() : ''}</p>
                <button onclick="deleteBuildPhoto('${ph.id}')" class="text-red-400 text-xs hover:underline mt-0.5 block">Delete</button>
              </div>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No photos uploaded yet.</p>'}
    </div>`;
}

async function uploadBuildPhotos(files) {
  for (const file of files) {
    const ext = file.name.split('.').pop();
    const path = `${_currentBuildId}/${crypto.randomUUID()}.${ext}`;
    const { data: up } = await sb.storage.from('build-progress').upload(path, file, { upsert: true });
    if (!up) continue;
    const { data: { publicUrl } } = sb.storage.from('build-progress').getPublicUrl(path);
    await sb.from('build_progress_photos').insert({
      project_id: _currentBuildId, photo_url: publicUrl, taken_at: new Date().toISOString()
    });
  }
  loadBuildSubTab('photos');
}

async function deleteBuildPhoto(id) {
  if (!confirm('Delete this photo?')) return;
  await sb.from('build_progress_photos').delete().eq('id', id);
  loadBuildSubTab('photos');
}

// â”€â”€ Payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderBuildPayments(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_payments')
    .select('*').eq('project_id', _currentBuildId).order('due_date');
  const total = (data||[]).reduce((s,p) => s + parseFloat(p.amount||0), 0);
  const paid  = (data||[]).filter(p => p.status==='paid').reduce((s,p) => s + parseFloat(p.amount||0), 0);
  const fmt = n => '$' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits:2});
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="font-bold text-lg">Payment Schedule</h2>
          <p class="text-sm text-gray-500">${fmt(paid)} paid of ${fmt(total)} total</p>
        </div>
        <button onclick="addBuildPayment()" class="btn-primary px-3 py-1.5 text-sm rounded-lg">+ Add</button>
      </div>
      ${(data||[]).length ? `
        <div class="divide-y">
          ${(data||[]).map(p => `
            <div class="py-3 flex items-center gap-3">
              <div class="flex-1">
                <input value="${p.label||''}" placeholder="Payment labelâ€¦" class="font-semibold text-sm w-full border-b border-transparent focus:border-[var(--green)] outline-none bg-transparent"
                  onblur="sb.from('build_payments').update({label:this.value}).eq('id','${p.id}')"/>
                ${p.due_date ? `<p class="text-xs text-gray-400">Due: ${p.due_date}</p>` : ''}
              </div>
              <span class="font-bold text-sm w-28 text-right">${fmt(p.amount||0)}</span>
              <select onchange="updatePaymentStatus('${p.id}', this.value)" class="border rounded-lg px-2 py-1 text-xs">
                ${['pending','paid','overdue'].map(s =>
                  `<option value="${s}" ${p.status===s?'selected':''}>${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('')}
              </select>
              <button onclick="deleteBuildPayment('${p.id}')" class="text-red-400 hover:text-red-600 text-lg leading-none">&times;</button>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No payments scheduled yet.</p>'}
    </div>`;
}

async function addBuildPayment() {
  const label = prompt('Payment label (e.g. "Deposit"):');
  if (!label) return;
  const amtStr = prompt('Amount (e.g. 2500):');
  const amount = parseFloat(amtStr || '0') || 0;
  await sb.from('build_payments').insert({ project_id: _currentBuildId, label: label.trim(), amount, status: 'pending', sort_order: 0 });
  loadBuildSubTab('payments');
}

async function updatePaymentStatus(id, status) {
  await sb.from('build_payments').update({ status }).eq('id', id);
}

async function deleteBuildPayment(id) {
  if (!confirm('Delete this payment entry?')) return;
  await sb.from('build_payments').delete().eq('id', id);
  loadBuildSubTab('payments');
}

// â”€â”€ Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderBuildDocuments(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data } = await sb.from('build_documents')
    .select('*').eq('project_id', _currentBuildId).order('created_at', { ascending: false });
  el.innerHTML = `
    <div class="bg-white border rounded-xl p-5 shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-bold text-lg">Documents</h2>
        <label class="btn-primary px-3 py-1.5 text-sm rounded-lg cursor-pointer">
          + Upload <input type="file" accept=".pdf,.doc,.docx,.png,.jpg,image/*" multiple class="hidden" onchange="uploadBuildDocuments(this.files)"/>
        </label>
      </div>
      ${(data||[]).length ? `
        <div class="divide-y">
          ${(data||[]).map(d => `
            <div class="py-3 flex items-center gap-3">
              <span class="text-2xl">${d.file_type==='pdf'?'ğŸ“„':'ğŸ–¼'}</span>
              <div class="flex-1 min-w-0">
                <a href="${d.file_url}" target="_blank" class="font-semibold text-sm text-[var(--green)] hover:underline truncate block">${d.title||d.file_url}</a>
                <input value="${d.title||''}" placeholder="Labelâ€¦" class="text-xs border rounded px-2 py-1 w-full mt-1"
                  onblur="sb.from('build_documents').update({title:this.value}).eq('id','${d.id}')"/>
              </div>
              <button onclick="deleteBuildDocument('${d.id}')" class="text-red-400 hover:text-red-600 text-lg leading-none">&times;</button>
            </div>`).join('')}
        </div>` : '<p class="text-gray-400 text-sm">No documents uploaded yet.</p>'}
    </div>`;
}

async function uploadBuildDocuments(files) {
  for (const file of files) {
    const ext = file.name.split('.').pop().toLowerCase();
    const path = `${_currentBuildId}/${crypto.randomUUID()}.${ext}`;
    const { data: up } = await sb.storage.from('build-documents').upload(path, file, { upsert: true });
    if (!up) continue;
    const { data: { publicUrl } } = sb.storage.from('build-documents').getPublicUrl(path);
    const isImg = file.type.startsWith('image/');
    await sb.from('build_documents').insert({
      project_id: _currentBuildId, file_url: publicUrl,
      file_type: isImg ? 'image' : 'pdf', title: file.name
    });
  }
  loadBuildSubTab('documents');
}

async function deleteBuildDocument(id) {
  if (!confirm('Delete this document?')) return;
  await sb.from('build_documents').delete().eq('id', id);
  loadBuildSubTab('documents');
}

// â”€â”€ Build Messages (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _adminBuildMsgChannel = null;

async function renderBuildMessages(el) {
  if (_adminBuildMsgChannel) { sb.removeChannel(_adminBuildMsgChannel); _adminBuildMsgChannel = null; }
  el.innerHTML = '<p class="text-gray-400 text-sm">Loadingâ€¦</p>';
  const { data: msgs } = await sb.from('build_messages')
    .select('id, body, created_at, profiles(full_name, role)')
    .eq('project_id', _currentBuildId).order('created_at');
  const bubble = m => {
    const isAdmin = m.profiles?.role === 'admin';
    return `<div class="flex ${isAdmin?'justify-end':'justify-start'} mb-3">
      <div class="max-w-sm rounded-2xl px-4 py-2.5 ${isAdmin?'bg-[var(--green)] text-white':'bg-white border text-gray-900'}">
        <p class="text-xs font-semibold mb-1 ${isAdmin?'text-white/70':'text-gray-400'}">${escHtml(m.profiles?.full_name||(isAdmin?'Admin':'Customer'))}</p>
        <p class="text-sm leading-relaxed">${escHtml(m.body)}</p>
      </div>
    </div>`;
  };
  el.innerHTML = `
    <div class="bg-white border rounded-xl shadow-sm flex flex-col" style="height:55vh">
      <div id="adminBuildMsgList" class="flex-1 overflow-y-auto p-4">
        ${(msgs||[]).length ? msgs.map(bubble).join('') : '<p class="text-gray-400 text-sm text-center mt-8">No messages yet.</p>'}
      </div>
      <div class="border-t p-3 flex gap-2">
        <input id="adminBuildMsgInput" type="text" placeholder="Reply to customerâ€¦"
          class="flex-1 border rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-[var(--green)] outline-none"
          onkeydown="if(event.key==='Enter')sendAdminBuildMessage()"/>
        <button onclick="sendAdminBuildMessage()"
          class="bg-[var(--green)] text-white font-bold rounded-xl px-4 py-2.5 text-sm hover:bg-[var(--dark)] transition">Send</button>
      </div>
    </div>
  `;
  const listEl = document.getElementById('adminBuildMsgList');
  listEl.scrollTop = listEl.scrollHeight;
  _adminBuildMsgChannel = sb.channel('admin-build-msgs-'+_currentBuildId)
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'build_messages', filter: `project_id=eq.${_currentBuildId}` }, async payload => {
      const { data: m } = await sb.from('build_messages').select('id,body,created_at,profiles(full_name,role)').eq('id', payload.new.id).single();
      if (m) { listEl.innerHTML += bubble(m); listEl.scrollTop = listEl.scrollHeight; }
    }).subscribe();
}

async function sendAdminBuildMessage() {
  const input = document.getElementById('adminBuildMsgInput');
  const body = input.value.trim();
  if (!body) return;
  input.value = '';
  const { data: { user } } = await sb.auth.getUser();
  await sb.from('build_messages').insert({ project_id: _currentBuildId, sender_id: user.id, body });
}

// â”€â”€ Shared lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openImageLightbox(url, caption) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;';
  overlay.onclick = () => document.body.removeChild(overlay);
  overlay.innerHTML = `
    <img src="${url}" style="max-width:90vw;max-height:85vh;border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.6)"/>
    ${caption ? `<p style="color:#fff;margin-top:12px;font-size:14px;opacity:0.8;">${caption}</p>` : ''}
    <p style="color:#fff;margin-top:8px;font-size:12px;opacity:0.5;">Click anywhere to close</p>`;
  document.body.appendChild(overlay);
}

// â”€â”€â”€ SERVICE REQUESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _reqFilter = 'all';

async function renderRequests(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Service Requests</h1>
    </div>

    <!-- Status filter tabs -->
    <div class="flex gap-2 mb-5 flex-wrap" id="reqFilterTabs">
      ${['all','new','contacted','scheduled','declined'].map(s => `
        <button onclick="setReqFilter('${s}')" data-filter="${s}"
          class="req-tab px-4 py-1.5 rounded-full text-sm font-semibold border-2 ${s==='all'?'border-[var(--green)] text-[var(--green)]':'border-gray-200 text-gray-500'}">
          ${s === 'all' ? 'All' : s.charAt(0).toUpperCase()+s.slice(1)}
        </button>`).join('')}
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="reqTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Detail Modal -->
    <div id="reqModal" class="modal-bg hidden">
      <div class="modal max-w-lg">
        <div class="flex items-start justify-between mb-4">
          <div>
            <span id="reqModalTypeBadge"></span>
            <h2 class="text-2xl font-bold mt-1" id="reqModalName"></h2>
          </div>
          <button onclick="closeModal('reqModal')" class="text-gray-400 hover:text-gray-600 text-2xl leading-none ml-4">Ã—</button>
        </div>

        <!-- Contact info -->
        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mb-4" id="reqModalInfo"></div>

        <!-- Message -->
        <div id="reqModalMsgWrap" class="mb-4 hidden">
          <p class="text-xs font-semibold text-gray-500 uppercase mb-1">Message</p>
          <p id="reqModalMsg" class="text-sm text-gray-700 bg-gray-50 rounded p-3 whitespace-pre-wrap"></p>
        </div>

        <!-- Status + notes -->
        <div class="space-y-3 border-t pt-4">
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase block mb-1">Status</label>
            <select id="reqStatusSel" class="field">
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="scheduled">Scheduled</option>
              <option value="declined">Declined</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase block mb-1">Admin Notes</label>
            <textarea id="reqNotes" rows="3" class="field" placeholder="Internal notes..."></textarea>
          </div>
          <div class="flex gap-2 pt-1">
            <button onclick="saveReqChanges()" class="btn-green flex-1 py-2">Save</button>
            <button onclick="convertReqToCustomer()" class="btn-outline flex-1 py-2">Convert to Customer â†’</button>
          </div>
        </div>
      </div>
    </div>
  `;

  _reqFilter = 'all';
  loadReqTable();
}

function setReqFilter(filter) {
  _reqFilter = filter;
  document.querySelectorAll('.req-tab').forEach(b => {
    const active = b.dataset.filter === filter;
    b.classList.toggle('border-[var(--green)]', active);
    b.classList.toggle('text-[var(--green)]', active);
    b.classList.toggle('border-gray-200', !active);
    b.classList.toggle('text-gray-500', !active);
  });
  loadReqTable();
}

async function loadReqTable() {
  const el = document.getElementById('reqTableWrap');
  if (!el) return;
  el.innerHTML = '<p class="text-gray-400 text-sm p-2">Loading...</p>';

  let query = sb.from('service_requests').select('*').order('created_at', { ascending: false });
  if (_reqFilter !== 'all') query = query.eq('status', _reqFilter);

  const { data, error } = await query;
  if (error) { el.innerHTML = `<p class="text-red-500 p-2">${error.message}</p>`; return; }
  if (!data?.length) { el.innerHTML = '<p class="text-gray-400 p-4">No requests yet.</p>'; return; }

  const typeLabel = { routine_maintenance:'Routine Maintenance', one_time_cleaning:'One-Time Cleaning', install:'Install / Build', other:'Other' };
  const typeBadge = { routine_maintenance:'badge-blue', one_time_cleaning:'badge-green', install:'badge-yellow', other:'badge-gray' };
  const statusBadge = { new:'badge-blue', contacted:'badge-yellow', scheduled:'badge-green', declined:'badge-gray' };

  el.innerHTML = `<table>
    <thead><tr>
      <th>Type</th><th>Name</th><th>Contact</th><th>Location</th><th>Status</th><th>Received</th>
    </tr></thead>
    <tbody>
      ${data.map(r => `<tr class="cursor-pointer hover:bg-gray-50" onclick="openReqDetail('${r.id}')">
        <td><span class="badge ${typeBadge[r.type]||'badge-gray'}">${typeLabel[r.type]||r.type}</span></td>
        <td class="font-semibold">${escHtml(r.full_name)}</td>
        <td class="text-sm">
          ${r.email ? `<p>${escHtml(r.email)}</p>` : ''}
          ${r.phone ? `<p class="text-gray-500">${escHtml(r.phone)}</p>` : ''}
        </td>
        <td class="text-sm text-gray-500">${r.city ? escHtml(r.city) + (r.zip ? ', '+escHtml(r.zip) : '') : r.zip ? escHtml(r.zip) : 'â€”'}</td>
        <td><span class="badge ${statusBadge[r.status]||'badge-gray'}">${r.status}</span></td>
        <td class="text-xs text-gray-400">${new Date(r.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

let _currentReqId = null;

async function openReqDetail(id) {
  const { data: r } = await sb.from('service_requests').select('*').eq('id', id).single();
  if (!r) return;
  _currentReqId = r.id;

  const typeLabel = { routine_maintenance:'Routine Maintenance', one_time_cleaning:'One-Time Cleaning', install:'Install / Build', other:'Other' };
  const typeBadge = { routine_maintenance:'badge-blue', one_time_cleaning:'badge-green', install:'badge-yellow', other:'badge-gray' };
  const freqLabel = { weekly:'Weekly', biweekly:'Every Two Weeks', monthly:'Monthly' };

  document.getElementById('reqModalTypeBadge').innerHTML = `<span class="badge ${typeBadge[r.type]||'badge-gray'}">${typeLabel[r.type]||r.type}</span>`;
  document.getElementById('reqModalName').textContent = r.full_name;

  const rows = [
    r.email    ? ['Email', `<a href="mailto:${escHtml(r.email)}" class="text-[var(--green)] underline">${escHtml(r.email)}</a>`] : null,
    r.phone    ? ['Phone', `<a href="tel:${escHtml(r.phone)}" class="text-[var(--green)] underline">${escHtml(r.phone)}</a>`] : null,
    r.address  ? ['Address', escHtml([r.address, r.city, 'CA', r.zip].filter(Boolean).join(', '))] : null,
    r.project_type     ? ['Project Type', escHtml(r.project_type)] : null,
    r.service_frequency ? ['Frequency', freqLabel[r.service_frequency]||r.service_frequency] : null,
    ['Received', new Date(r.created_at).toLocaleString('en-US',{dateStyle:'medium',timeStyle:'short'})],
  ].filter(Boolean);

  document.getElementById('reqModalInfo').innerHTML = rows.map(([label, val]) =>
    `<div><p class="text-xs font-semibold text-gray-400 uppercase">${label}</p><p class="text-sm">${val}</p></div>`
  ).join('');

  const msgWrap = document.getElementById('reqModalMsgWrap');
  if (r.message) {
    document.getElementById('reqModalMsg').textContent = r.message;
    msgWrap.classList.remove('hidden');
  } else {
    msgWrap.classList.add('hidden');
  }

  document.getElementById('reqStatusSel').value = r.status || 'new';
  document.getElementById('reqNotes').value      = r.admin_notes || '';

  openModal('reqModal');
}

async function saveReqChanges() {
  if (!_currentReqId) return;
  const status      = document.getElementById('reqStatusSel').value;
  const admin_notes = document.getElementById('reqNotes').value;
  const { error } = await sb.from('service_requests').update({ status, admin_notes }).eq('id', _currentReqId);
  if (error) { toast(error.message, false); return; }
  toast('Request updated');
  closeModal('reqModal');
  loadReqTable();
}

function convertReqToCustomer() {
  if (!_currentReqId) return;
  // Switch to Customers page and pre-focus the invite form
  closeModal('reqModal');
  loadPage('customers');
  // Wait for customers page to render then click invite
  setTimeout(() => {
    const inviteBtn = document.querySelector('[onclick="openInviteModal()"]');
    if (inviteBtn) inviteBtn.click();
    // Pre-fill will need to be done manually â€” a future enhancement
  }, 400);
}

async function renderBilling(el) {
  el.innerHTML = '<p class="text-gray-400 text-sm">Loading...</p>';

  const { data: invoices, error } = await sb
    .from('monthly_invoices')
    .select('id, period_start, period_end, status, total_amount, stripe_invoice_id, sent_at, paid_at, created_at, service_accounts(id, contact_name, profiles(full_name))')
    .order('created_at', { ascending: false });

  if (error) { el.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`; return; }

  const failed = (invoices || []).filter(i => i.status === 'failed');
  const statusBadgeClass = { paid: 'badge-green', failed: 'badge-red', pending_charge: 'badge-yellow', open: 'badge-blue', void: 'badge-gray' };

  el.innerHTML = `
    <div class="flex items-start justify-between mb-6 flex-wrap gap-3">
      <div>
        <h1 class="text-3xl font-extrabold">Billing</h1>
        <p class="text-gray-500 text-sm mt-1">Auto-billed 1st of each month â€” prior month service + products</p>
      </div>
    </div>

    ${failed.length ? `
    <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
      <p class="font-bold text-red-700 mb-2">âš  ${failed.length} Failed Payment${failed.length > 1 ? 's' : ''}</p>
      ${failed.map(i => {
        const name = i.service_accounts?.profiles?.full_name || i.service_accounts?.contact_name || 'â€”';
        return `<p class="text-sm text-red-600">${escHtml(name)} â€” ${fmtDate(i.period_start)} &nbsp;Â·&nbsp; ${fmtMoney(i.total_amount)}</p>`;
      }).join('')}
    </div>` : ''}

    ${!(invoices?.length)
      ? `<div class="bg-white rounded-xl border p-8 text-center text-gray-400 text-sm">No invoices yet. Billing runs automatically on the 1st of each month.</div>`
      : `<div class="bg-white rounded-xl border overflow-hidden">
          <table>
            <thead><tr>
              <th>Customer</th><th>Period</th><th>Total</th><th>Status</th><th>Billed</th><th class="text-right">Stripe</th>
            </tr></thead>
            <tbody>
              ${invoices.map(i => {
                const name   = i.service_accounts?.profiles?.full_name || i.service_accounts?.contact_name || 'â€”';
                const period = `${fmtDate(i.period_start)} â€“ ${fmtDate(i.period_end)}`;
                const cls    = statusBadgeClass[i.status] || 'badge-gray';
                return `<tr class="${i.status === 'failed' ? 'bg-red-50' : ''}">
                  <td class="font-semibold">${escHtml(name)}</td>
                  <td class="text-gray-500 text-sm">${period}</td>
                  <td class="font-semibold">${fmtMoney(i.total_amount)}</td>
                  <td><span class="badge ${cls}">${i.status.replace('_',' ')}</span></td>
                  <td class="text-gray-400 text-sm">${fmtDate(i.sent_at || i.created_at)}</td>
                  <td class="text-right">
                    ${i.stripe_invoice_id
                      ? `<a href="https://dashboard.stripe.com/test/invoices/${i.stripe_invoice_id}" target="_blank" class="text-xs text-blue-600 underline">View â†—</a>`
                      : 'â€”'}
                  </td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`
    }
  `;
}

async function adminCreateStripeCustomer(accountId) {
  const { data: { session } } = await sb.auth.getSession();
  const res = await fetch('/.netlify/functions/stripe-admin', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
    body:    JSON.stringify({ action: 'create_customer', account_id: accountId }),
  });
  const json = await res.json();
  if (!res.ok) { toast(json.error || 'Error creating Stripe customer', false); return; }
  toast(json.existing ? 'Stripe customer already exists' : 'Stripe customer created');
  openCustomerDetail(accountId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES â€” Ticket inbox
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _activeTicketId = null;
let _msgChannel    = null;

const TICKET_CAT_LABEL = {
  upcoming_visit:'Upcoming Visit', product_inquiry:'Product Inquiry',
  billing_issue:'Billing Issue',   ask_tech:'Ask Tech',
  pond_emergency:'Pond Emergency'
};
const TICKET_CAT_BADGE = {
  upcoming_visit:'bg-blue-100 text-blue-800',
  product_inquiry:'bg-yellow-100 text-yellow-800',
  billing_issue:'bg-orange-100 text-orange-800',
  ask_tech:'bg-purple-100 text-purple-800',
  pond_emergency:'bg-red-100 text-red-800'
};

async function renderMessages(el) {
  if (_msgChannel) { sb.removeChannel(_msgChannel); _msgChannel = null; }
  _activeTicketId = null;
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Messages</h1>
    <div style="display:grid;grid-template-columns:300px 1fr;gap:1.5rem;height:calc(100vh - 13rem);">
      <div class="bg-white rounded-xl border flex flex-col overflow-hidden">
        <div class="p-3 border-b flex items-center justify-between">
          <span class="font-bold text-sm uppercase tracking-wide">Inbox</span>
          <select id="tFilter" class="text-xs border rounded px-1.5 py-1 outline-none"
                  onchange="refreshAdminTicketList()">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
            <option value="">All</option>
          </select>
        </div>
        <div id="ticketList" class="overflow-y-auto flex-1">
          <p class="p-4 text-gray-400 text-xs">Loading...</p>
        </div>
      </div>
      <div id="threadPanel" class="bg-white rounded-xl border flex flex-col overflow-hidden">
        <div class="flex-1 flex items-center justify-center text-gray-400 text-sm">
          Select a ticket to view the conversation
        </div>
      </div>
    </div>`;
  refreshAdminTicketList();
}

async function refreshAdminTicketList() {
  const listEl = document.getElementById('ticketList');
  if (!listEl) return;
  const filter = document.getElementById('tFilter')?.value ?? 'open';
  let q = sb.from('tickets')
    .select('id, category, subject, status, urgent, updated_at, service_accounts(contact_name, profiles(full_name))')
    .order('urgent', { ascending: false })
    .order('updated_at', { ascending: false });
  if (filter) q = q.eq('status', filter);
  const { data: tickets, error } = await q;
  if (error) { listEl.innerHTML = `<p class="p-4 text-red-500 text-xs">${error.message}</p>`; return; }
  if (!tickets?.length) { listEl.innerHTML = '<p class="p-4 text-gray-400 text-xs">No tickets.</p>'; return; }
  listEl.innerHTML = tickets.map(t => {
    const name = t.service_accounts?.contact_name || t.service_accounts?.profiles?.full_name || 'Unknown';
    const active = t.id === _activeTicketId;
    return `
      <div onclick="openAdminTicket('${t.id}')"
           class="p-3 border-b cursor-pointer hover:bg-gray-50 transition-colors
                  ${active ? 'bg-blue-50' : ''}
                  ${t.urgent ? 'border-l-4 border-l-red-500' : ''}">
        <div class="flex items-start justify-between gap-1">
          <span class="font-semibold text-sm leading-tight">${escHtml(name)}</span>
          <span class="text-xs text-gray-400 shrink-0 mt-0.5">${timeAgo(t.updated_at)}</span>
        </div>
        <p class="text-gray-600 text-xs mt-0.5 truncate">${escHtml(t.subject)}</p>
        <div class="flex items-center gap-1 mt-1.5 flex-wrap">
          <span class="text-xs px-1.5 py-0.5 rounded font-semibold ${TICKET_CAT_BADGE[t.category]||'bg-gray-100 text-gray-600'}">${TICKET_CAT_LABEL[t.category]||t.category}</span>
          ${t.urgent ? '<span class="text-xs px-1.5 py-0.5 rounded font-bold bg-red-500 text-white">URGENT</span>' : ''}
          ${t.status === 'closed' ? '<span class="text-xs px-1.5 py-0.5 rounded bg-gray-200 text-gray-500">Closed</span>' : ''}
        </div>
      </div>`;
  }).join('');
}

async function openAdminTicket(ticketId) {
  _activeTicketId = ticketId;
  refreshAdminTicketList();
  const panel = document.getElementById('threadPanel');
  if (!panel) return;
  panel.innerHTML = '<div class="flex-1 flex items-center justify-center text-gray-400 text-sm">Loading...</div>';

  const { data: ticket } = await sb.from('tickets')
    .select('id, category, subject, status, urgent, service_accounts(contact_name, profiles(full_name))')
    .eq('id', ticketId).single();
  const { data: msgs } = await sb.from('ticket_messages')
    .select('id, content, created_at, profiles(full_name, role)')
    .eq('ticket_id', ticketId)
    .order('created_at', { ascending: true });

  const name = ticket.service_accounts?.contact_name || ticket.service_accounts?.profiles?.full_name || 'Unknown';
  const isClosed = ticket.status === 'closed';

  const bubbles = (arr) => (arr || []).map(m => {
    const isAdmin = m.profiles?.role === 'admin';
    return `
      <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
        <div class="max-w-xs lg:max-w-sm rounded-2xl px-4 py-2.5 ${isAdmin ? 'bg-[var(--green)] text-white' : 'bg-gray-100 text-gray-900'}">
          <p class="text-xs font-semibold mb-1 ${isAdmin?'text-white/70':'text-gray-400'}">${escHtml(m.profiles?.full_name||(isAdmin?'Admin':'Customer'))}</p>
          <p class="text-sm leading-relaxed">${escHtml(m.content)}</p>
          <p class="text-xs mt-1.5 ${isAdmin?'text-white/50':'text-gray-400'}">${timeAgo(m.created_at)}</p>
        </div>
      </div>`;
  }).join('');

  panel.innerHTML = `
    <div class="p-4 border-b flex items-start justify-between gap-3 shrink-0">
      <div class="min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <h3 class="font-bold">${escHtml(ticket.subject)}</h3>
          ${ticket.urgent ? '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500 text-white font-bold">URGENT</span>' : ''}
        </div>
        <p class="text-xs text-gray-500 mt-0.5">${escHtml(name)} Â· ${TICKET_CAT_LABEL[ticket.category]||ticket.category}</p>
      </div>
      <button onclick="adminToggleTicket('${ticket.id}','${ticket.status}')"
              class="btn-outline text-xs shrink-0">
        ${isClosed ? 'Reopen' : 'Close Ticket'}
      </button>
    </div>
    <div id="msgThread" class="flex-1 overflow-y-auto p-4 space-y-3">
      ${bubbles(msgs)}
    </div>
    <div class="p-4 border-t shrink-0 ${isClosed ? 'bg-gray-50' : ''}">
      ${isClosed
        ? '<p class="text-xs text-center text-gray-400">This ticket is closed. Reopen to reply.</p>'
        : `<textarea id="replyText" class="field w-full text-sm resize-none" rows="3"
                    placeholder="Write a reply..."></textarea>
           <div class="flex justify-end mt-2">
             <button onclick="adminSendReply('${ticket.id}')" class="btn-green text-sm">Send Reply</button>
           </div>`
      }
    </div>`;

  const thread = document.getElementById('msgThread');
  if (thread) thread.scrollTop = thread.scrollHeight;

  if (_msgChannel) { sb.removeChannel(_msgChannel); _msgChannel = null; }
  _msgChannel = sb.channel(`admin-ticket-${ticketId}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'ticket_messages',
      filter: `ticket_id=eq.${ticketId}`
    }, async (payload) => {
      const { data: m } = await sb.from('ticket_messages')
        .select('id, content, created_at, profiles(full_name, role)')
        .eq('id', payload.new.id).single();
      if (!m) return;
      const thread = document.getElementById('msgThread');
      if (!thread) return;
      const isAdmin = m.profiles?.role === 'admin';
      const div = document.createElement('div');
      div.className = `flex ${isAdmin ? 'justify-end' : 'justify-start'}`;
      div.innerHTML = `
        <div class="max-w-xs lg:max-w-sm rounded-2xl px-4 py-2.5 ${isAdmin ? 'bg-[var(--green)] text-white' : 'bg-gray-100 text-gray-900'}">
          <p class="text-xs font-semibold mb-1 ${isAdmin?'text-white/70':'text-gray-400'}">${escHtml(m.profiles?.full_name||(isAdmin?'Admin':'Customer'))}</p>
          <p class="text-sm leading-relaxed">${escHtml(m.content)}</p>
          <p class="text-xs mt-1.5 ${isAdmin?'text-white/50':'text-gray-400'}">${timeAgo(m.created_at)}</p>
        </div>`;
      thread.appendChild(div);
      thread.scrollTop = thread.scrollHeight;
      refreshAdminTicketList();
    })
    .subscribe();
}

async function adminSendReply(ticketId) {
  const textEl = document.getElementById('replyText');
  const content = textEl?.value?.trim();
  if (!content) return;
  const { data: { user } } = await sb.auth.getUser();
  const { error } = await sb.from('ticket_messages').insert({ ticket_id: ticketId, sender_id: user.id, content });
  if (error) { toast(error.message, false); return; }
  textEl.value = '';
}

async function adminToggleTicket(ticketId, currentStatus) {
  const newStatus = currentStatus === 'open' ? 'closed' : 'open';
  const { error } = await sb.from('tickets').update({ status: newStatus }).eq('id', ticketId);
  if (error) { toast(error.message, false); return; }
  toast(`Ticket ${newStatus}`);
  openAdminTicket(ticketId);
}

// â”€â”€â”€ MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id)?.classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }

// Close modal on backdrop click
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-bg')) {
    e.target.classList.add('hidden');
  }
});

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>

<!-- Equipment Modal -->
<div id="equipmentModal" class="modal-bg hidden">
  <div class="modal max-w-lg">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold" id="eqModalTitle">Add Equipment</h2>
      <button onclick="closeModal('equipmentModal')" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
    </div>
    <!-- Photo -->
    <div class="mb-4">
      <p class="text-xs font-semibold text-gray-500 uppercase mb-2">Photo</p>
      <div class="w-full h-40 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl overflow-hidden relative flex items-center justify-center">
        <span id="eqPhotoPlaceholder" class="text-gray-300 text-5xl">ğŸ”§</span>
        <img id="eqPhotoImg" class="hidden absolute inset-0 w-full h-full object-cover"/>
      </div>
      <label class="btn-outline text-sm mt-2 w-full text-center cursor-pointer block">
        Upload Photo <input type="file" accept="image/*" class="hidden" onchange="eqHandlePhoto(this.files[0])"/>
      </label>
    </div>
    <!-- Name -->
    <div class="mb-3">
      <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Name *</label>
      <input id="eqName" type="text" placeholder="e.g. Aquascape Pond Pump" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--green)] outline-none"/>
    </div>
    <!-- Brand / Model -->
    <div class="grid grid-cols-2 gap-3 mb-3">
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Brand</label>
        <input id="eqBrand" type="text" placeholder="Aquascape" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--green)] outline-none"/>
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Model</label>
        <input id="eqModel" type="text" placeholder="AquaSurge 2000" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-[var(--green)] outline-none"/>
      </div>
    </div>
    <!-- Serial Number -->
    <div class="mb-4">
      <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Serial Number</label>
      <input id="eqSerial" type="text" placeholder="SN-XXXXXXXX" class="w-full border rounded-lg px-3 py-2 text-sm font-mono focus:ring-2 focus:ring-[var(--green)] outline-none"/>
    </div>
    <!-- Warranty -->
    <div class="border rounded-xl p-4 mb-4 bg-gray-50">
      <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Warranty</p>
      <div class="mb-2">
        <label class="block text-xs text-gray-500 mb-1">Provider</label>
        <input id="eqWarrantyProvider" type="text" placeholder="e.g. Aquascape Inc." class="w-full border rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-[var(--green)] outline-none"/>
      </div>
      <div class="mb-2">
        <label class="block text-xs text-gray-500 mb-1">Expires</label>
        <input id="eqWarrantyExpires" type="date" class="w-full border rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-[var(--green)] outline-none"/>
      </div>
      <div>
        <label class="block text-xs text-gray-500 mb-1">Notes</label>
        <textarea id="eqWarrantyNotes" rows="2" placeholder="Coverage details, exclusionsâ€¦" class="w-full border rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-[var(--green)] outline-none resize-none"></textarea>
      </div>
    </div>
    <!-- Documents (edit only) -->
    <div id="eqDocsSection" class="hidden mb-4">
      <p class="text-xs font-semibold text-gray-500 uppercase mb-2">Documents</p>
      <div id="eqDocsList" class="space-y-2 mb-2"></div>
      <label class="btn-outline text-sm cursor-pointer block text-center">
        + Upload Document <input type="file" accept="application/pdf,image/*,.doc,.docx" class="hidden" onchange="eqUploadDoc(this.files[0])"/>
      </label>
    </div>
    <div class="flex gap-3 pt-2">
      <button onclick="closeModal('equipmentModal')" class="btn-outline flex-1">Cancel</button>
      <button onclick="saveEquipment()" class="btn-primary flex-1">Save</button>
    </div>
  </div>
</div>
</body>
</html>
