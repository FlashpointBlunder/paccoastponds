<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Pacific Coast Ponds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabase.js"></script>
  <style>
    :root{ --green:#1E5E37; --blue:#2CA7DF; --dark:#0F1C12; }
    body { font-family: Inter, ui-sans-serif, system-ui; }
    h1,h2,h3 { font-family: Oswald, sans-serif; text-transform: uppercase; letter-spacing: .5px; }
    .sidebar-link { display:flex; align-items:center; gap:.75rem; padding:.65rem 1rem; border-radius:.5rem; font-weight:600; font-size:.9rem; color:rgba(255,255,255,.75); transition:background .15s; cursor:pointer; }
    .sidebar-link:hover, .sidebar-link.active { background:rgba(255,255,255,.12); color:#fff; }
    .stat-card { background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1.5rem; }
    .btn-green { background:var(--green); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; transition:background .15s; }
    .btn-green:hover { background:var(--dark); }
    .btn-blue { background:var(--blue); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; }
    .btn-outline { border:2px solid #e5e7eb; background:#fff; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; font-size:.85rem; cursor:pointer; }
    .btn-outline:hover { border-color:#9ca3af; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; display:flex; align-items:center; justify-content:center; padding:1rem; }
    .modal { background:#fff; border-radius:.75rem; box-shadow:0 25px 50px rgba(0,0,0,.25); width:100%; max-width:32rem; max-height:90vh; overflow-y:auto; padding:1.5rem; }
    .field { width:100%; padding:.65rem .75rem; border:2px solid #e5e7eb; border-radius:.5rem; font-size:.9rem; outline:none; }
    .field:focus { border-color:var(--green); }
    .badge { display:inline-block; padding:.2rem .65rem; border-radius:9999px; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.4px; }
    .badge-green  { background:#dcfce7; color:#166534; }
    .badge-blue   { background:#dbeafe; color:#1e40af; }
    .badge-gray   { background:#f3f4f6; color:#6b7280; }
    .badge-yellow { background:#fef9c3; color:#854d0e; }
    table { width:100%; border-collapse:collapse; }
    th { text-align:left; font-size:.7rem; text-transform:uppercase; letter-spacing:.5px; color:#9ca3af; padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
    td { padding:.75rem; border-bottom:1px solid #f3f4f6; font-size:.875rem; vertical-align:middle; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:#f9fafb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center bg-[var(--dark)]">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
    <img src="https://paccoastponds.com/assets/logo.webp" alt="Pacific Coast Ponds" class="h-12 mx-auto mb-6">
    <h1 class="text-2xl text-center mb-6">Admin Login</h1>
    <form id="loginForm" class="space-y-4">
      <input id="loginEmail"    type="email"    placeholder="Email"    required class="field" />
      <input id="loginPassword" type="password" placeholder="Password" required class="field" />
      <button type="submit" class="btn-green w-full py-3 text-base">Sign In</button>
    </form>
    <p id="loginError" class="mt-3 text-red-600 text-sm text-center hidden"></p>
  </div>
</div>

<!-- â”€â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="appShell" class="hidden min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-56 bg-[var(--dark)] flex flex-col fixed inset-y-0 left-0 z-30">
    <div class="p-5 border-b border-white/10">
      <p class="text-white font-bold uppercase text-sm">Pacific Coast Ponds</p>
      <p class="text-white/40 text-xs mt-0.5">Admin</p>
    </div>
    <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
      <div class="sidebar-link active" data-page="dashboard">âŠ &nbsp;Dashboard</div>
      <div class="sidebar-link" data-page="customers">ğŸ‘¤ &nbsp;Customers</div>
      <div class="sidebar-link" data-page="schedule">ğŸ“… &nbsp;Schedule</div>
      <div class="sidebar-link" data-page="techs">ğŸ”§ &nbsp;Technicians</div>
      <div class="sidebar-link" data-page="products">ğŸ“¦ &nbsp;Products</div>
      <div class="sidebar-link" data-page="billing">ğŸ’³ &nbsp;Billing</div>
      <div class="sidebar-link" data-page="messages">ğŸ’¬ &nbsp;Messages</div>
    </nav>
    <div class="p-3 border-t border-white/10">
      <div id="logoutBtn" class="sidebar-link">â†’ &nbsp;Sign Out</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="ml-56 flex-1 p-8 overflow-y-auto min-h-screen">
    <div id="pageContent"></div>
  </main>
</div>

<script>
// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}
function fmtMoney(n) { return n != null ? '$' + parseFloat(n).toFixed(2) : 'â€”'; }
function timeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
  if (diff < 60)    return 'just now';
  if (diff < 3600)  return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}
function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function show(id)  { const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
function hide(id)  { const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
function toast(msg, ok=true) {
  const t = document.createElement('div');
  t.className = `fixed bottom-6 right-6 z-[100] px-5 py-3 rounded-lg text-white font-semibold shadow-xl ${ok?'bg-green-600':'bg-red-600'}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    const { data: p } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
    if (p?.role === 'admin') { showApp(); return; }
    await sb.auth.signOut();
  }
  showLogin();
}

function showLogin() {
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('appShell').classList.add('hidden');
}
function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  loadPage('dashboard');
}

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');
  const { error } = await sb.auth.signInWithPassword({
    email: document.getElementById('loginEmail').value,
    password: document.getElementById('loginPassword').value
  });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  checkAuth();
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await sb.auth.signOut(); showLogin();
});

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('[data-page]').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('[data-page]').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
    loadPage(el.dataset.page);
  });
});

function loadPage(page) {
  const pages = {
    dashboard: renderDashboard,
    customers: renderCustomers,
    schedule:  renderSchedule,
    techs:     renderTechs,
    products:  renderProducts,
    billing:   renderBilling,
    messages:  renderMessages,
  };
  const el = document.getElementById('pageContent');
  if (pages[page]) pages[page](el);
}

// â”€â”€â”€ INVITE HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callInvite(email, full_name, phone, role, service_account_id) {
  const { data: { session } } = await sb.auth.getSession();
  const res = await fetch('/.netlify/functions/invite-user', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({ email, full_name, phone, role, service_account_id })
  });
  const json = await res.json();
  if (!res.ok) throw new Error(json.error || 'Invite failed');
  return json;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDashboard(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-8">Dashboard</h1>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Active Customers</p><p class="text-4xl font-bold mt-2" id="sC">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Visits This Week</p><p class="text-4xl font-bold mt-2" id="sV">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Technicians</p><p class="text-4xl font-bold mt-2" id="sT">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Open Tickets</p><p class="text-4xl font-bold mt-2" id="sM">â€”</p></div>
    </div>
    <div class="bg-white rounded-xl border p-6">
      <h2 class="text-xl font-bold mb-4">Upcoming Visits</h2>
      <div id="upcomingList" class="text-gray-400 text-sm">Loading...</div>
    </div>
  `;

  const now = new Date();
  const week = new Date(now); week.setDate(now.getDate() + 7);

  const [cRes, vRes, tRes, mRes] = await Promise.all([
    sb.from('service_accounts').select('id', { count:'exact', head:true }).not('customer_id','is',null),
    sb.from('service_visits').select('id', { count:'exact', head:true }).gte('scheduled_date', now.toISOString()).lte('scheduled_date', week.toISOString()),
    sb.from('technicians').select('id', { count:'exact', head:true }),
    sb.from('tickets').select('id', { count:'exact', head:true }).eq('status', 'open'),
  ]);

  if (document.getElementById('sC')) {
    document.getElementById('sC').textContent = cRes.count ?? 0;
    document.getElementById('sV').textContent = vRes.count ?? 0;
    document.getElementById('sT').textContent = tRes.count ?? 0;
    document.getElementById('sM').textContent = mRes.count ?? 0;
  }

  const { data: upcoming } = await sb.from('service_visits')
    .select('id, scheduled_date, status, service_accounts(contact_name, profiles(full_name)), technicians(profiles(full_name))')
    .gte('scheduled_date', now.toISOString())
    .order('scheduled_date', { ascending: true })
    .limit(8);

  const uvEl = document.getElementById('upcomingList');
  if (!uvEl) return;
  if (!upcoming?.length) { uvEl.innerHTML = '<p class="text-gray-400">No upcoming visits scheduled.</p>'; return; }
  uvEl.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Status</th></tr></thead>
    <tbody>${upcoming.map(v => `<tr>
      <td>${fmtDate(v.scheduled_date)}</td>
      <td class="font-medium">${v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”'}</td>
      <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
      <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderCustomers(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Customers</h1>
      <button class="btn-green" onclick="openModal('addCustomerModal')">+ Add Customer</button>
    </div>
    <div class="flex gap-2 mb-4" id="custFilterBar">
      <button class="filter-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" data-filter="active" onclick="setCustFilter(this,'active')">Active</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="all" onclick="setCustFilter(this,'all')">All</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="inactive" onclick="setCustFilter(this,'inactive')">Inactive</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="invited" onclick="setCustFilter(this,'invited')">Invited</button>
      <button class="filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" data-filter="not_invited" onclick="setCustFilter(this,'not_invited')">Not Invited</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="customerTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Customer</h2>
        <form id="addCustomerForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <input name="contact_name"  placeholder="Full Name *" required class="field col-span-2" />
            <input name="contact_email" type="email" placeholder="Email *" required class="field" />
            <input name="contact_phone" type="tel" placeholder="Phone" class="field" />
          </div>
          <input name="address" placeholder="Service Address" class="field" />
          <input name="billing_address" placeholder="Billing Address (leave blank if same as service)" class="field" />
          <label class="flex items-center gap-3 py-1 cursor-pointer select-none">
            <input type="checkbox" name="is_subscription" id="addSubCheck"
                   onchange="document.getElementById('addFeeWrap').classList.toggle('hidden',!this.checked)"
                   class="w-4 h-4 rounded accent-[var(--green)]" />
            <span class="text-sm font-medium text-gray-700">Monthly Subscription</span>
          </label>
          <div id="addFeeWrap" class="hidden">
            <input name="monthly_service_fee" type="number" step="0.01" min="0"
                   placeholder="Monthly Service Fee ($)" class="field" />
          </div>
          <textarea name="pond_notes" rows="2" placeholder="Pond notes (size, fish count...)" class="field"></textarea>
          <textarea name="equipment_notes" rows="2" placeholder="Equipment (pump model, filter type, UV, aerator...)" class="field"></textarea>
          <p class="text-xs text-gray-400">No account invite will be sent yet. You control when that happens.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Customer</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addCustomerModal')">Cancel</button>
          </div>
          <p id="addCustErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadCustomerTable('active');

  document.getElementById('addCustomerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addCustErr');
    errEl.classList.add('hidden');
    const isSub = document.getElementById('addSubCheck').checked;
    const { error } = await sb.from('service_accounts').insert({
      contact_name:        fd.get('contact_name'),
      contact_email:       fd.get('contact_email'),
      contact_phone:       fd.get('contact_phone'),
      address:             fd.get('address'),
      billing_address:     fd.get('billing_address') || null,
      is_subscription:     isSub,
      monthly_service_fee: isSub ? (parseFloat(fd.get('monthly_service_fee')) || 0) : 0,
      pond_notes:          fd.get('pond_notes') || null,
      equipment_notes:     fd.get('equipment_notes') || null,
    });
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addCustomerModal');
    e.target.reset();
    document.getElementById('addFeeWrap').classList.add('hidden');
    toast('Customer added');
    loadCustomerTable();
  });
}

let _custFilter = 'active';
function setCustFilter(btn, filter) {
  _custFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadCustomerTable(filter);
}

async function loadCustomerTable(filter = _custFilter) {
  let query = sb.from('service_accounts')
    .select('id, active, contact_name, contact_email, contact_phone, address, is_subscription, monthly_service_fee, invite_sent_at, customer_id, profiles(full_name)')
    .order('created_at', { ascending: false });

  if (filter === 'active')      query = query.eq('active', true).not('customer_id', 'is', null);
  if (filter === 'inactive')    query = query.eq('active', false);
  if (filter === 'invited')     query = query.eq('active', true).not('invite_sent_at', 'is', null).is('customer_id', null);
  if (filter === 'not_invited') query = query.is('invite_sent_at', null);

  const { data, error } = await query;

  const el = document.getElementById('customerTableWrap');
  if (!el) return;
  if (error) { el.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`; return; }
  if (!data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No customers yet.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr>
      <th>Name</th><th>Email</th><th>Phone</th><th>Service Address</th><th>Plan</th><th>Status</th>
    </tr></thead>
    <tbody>
      ${data.map(c => {
        const name  = c.profiles?.full_name || c.contact_name  || 'â€”';
        const email = c.contact_email || 'â€”';
        const phone = c.contact_phone || 'â€”';
        let badge, statusLabel;
        if (!c.active)             { badge = 'badge-gray';   statusLabel = 'Inactive'; }
        else if (c.customer_id)    { badge = 'badge-green';  statusLabel = 'Active'; }
        else if (c.invite_sent_at) { badge = 'badge-yellow'; statusLabel = 'Invited'; }
        else                       { badge = 'badge-gray';   statusLabel = 'Not Invited'; }
        const plan = c.is_subscription
          ? `<span class="badge badge-green">${fmtMoney(c.monthly_service_fee)}/mo</span>`
          : '<span class="text-gray-400 text-xs">One-off</span>';
        return `<tr class="cursor-pointer" onclick="openCustomerDetail('${c.id}')">
          <td class="font-semibold">${name}</td>
          <td class="text-gray-500">${email}</td>
          <td class="text-gray-500">${phone}</td>
          <td class="text-gray-500">${c.address || 'â€”'}</td>
          <td>${plan}</td>
          <td><span class="badge ${badge}">${statusLabel}</span></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function sendCustomerInvite(saId, email, name, phone) {
  const label = document.getElementById('inviteBtnLabel')?.textContent || 'Send Invite';
  if (!confirm(`${label} to ${email}?`)) return;
  try {
    await callInvite(email, name, phone, 'customer', saId);
    toast('Invite sent to ' + email);
    openCustomerDetail(saId);
  } catch(err) {
    toast(err.message, false);
  }
}

// â”€â”€â”€ CUSTOMER DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _currentAccountId = null;

async function openCustomerDetail(accountId) {
  _currentAccountId = accountId;
  const el = document.getElementById('pageContent');
  el.innerHTML = '<p class="text-gray-400">Loading...</p>';

  const { data: c, error } = await sb.from('service_accounts')
    .select('id, active, contact_name, contact_email, contact_phone, address, billing_address, is_subscription, monthly_service_fee, pond_notes, equipment_notes, invite_sent_at, customer_id, created_at, profiles(full_name, email, phone)')
    .eq('id', accountId)
    .single();

  if (error || !c) { el.innerHTML = `<p class="text-red-500">Error: ${error?.message}</p>`; return; }

  const { data: visits } = await sb.from('service_visits')
    .select('id, scheduled_date, status, notes, technicians(profiles(full_name))')
    .eq('service_account_id', accountId)
    .order('scheduled_date', { ascending: false })
    .limit(10);

  const name  = c.profiles?.full_name || c.contact_name  || 'â€”';
  const email = c.profiles?.email     || c.contact_email || 'â€”';
  const phone = c.profiles?.phone     || c.contact_phone || 'â€”';
  const canInvite = !c.customer_id && c.contact_email;
  const inviteLabel = c.invite_sent_at ? 'Resend Invite' : 'Send Invite';

  let statusBadge;
  if (!c.active)             statusBadge = '<span class="badge badge-gray">Inactive</span>';
  else if (c.customer_id)    statusBadge = '<span class="badge badge-green">Active</span>';
  else if (c.invite_sent_at) statusBadge = '<span class="badge badge-yellow">Invited</span>';
  else                       statusBadge = '<span class="badge badge-gray">Not Invited</span>';

  const toggleLabel = c.active ? 'Mark Inactive' : 'Reactivate';
  const toggleClass = c.active ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700';

  el.innerHTML = `
    <!-- Back + actions -->
    <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
      <button onclick="loadPage('customers')" class="text-sm text-gray-500 hover:text-gray-900 font-semibold">
        â† Back to Customers
      </button>
      <div class="flex gap-2 flex-wrap">
        ${canInvite ? `<button class="btn-blue" onclick="sendCustomerInvite('${c.id}','${c.contact_email}','${(c.contact_name||'').replace(/'/g,"\\'")}','${(c.contact_phone||'')}')"><span id="inviteBtnLabel">${inviteLabel}</span></button>` : ''}
        <button class="btn-green" onclick="openEditCustomer()">Edit</button>
        <button class="px-4 py-2 ${toggleClass} text-white rounded-lg font-bold text-sm uppercase" onclick="toggleCustomerActive('${c.id}', ${c.active})">${toggleLabel}</button>
        <button class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm uppercase hover:bg-red-700" onclick="deleteCustomer('${c.id}','${c.customer_id||''}')">Delete</button>
      </div>
    </div>

    <!-- Header card -->
    <div class="bg-white rounded-xl border p-6 mb-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-3xl font-extrabold">${escHtml(name)}</h1>
          <p class="text-gray-500 mt-1">${escHtml(email)}</p>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          ${c.is_subscription ? '<span class="badge badge-green">Subscription</span>' : '<span class="badge badge-gray">One-off</span>'}
          ${statusBadge}
        </div>
      </div>
    </div>

    <!-- Info grid -->
    <div class="grid md:grid-cols-2 gap-5 mb-5">
      <div class="bg-white rounded-xl border p-5">
        <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Contact</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between"><span class="text-gray-500">Phone</span><span class="font-medium">${escHtml(phone)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Email</span><span class="font-medium">${escHtml(email)}</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Customer since</span><span class="font-medium">${fmtDate(c.created_at)}</span></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border p-5">
        <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Service &amp; Billing</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between gap-2"><span class="text-gray-500 shrink-0">Service Address</span><span class="font-medium text-right">${escHtml(c.address || 'â€”')}</span></div>
          <div class="flex justify-between gap-2"><span class="text-gray-500 shrink-0">Billing Address</span><span class="font-medium text-right">${c.billing_address ? escHtml(c.billing_address) : '<span class="text-gray-400">Same as service</span>'}</span></div>
          ${c.is_subscription ? `<div class="flex justify-between pt-1 border-t"><span class="text-gray-500">Monthly Fee</span><span class="font-bold text-lg text-[var(--green)]">${fmtMoney(c.monthly_service_fee)}/mo</span></div>` : ''}
        </div>
      </div>
    </div>

    <!-- Pond notes -->
    ${c.pond_notes ? `
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Pond Notes</h3>
      <p class="text-sm text-gray-700 whitespace-pre-wrap">${escHtml(c.pond_notes)}</p>
    </div>` : ''}

    <!-- Equipment -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Equipment</h3>
      ${c.equipment_notes
        ? `<p class="text-sm text-gray-700 whitespace-pre-wrap">${escHtml(c.equipment_notes)}</p>`
        : '<p class="text-gray-400 text-sm">No equipment recorded. Click Edit to add.</p>'}
    </div>

    <!-- Pond Photos -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xs font-bold uppercase text-gray-400">Pond Photos</h3>
        <label class="btn-outline text-xs cursor-pointer" id="uploadPhotoBtn">
          + Upload Photos
          <input type="file" class="hidden" multiple accept="image/*"
                 onchange="uploadPondPhotos(this)">
        </label>
      </div>
      <div id="pondPhotosGrid" class="grid grid-cols-3 gap-3">
        <p class="text-gray-400 text-sm col-span-3">Loading photos...</p>
      </div>
    </div>

    <!-- Visit history -->
    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-4">Service History</h3>
      ${!visits?.length ? '<p class="text-gray-400 text-sm">No visits yet.</p>' : `
      <table>
        <thead><tr><th>Date</th><th>Tech</th><th>Notes</th><th>Status</th></tr></thead>
        <tbody>
          ${visits.map(v => `<tr>
            <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
            <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
            <td class="text-gray-400 text-xs max-w-xs truncate">${escHtml(v.notes || '')}</td>
            <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
          </tr>`).join('')}
        </tbody>
      </table>`}
    </div>

    <!-- Edit Modal -->
    <div id="editCustomerModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Edit Customer</h2>
        <form id="editCustomerForm" class="space-y-3">
          <input name="contact_name" class="field" placeholder="Full Name" value="${escHtml(c.contact_name || '')}" />
          <div class="grid grid-cols-2 gap-3">
            <input name="contact_email" type="email" class="field" placeholder="Email" value="${escHtml(c.contact_email || '')}" />
            <input name="contact_phone" type="tel"   class="field" placeholder="Phone" value="${escHtml(c.contact_phone || '')}" />
          </div>
          <input name="address" class="field" placeholder="Service Address" value="${escHtml(c.address || '')}" />
          <input name="billing_address" class="field" placeholder="Billing Address (leave blank if same as service)" value="${escHtml(c.billing_address || '')}" />
          <label class="flex items-center gap-3 py-1 cursor-pointer select-none">
            <input type="checkbox" name="is_subscription" id="editSubCheck"
                   ${c.is_subscription ? 'checked' : ''}
                   onchange="document.getElementById('editFeeWrap').classList.toggle('hidden',!this.checked)"
                   class="w-4 h-4 rounded accent-[var(--green)]" />
            <span class="text-sm font-medium text-gray-700">Monthly Subscription</span>
          </label>
          <div id="editFeeWrap" class="${c.is_subscription ? '' : 'hidden'}">
            <input name="monthly_service_fee" type="number" step="0.01" min="0"
                   class="field" placeholder="Monthly Fee ($)" value="${c.monthly_service_fee || ''}" />
          </div>
          <textarea name="pond_notes" rows="2" class="field" placeholder="Pond notes...">${escHtml(c.pond_notes || '')}</textarea>
          <textarea name="equipment_notes" rows="2" class="field" placeholder="Equipment (pump model, filter type, UV, aerator...)">${escHtml(c.equipment_notes || '')}</textarea>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Changes</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('editCustomerModal')">Cancel</button>
          </div>
          <p id="editCustErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadPondPhotos(accountId);

  document.getElementById('editCustomerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('editCustErr');
    errEl.classList.add('hidden');
    const isSub = document.getElementById('editSubCheck').checked;
    const { error } = await sb.from('service_accounts').update({
      contact_name:        fd.get('contact_name'),
      contact_email:       fd.get('contact_email'),
      contact_phone:       fd.get('contact_phone'),
      address:             fd.get('address'),
      billing_address:     fd.get('billing_address') || null,
      is_subscription:     isSub,
      monthly_service_fee: isSub ? (parseFloat(fd.get('monthly_service_fee')) || 0) : 0,
      pond_notes:          fd.get('pond_notes') || null,
      equipment_notes:     fd.get('equipment_notes') || null,
    }).eq('id', accountId);
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('editCustomerModal');
    toast('Customer updated');
    openCustomerDetail(accountId);
  });
}

function openEditCustomer() { openModal('editCustomerModal'); }

// â”€â”€â”€ POND PHOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPondPhotos(accountId) {
  const gridEl = document.getElementById('pondPhotosGrid');
  if (!gridEl) return;

  const { data: files, error } = await sb.storage
    .from('pond-photos')
    .list(accountId, { sortBy: { column: 'created_at', order: 'desc' } });

  if (error) { gridEl.innerHTML = `<p class="text-red-500 text-sm col-span-3">${error.message}</p>`; return; }
  if (!files?.length) { gridEl.innerHTML = '<p class="text-gray-400 text-sm col-span-3">No photos yet.</p>'; return; }

  const urlResults = await Promise.all(
    files.map(f => sb.storage.from('pond-photos').createSignedUrl(`${accountId}/${f.name}`, 3600))
  );

  gridEl.innerHTML = files.map((f, i) => {
    const url = urlResults[i]?.data?.signedUrl || '';
    const path = `${accountId}/${f.name}`;
    return `
      <div class="relative group rounded-xl overflow-hidden bg-gray-100" style="aspect-ratio:1">
        <img src="${url}" class="w-full h-full object-cover" loading="lazy" />
        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 p-2">
          <a href="${url}" target="_blank"
             class="text-white text-xs font-bold px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition">
            View Full
          </a>
          <button onclick="deletePondPhoto('${path}')"
                  class="text-white text-xs font-bold px-3 py-1.5 bg-red-500/80 rounded-lg hover:bg-red-600/80 transition">
            Delete
          </button>
        </div>
      </div>`;
  }).join('');
}

async function uploadPondPhotos(input) {
  const files = Array.from(input.files);
  if (!files.length || !_currentAccountId) return;
  const labelEl = document.getElementById('uploadPhotoBtn');
  if (labelEl) labelEl.textContent = `Uploading ${files.length} photo${files.length>1?'s':''}...`;

  await Promise.all(files.map(f => {
    const ext = f.name.split('.').pop().toLowerCase();
    const path = `${_currentAccountId}/${crypto.randomUUID()}.${ext}`;
    return sb.storage.from('pond-photos').upload(path, f);
  }));

  input.value = '';
  if (labelEl) labelEl.innerHTML = '+ Upload Photos<input type="file" class="hidden" multiple accept="image/*" onchange="uploadPondPhotos(this)">';
  toast(`${files.length} photo${files.length>1?'s':''} uploaded`);
  loadPondPhotos(_currentAccountId);
}

async function deletePondPhoto(path) {
  if (!confirm('Delete this photo?')) return;
  const { error } = await sb.storage.from('pond-photos').remove([path]);
  if (error) { toast(error.message, false); return; }
  loadPondPhotos(_currentAccountId);
}

async function deleteCustomer(accountId, userId) {
  if (!confirm('Permanently delete this customer and all their data? This cannot be undone.')) return;
  const { data: { session } } = await sb.auth.getSession();
  try {
    const res = await fetch('/.netlify/functions/delete-customer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
      body: JSON.stringify({ service_account_id: accountId, user_id: userId || null })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error);
    toast('Customer deleted');
    loadPage('customers');
  } catch(err) {
    toast(err.message, false);
  }
}

async function toggleCustomerActive(accountId, currentActive) {
  const newState = !currentActive;
  const { error } = await sb.from('service_accounts').update({ active: newState }).eq('id', accountId);
  if (error) { toast(error.message, false); return; }
  toast(newState ? 'Customer reactivated' : 'Customer marked inactive');
  openCustomerDetail(accountId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECHNICIANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTechs(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Technicians</h1>
      <button class="btn-green" onclick="openModal('addTechModal')">+ Add Technician</button>
    </div>
    <div class="flex gap-2 mb-4">
      <button class="tech-filter-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" onclick="setTechFilter(this,'active')">Active</button>
      <button class="tech-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setTechFilter(this,'all')">All</button>
      <button class="tech-filter-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setTechFilter(this,'inactive')">Inactive</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="techTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Tech Modal -->
    <div id="addTechModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Technician</h2>
        <form id="addTechForm" class="space-y-3">
          <input name="full_name" placeholder="Full Name *" required class="field" />
          <input name="email" type="email" placeholder="Email *" required class="field" />
          <input name="phone" type="tel" placeholder="Phone" class="field" />
          <p class="text-xs text-gray-400">An account invite will be sent immediately to their email.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Add & Send Invite</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addTechModal')">Cancel</button>
          </div>
          <p id="addTechErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadTechTable('active');

  document.getElementById('addTechForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addTechErr');
    errEl.classList.add('hidden');

    const btn = e.target.querySelector('button[type=submit]');
    btn.textContent = 'Sending...'; btn.disabled = true;

    try {
      await callInvite(fd.get('email'), fd.get('full_name'), fd.get('phone'), 'tech', null);
      closeModal('addTechModal');
      e.target.reset();
      toast('Technician added and invite sent');
      loadTechTable(_techFilter);
    } catch(err) {
      errEl.textContent = err.message; errEl.classList.remove('hidden');
    } finally {
      btn.textContent = 'Add & Send Invite'; btn.disabled = false;
    }
  });
}

let _techFilter = 'active';
function setTechFilter(btn, filter) {
  _techFilter = filter;
  document.querySelectorAll('.tech-filter-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadTechTable(filter);
}

async function loadTechTable(filter = _techFilter) {
  let query = sb.from('technicians')
    .select('id, active, created_at, profiles(full_name, email, phone)')
    .order('created_at', { ascending: false });

  if (filter === 'active')   query = query.eq('active', true);
  if (filter === 'inactive') query = query.eq('active', false);

  const { data, error } = await query;

  const el = document.getElementById('techTableWrap');
  if (!el) return;
  if (error || !data?.length) {
    el.innerHTML = '<p class="text-gray-400 p-2">No technicians yet.</p>'; return;
  }
  el.innerHTML = `<table>
    <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Status</th><th>Added</th></tr></thead>
    <tbody>
      ${data.map(t => `<tr class="cursor-pointer" onclick="openTechDetail('${t.id}')">
        <td class="font-semibold">${t.profiles?.full_name || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.email || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.phone || 'â€”'}</td>
        <td><span class="badge ${t.active !== false ? 'badge-green' : 'badge-gray'}">${t.active !== false ? 'Active' : 'Inactive'}</span></td>
        <td class="text-gray-400">${fmtDate(t.created_at)}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

// â”€â”€â”€ TECH DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openTechDetail(techId) {
  const el = document.getElementById('pageContent');
  el.innerHTML = '<p class="text-gray-400">Loading...</p>';

  const { data: t, error } = await sb.from('technicians')
    .select('id, active, created_at, user_id, profiles(full_name, email, phone)')
    .eq('id', techId)
    .single();

  if (error || !t) { el.innerHTML = `<p class="text-red-500">Error: ${error?.message}</p>`; return; }

  const { data: visits } = await sb.from('service_visits')
    .select('id, scheduled_date, status, service_accounts(contact_name, profiles(full_name))')
    .eq('tech_id', techId)
    .order('scheduled_date', { ascending: false })
    .limit(10);

  const name  = t.profiles?.full_name || 'â€”';
  const email = t.profiles?.email     || 'â€”';
  const phone = t.profiles?.phone     || 'â€”';
  const isActive = t.active !== false;
  const toggleLabel = isActive ? 'Mark Inactive' : 'Reactivate';
  const toggleClass = isActive ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700';

  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <button onclick="loadPage('techs')" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-900 font-semibold">
        â† Back to Technicians
      </button>
      <div class="flex gap-2">
        <button class="btn-green" onclick="openModal('editTechModal')">Edit</button>
        <button class="px-4 py-2 ${toggleClass} text-white rounded-lg font-bold text-sm uppercase" onclick="toggleTechActive('${t.id}', ${isActive})">${toggleLabel}</button>
        <button class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm uppercase hover:bg-red-700" onclick="deleteTech('${t.id}','${t.user_id||''}')">Delete</button>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-6 mb-5">
      <div class="flex items-start justify-between">
        <div>
          <h1 class="text-3xl font-extrabold">${name}</h1>
          <p class="text-gray-500 mt-1">${email}</p>
        </div>
        <span class="badge ${isActive ? 'badge-green' : 'badge-gray'}">${isActive ? 'Active' : 'Inactive'}</span>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-5 mb-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-3">Contact</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-gray-500">Phone</span><span class="font-medium">${phone}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Email</span><span class="font-medium">${email}</span></div>
        <div class="flex justify-between"><span class="text-gray-500">Added</span><span class="font-medium">${fmtDate(t.created_at)}</span></div>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-5">
      <h3 class="text-xs font-bold uppercase text-gray-400 mb-4">Job History</h3>
      ${!visits?.length ? '<p class="text-gray-400 text-sm">No jobs yet.</p>' : `
      <table>
        <thead><tr><th>Date</th><th>Customer</th><th>Status</th></tr></thead>
        <tbody>
          ${visits.map(v => {
            const cust = v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”';
            return `<tr>
              <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
              <td>${cust}</td>
              <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>`}
    </div>

    <!-- Edit Modal -->
    <div id="editTechModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Edit Technician</h2>
        <form id="editTechForm" class="space-y-3">
          <input name="full_name" class="field" placeholder="Full Name" value="${name !== 'â€”' ? name : ''}" />
          <input name="phone" type="tel" class="field" placeholder="Phone" value="${phone !== 'â€”' ? phone : ''}" />
          <p class="text-xs text-gray-400">Email cannot be changed here â€” contact Supabase to update auth email.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Changes</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('editTechModal')">Cancel</button>
          </div>
          <p id="editTechErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  document.getElementById('editTechForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('editTechErr');
    errEl.classList.add('hidden');
    const { error } = await sb.from('profiles').update({
      full_name: fd.get('full_name'),
      phone:     fd.get('phone'),
    }).eq('id', t.user_id);
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('editTechModal');
    toast('Technician updated');
    openTechDetail(techId);
  });
}

async function toggleTechActive(techId, currentActive) {
  const { error } = await sb.from('technicians').update({ active: !currentActive }).eq('id', techId);
  if (error) { toast(error.message, false); return; }
  toast(!currentActive ? 'Technician reactivated' : 'Technician marked inactive');
  openTechDetail(techId);
}

async function deleteTech(techId, userId) {
  if (!confirm('Permanently delete this technician? Their past job history will be preserved but future visits will be unassigned.')) return;
  const { data: { session } } = await sb.auth.getSession();
  try {
    const res = await fetch('/.netlify/functions/delete-tech', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
      body: JSON.stringify({ tech_id: techId, user_id: userId || null })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json.error);
    toast('Technician deleted');
    loadPage('techs');
  } catch(err) {
    toast(err.message, false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderSchedule(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Schedule</h1>
      <button class="btn-green" onclick="openModal('addVisitModal')">+ Schedule Visit</button>
    </div>

    <!-- Filters -->
    <div class="flex gap-3 mb-5">
      <select id="schedFilter" class="field" style="width:auto">
        <option value="upcoming">Upcoming</option>
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="visitTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Visit Modal -->
    <div id="addVisitModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Schedule a Visit</h2>
        <form id="addVisitForm" class="space-y-3">
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Customer *</label>
            <select name="service_account_id" required class="field mt-1" id="visitCustomerSelect">
              <option value="">Loading customers...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Technician *</label>
            <select name="tech_id" required class="field mt-1" id="visitTechSelect">
              <option value="">Loading techs...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Date & Time *</label>
            <input name="scheduled_date" type="datetime-local" required class="field mt-1" />
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Notes (visible to customer)</label>
            <textarea name="notes" rows="2" placeholder="Optional notes..." class="field mt-1"></textarea>
          </div>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Schedule Visit</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addVisitModal')">Cancel</button>
          </div>
          <p id="addVisitErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadVisitTable('upcoming');
  populateVisitSelects();

  document.getElementById('schedFilter').addEventListener('change', e => {
    loadVisitTable(e.target.value);
  });

  document.getElementById('addVisitForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addVisitErr');
    errEl.classList.add('hidden');

    const { error } = await sb.from('service_visits').insert({
      service_account_id: fd.get('service_account_id'),
      tech_id:            fd.get('tech_id') || null,
      scheduled_date:     new Date(fd.get('scheduled_date')).toISOString(),
      notes:              fd.get('notes') || null,
    });

    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addVisitModal');
    e.target.reset();
    toast('Visit scheduled');
    loadVisitTable(document.getElementById('schedFilter').value);
  });
}

async function populateVisitSelects() {
  const [{ data: accounts }, { data: techs }] = await Promise.all([
    sb.from('service_accounts').select('id, contact_name, profiles(full_name)').eq('active', true).order('contact_name'),
    sb.from('technicians').select('id, profiles(full_name)').eq('active', true).order('created_at'),
  ]);

  const custSel = document.getElementById('visitCustomerSelect');
  const techSel = document.getElementById('visitTechSelect');
  if (!custSel || !techSel) return;

  custSel.innerHTML = '<option value="">Select customer...</option>' +
    (accounts||[]).map(a => `<option value="${a.id}">${a.profiles?.full_name || a.contact_name || 'Unknown'}</option>`).join('');

  techSel.innerHTML = '<option value="">Select tech (optional)...</option>' +
    (techs||[]).map(t => `<option value="${t.id}">${t.profiles?.full_name || 'Unknown'}</option>`).join('');
}

async function loadVisitTable(filter) {
  let query = sb.from('service_visits')
    .select('id, scheduled_date, status, notes, service_accounts(contact_name, profiles(full_name)), technicians(profiles(full_name))')
    .order('scheduled_date', { ascending: filter !== 'completed' });

  const now = new Date().toISOString();
  if (filter === 'upcoming')   query = query.gte('scheduled_date', now).not('status','eq','cancelled');
  if (filter === 'completed')  query = query.eq('status', 'completed');
  if (filter === 'cancelled')  query = query.eq('status', 'cancelled');

  const { data, error } = await query.limit(50);

  const el = document.getElementById('visitTableWrap');
  if (!el) return;
  if (error || !data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No visits found.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Notes</th><th>Status</th><th></th></tr></thead>
    <tbody>
      ${data.map(v => {
        const customer = v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”';
        return `<tr>
          <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
          <td>${customer}</td>
          <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
          <td class="text-gray-400 text-xs max-w-xs truncate">${v.notes || ''}</td>
          <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
          <td class="text-right">
            ${v.status==='scheduled' ? `<button class="btn-outline text-xs px-2 py-1" onclick="cancelVisit('${v.id}')">Cancel</button>` : ''}
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function cancelVisit(id) {
  if (!confirm('Cancel this visit?')) return;
  await sb.from('service_visits').update({ status: 'cancelled' }).eq('id', id);
  toast('Visit cancelled');
  loadVisitTable(document.getElementById('schedFilter')?.value || 'upcoming');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _prodCategoryFilter = 'all';

async function renderProducts(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">Products</h1>
      <div class="flex gap-2">
        <button class="btn-outline" onclick="openModal('manageCatsModal')">Manage Categories</button>
        <button class="btn-green" onclick="openAddProduct()">+ Add Product</button>
      </div>
    </div>

    <!-- Category filter pills -->
    <div class="flex flex-wrap gap-2 mb-5" id="prodCatPills">
      <button class="prod-cat-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]"
        onclick="setProdCatFilter(this,'all')">All</button>
      <button class="prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500"
        onclick="setProdCatFilter(this,'uncategorized')">Uncategorized</button>
    </div>

    <!-- Product table -->
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="productTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="manageCatsModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-4">Manage Categories</h2>
        <div id="catList" class="space-y-2 mb-4 max-h-64 overflow-y-auto">Loading...</div>
        <form id="addCatForm" class="flex gap-2 mt-2">
          <select id="catParentSelect" class="field flex-1">
            <option value="">Top-level category</option>
          </select>
          <input name="catName" placeholder="Category name" required class="field flex-1" />
          <button type="submit" class="btn-green px-4">Add</button>
        </form>
        <p id="addCatErr" class="text-red-600 text-sm mt-2 hidden"></p>
        <div class="mt-4 text-right">
          <button class="btn-outline" onclick="closeModal('manageCatsModal')">Done</button>
        </div>
      </div>
    </div>

    <!-- Add / Edit Product Modal -->
    <div id="productModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-4" id="productModalTitle">Add Product</h2>
        <form id="productForm" class="space-y-3">
          <input type="hidden" name="product_id" />
          <input name="name" placeholder="Product Name *" required class="field" />
          <input name="sku" placeholder="SKU (optional)" class="field" />
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-gray-500 uppercase">Category</label>
              <select name="category_id" class="field mt-1" id="productCatSelect">
                <option value="">Uncategorized</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-semibold text-gray-500 uppercase">Price *</label>
              <input name="price" type="number" step="0.01" placeholder="0.00" required class="field mt-1" />
            </div>
          </div>
          <textarea name="description" rows="2" placeholder="Description (optional)" class="field"></textarea>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5" id="productSubmitBtn">Save Product</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('productModal')">Cancel</button>
          </div>
          <p id="productFormErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  await loadCategoryPills();
  loadProductTable('all');
  bindProductModalForm();
  loadManageCategories();

  document.getElementById('manageCatsModal').addEventListener('click', e => {
    if (e.target.id === 'manageCatsModal') closeModal('manageCatsModal');
  });
  document.getElementById('addCatForm').addEventListener('submit', addCategory);
}

function setProdCatFilter(btn, filter) {
  _prodCategoryFilter = filter;
  document.querySelectorAll('.prod-cat-btn').forEach(b => {
    b.classList.remove('active-filter','border-[var(--green)]','text-[var(--green)]');
    b.classList.add('border-gray-200','text-gray-500');
  });
  btn.classList.add('active-filter','border-[var(--green)]','text-[var(--green)]');
  btn.classList.remove('border-gray-200','text-gray-500');
  loadProductTable(filter);
}

async function loadCategoryPills() {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  if (!cats?.length) return;

  const pills = document.getElementById('prodCatPills');
  if (!pills) return;

  // Only show top-level categories as pills
  const topLevel = cats.filter(c => !c.parent_id);
  topLevel.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500';
    btn.textContent = cat.name;
    btn.onclick = function() { setProdCatFilter(this, cat.id); };
    pills.appendChild(btn);
  });
}

async function loadProductTable(filter) {
  let query = sb.from('products')
    .select('id, name, sku, price, description, active, category_id, product_categories(id, name, parent_id, product_categories(name))')
    .order('name');

  if (filter === 'uncategorized') query = query.is('category_id', null);
  else if (filter !== 'all') {
    // filter by top-level category: include products in this cat or any sub-cat of it
    const { data: subcats } = await sb.from('product_categories').select('id').eq('parent_id', filter);
    const ids = [filter, ...(subcats||[]).map(s => s.id)];
    query = query.in('category_id', ids);
  }

  const { data, error } = await query;
  const el = document.getElementById('productTableWrap');
  if (!el) return;
  if (error) { el.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`; return; }
  if (!data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No products yet.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr>
      <th>Name</th><th>SKU</th><th>Category</th><th>Price</th><th>Status</th><th class="text-right">Actions</th>
    </tr></thead>
    <tbody>
      ${data.map(p => {
        const cat = p.product_categories
          ? (p.product_categories.product_categories?.name
              ? `${p.product_categories.product_categories.name} â€º ${p.product_categories.name}`
              : p.product_categories.name)
          : 'â€”';
        return `<tr>
          <td class="font-semibold">${p.name}${p.description ? `<p class="text-xs text-gray-400 font-normal mt-0.5 truncate max-w-xs">${p.description}</p>` : ''}</td>
          <td class="text-gray-400 text-xs">${p.sku || 'â€”'}</td>
          <td class="text-gray-500 text-sm">${cat}</td>
          <td class="font-semibold">${fmtMoney(p.price)}</td>
          <td><span class="badge ${p.active ? 'badge-green' : 'badge-gray'}">${p.active ? 'Active' : 'Inactive'}</span></td>
          <td class="text-right">
            <div class="flex justify-end gap-2">
              <button class="btn-outline text-xs px-2 py-1" onclick="openEditProduct('${p.id}')">Edit</button>
              <button class="btn-outline text-xs px-2 py-1" onclick="toggleProductActive('${p.id}',${p.active})">${p.active ? 'Deactivate' : 'Activate'}</button>
              <button class="text-xs px-2 py-1 bg-red-50 text-red-600 border border-red-200 rounded" onclick="deleteProduct('${p.id}','${(p.name).replace(/'/g,"\\'")}')">Delete</button>
            </div>
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function openAddProduct() {
  document.getElementById('productModalTitle').textContent = 'Add Product';
  document.getElementById('productForm').reset();
  document.querySelector('[name=product_id]').value = '';
  document.getElementById('productSubmitBtn').textContent = 'Save Product';
  await populateProductCatSelect();
  openModal('productModal');
}

async function openEditProduct(productId) {
  const { data: p } = await sb.from('products').select('*').eq('id', productId).single();
  if (!p) return;
  document.getElementById('productModalTitle').textContent = 'Edit Product';
  document.getElementById('productSubmitBtn').textContent = 'Save Changes';
  await populateProductCatSelect(p.category_id);
  const f = document.getElementById('productForm');
  f.querySelector('[name=product_id]').value = p.id;
  f.querySelector('[name=name]').value       = p.name || '';
  f.querySelector('[name=sku]').value        = p.sku  || '';
  f.querySelector('[name=price]').value      = p.price || '';
  f.querySelector('[name=description]').value = p.description || '';
  openModal('productModal');
}

async function populateProductCatSelect(selectedId = '') {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  const sel = document.getElementById('productCatSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Uncategorized</option>';
  if (!cats?.length) return;
  const top = cats.filter(c => !c.parent_id);
  top.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat.id; opt.textContent = cat.name;
    if (cat.id === selectedId) opt.selected = true;
    sel.appendChild(opt);
    // Sub-categories indented
    cats.filter(c => c.parent_id === cat.id).forEach(sub => {
      const sopt = document.createElement('option');
      sopt.value = sub.id; sopt.textContent = `  â”” ${sub.name}`;
      if (sub.id === selectedId) sopt.selected = true;
      sel.appendChild(sopt);
    });
  });
}

function bindProductModalForm() {
  document.getElementById('productForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('productFormErr');
    errEl.classList.add('hidden');
    const productId = fd.get('product_id');
    const payload = {
      name:        fd.get('name'),
      sku:         fd.get('sku') || null,
      price:       parseFloat(fd.get('price')),
      description: fd.get('description') || null,
      category_id: fd.get('category_id') || null,
    };
    const { error } = productId
      ? await sb.from('products').update(payload).eq('id', productId)
      : await sb.from('products').insert(payload);
    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('productModal');
    toast(productId ? 'Product updated' : 'Product added');
    loadProductTable(_prodCategoryFilter);
  });
}

async function toggleProductActive(productId, current) {
  await sb.from('products').update({ active: !current }).eq('id', productId);
  toast(!current ? 'Product activated' : 'Product deactivated');
  loadProductTable(_prodCategoryFilter);
}

async function deleteProduct(productId, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  const { error } = await sb.from('products').delete().eq('id', productId);
  if (error) { toast(error.message, false); return; }
  toast('Product deleted');
  loadProductTable(_prodCategoryFilter);
}

// â”€â”€â”€ CATEGORY MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadManageCategories() {
  const { data: cats } = await sb.from('product_categories')
    .select('id, name, parent_id').order('sort_order').order('name');
  const el = document.getElementById('catList');
  if (!el) return;
  if (!cats?.length) { el.innerHTML = '<p class="text-gray-400 text-sm">No categories yet.</p>'; return; }

  const top = cats.filter(c => !c.parent_id);
  el.innerHTML = top.map(cat => {
    const subs = cats.filter(c => c.parent_id === cat.id);
    return `<div class="border rounded-lg overflow-hidden">
      <div class="flex items-center justify-between px-3 py-2 bg-gray-50">
        <span class="font-semibold text-sm">${cat.name}</span>
        <button class="text-red-500 text-xs hover:text-red-700" onclick="deleteCategory('${cat.id}','${cat.name.replace(/'/g,"\\'")}')">Delete</button>
      </div>
      ${subs.map(s => `
        <div class="flex items-center justify-between px-4 py-1.5 border-t text-sm text-gray-600">
          <span>â”” ${s.name}</span>
          <button class="text-red-400 text-xs hover:text-red-600" onclick="deleteCategory('${s.id}','${s.name.replace(/'/g,"\\'")}')">Delete</button>
        </div>`).join('')}
    </div>`;
  }).join('');

  // Populate parent select in add form
  const parentSel = document.getElementById('catParentSelect');
  if (parentSel) {
    parentSel.innerHTML = '<option value="">Top-level category</option>' +
      top.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  }
}

async function addCategory(e) {
  e.preventDefault();
  const name = e.target.catName.value.trim();
  const parent_id = document.getElementById('catParentSelect').value || null;
  const errEl = document.getElementById('addCatErr');
  errEl.classList.add('hidden');
  if (!name) return;
  const { error } = await sb.from('product_categories').insert({ name, parent_id });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  e.target.catName.value = '';
  toast('Category added');
  loadManageCategories();
  // Refresh pills
  const pills = document.getElementById('prodCatPills');
  if (pills) {
    pills.innerHTML = `
      <button class="prod-cat-btn active-filter px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-[var(--green)] text-[var(--green)]" onclick="setProdCatFilter(this,'all')">All</button>
      <button class="prod-cat-btn px-4 py-1.5 rounded-full text-sm font-semibold border-2 border-gray-200 text-gray-500" onclick="setProdCatFilter(this,'uncategorized')">Uncategorized</button>`;
    await loadCategoryPills();
  }
}

async function deleteCategory(catId, name) {
  if (!confirm(`Delete category "${name}"? Products in this category will become uncategorized.`)) return;
  const { error } = await sb.from('product_categories').delete().eq('id', catId);
  if (error) { toast(error.message, false); return; }
  toast('Category deleted');
  loadManageCategories();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILLING (placeholder â€” next build)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderBilling(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Billing</h1>
    <div class="bg-white rounded-xl border p-6 text-gray-400 text-sm">
      Monthly statements and Stripe invoicing coming in next build.
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES â€” Ticket inbox
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _activeTicketId = null;
let _msgChannel    = null;

const TICKET_CAT_LABEL = {
  upcoming_visit:'Upcoming Visit', product_inquiry:'Product Inquiry',
  billing_issue:'Billing Issue',   ask_tech:'Ask Tech',
  pond_emergency:'Pond Emergency'
};
const TICKET_CAT_BADGE = {
  upcoming_visit:'bg-blue-100 text-blue-800',
  product_inquiry:'bg-yellow-100 text-yellow-800',
  billing_issue:'bg-orange-100 text-orange-800',
  ask_tech:'bg-purple-100 text-purple-800',
  pond_emergency:'bg-red-100 text-red-800'
};

async function renderMessages(el) {
  if (_msgChannel) { sb.removeChannel(_msgChannel); _msgChannel = null; }
  _activeTicketId = null;
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Messages</h1>
    <div style="display:grid;grid-template-columns:300px 1fr;gap:1.5rem;height:calc(100vh - 13rem);">
      <div class="bg-white rounded-xl border flex flex-col overflow-hidden">
        <div class="p-3 border-b flex items-center justify-between">
          <span class="font-bold text-sm uppercase tracking-wide">Inbox</span>
          <select id="tFilter" class="text-xs border rounded px-1.5 py-1 outline-none"
                  onchange="refreshAdminTicketList()">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
            <option value="">All</option>
          </select>
        </div>
        <div id="ticketList" class="overflow-y-auto flex-1">
          <p class="p-4 text-gray-400 text-xs">Loading...</p>
        </div>
      </div>
      <div id="threadPanel" class="bg-white rounded-xl border flex flex-col overflow-hidden">
        <div class="flex-1 flex items-center justify-center text-gray-400 text-sm">
          Select a ticket to view the conversation
        </div>
      </div>
    </div>`;
  refreshAdminTicketList();
}

async function refreshAdminTicketList() {
  const listEl = document.getElementById('ticketList');
  if (!listEl) return;
  const filter = document.getElementById('tFilter')?.value ?? 'open';
  let q = sb.from('tickets')
    .select('id, category, subject, status, urgent, updated_at, service_accounts(contact_name, profiles(full_name))')
    .order('urgent', { ascending: false })
    .order('updated_at', { ascending: false });
  if (filter) q = q.eq('status', filter);
  const { data: tickets, error } = await q;
  if (error) { listEl.innerHTML = `<p class="p-4 text-red-500 text-xs">${error.message}</p>`; return; }
  if (!tickets?.length) { listEl.innerHTML = '<p class="p-4 text-gray-400 text-xs">No tickets.</p>'; return; }
  listEl.innerHTML = tickets.map(t => {
    const name = t.service_accounts?.contact_name || t.service_accounts?.profiles?.full_name || 'Unknown';
    const active = t.id === _activeTicketId;
    return `
      <div onclick="openAdminTicket('${t.id}')"
           class="p-3 border-b cursor-pointer hover:bg-gray-50 transition-colors
                  ${active ? 'bg-blue-50' : ''}
                  ${t.urgent ? 'border-l-4 border-l-red-500' : ''}">
        <div class="flex items-start justify-between gap-1">
          <span class="font-semibold text-sm leading-tight">${escHtml(name)}</span>
          <span class="text-xs text-gray-400 shrink-0 mt-0.5">${timeAgo(t.updated_at)}</span>
        </div>
        <p class="text-gray-600 text-xs mt-0.5 truncate">${escHtml(t.subject)}</p>
        <div class="flex items-center gap-1 mt-1.5 flex-wrap">
          <span class="text-xs px-1.5 py-0.5 rounded font-semibold ${TICKET_CAT_BADGE[t.category]||'bg-gray-100 text-gray-600'}">${TICKET_CAT_LABEL[t.category]||t.category}</span>
          ${t.urgent ? '<span class="text-xs px-1.5 py-0.5 rounded font-bold bg-red-500 text-white">URGENT</span>' : ''}
          ${t.status === 'closed' ? '<span class="text-xs px-1.5 py-0.5 rounded bg-gray-200 text-gray-500">Closed</span>' : ''}
        </div>
      </div>`;
  }).join('');
}

async function openAdminTicket(ticketId) {
  _activeTicketId = ticketId;
  refreshAdminTicketList();
  const panel = document.getElementById('threadPanel');
  if (!panel) return;
  panel.innerHTML = '<div class="flex-1 flex items-center justify-center text-gray-400 text-sm">Loading...</div>';

  const { data: ticket } = await sb.from('tickets')
    .select('id, category, subject, status, urgent, service_accounts(contact_name, profiles(full_name))')
    .eq('id', ticketId).single();
  const { data: msgs } = await sb.from('ticket_messages')
    .select('id, content, created_at, profiles(full_name, role)')
    .eq('ticket_id', ticketId)
    .order('created_at', { ascending: true });

  const name = ticket.service_accounts?.contact_name || ticket.service_accounts?.profiles?.full_name || 'Unknown';
  const isClosed = ticket.status === 'closed';

  const bubbles = (arr) => (arr || []).map(m => {
    const isAdmin = m.profiles?.role === 'admin';
    return `
      <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
        <div class="max-w-xs lg:max-w-sm rounded-2xl px-4 py-2.5 ${isAdmin ? 'bg-[var(--green)] text-white' : 'bg-gray-100 text-gray-900'}">
          <p class="text-xs font-semibold mb-1 ${isAdmin?'text-white/70':'text-gray-400'}">${escHtml(m.profiles?.full_name||(isAdmin?'Admin':'Customer'))}</p>
          <p class="text-sm leading-relaxed">${escHtml(m.content)}</p>
          <p class="text-xs mt-1.5 ${isAdmin?'text-white/50':'text-gray-400'}">${timeAgo(m.created_at)}</p>
        </div>
      </div>`;
  }).join('');

  panel.innerHTML = `
    <div class="p-4 border-b flex items-start justify-between gap-3 shrink-0">
      <div class="min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <h3 class="font-bold">${escHtml(ticket.subject)}</h3>
          ${ticket.urgent ? '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500 text-white font-bold">URGENT</span>' : ''}
        </div>
        <p class="text-xs text-gray-500 mt-0.5">${escHtml(name)} Â· ${TICKET_CAT_LABEL[ticket.category]||ticket.category}</p>
      </div>
      <button onclick="adminToggleTicket('${ticket.id}','${ticket.status}')"
              class="btn-outline text-xs shrink-0">
        ${isClosed ? 'Reopen' : 'Close Ticket'}
      </button>
    </div>
    <div id="msgThread" class="flex-1 overflow-y-auto p-4 space-y-3">
      ${bubbles(msgs)}
    </div>
    <div class="p-4 border-t shrink-0 ${isClosed ? 'bg-gray-50' : ''}">
      ${isClosed
        ? '<p class="text-xs text-center text-gray-400">This ticket is closed. Reopen to reply.</p>'
        : `<textarea id="replyText" class="field w-full text-sm resize-none" rows="3"
                    placeholder="Write a reply..."></textarea>
           <div class="flex justify-end mt-2">
             <button onclick="adminSendReply('${ticket.id}')" class="btn-green text-sm">Send Reply</button>
           </div>`
      }
    </div>`;

  const thread = document.getElementById('msgThread');
  if (thread) thread.scrollTop = thread.scrollHeight;

  if (_msgChannel) { sb.removeChannel(_msgChannel); _msgChannel = null; }
  _msgChannel = sb.channel(`admin-ticket-${ticketId}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'ticket_messages',
      filter: `ticket_id=eq.${ticketId}`
    }, async (payload) => {
      const { data: m } = await sb.from('ticket_messages')
        .select('id, content, created_at, profiles(full_name, role)')
        .eq('id', payload.new.id).single();
      if (!m) return;
      const thread = document.getElementById('msgThread');
      if (!thread) return;
      const isAdmin = m.profiles?.role === 'admin';
      const div = document.createElement('div');
      div.className = `flex ${isAdmin ? 'justify-end' : 'justify-start'}`;
      div.innerHTML = `
        <div class="max-w-xs lg:max-w-sm rounded-2xl px-4 py-2.5 ${isAdmin ? 'bg-[var(--green)] text-white' : 'bg-gray-100 text-gray-900'}">
          <p class="text-xs font-semibold mb-1 ${isAdmin?'text-white/70':'text-gray-400'}">${escHtml(m.profiles?.full_name||(isAdmin?'Admin':'Customer'))}</p>
          <p class="text-sm leading-relaxed">${escHtml(m.content)}</p>
          <p class="text-xs mt-1.5 ${isAdmin?'text-white/50':'text-gray-400'}">${timeAgo(m.created_at)}</p>
        </div>`;
      thread.appendChild(div);
      thread.scrollTop = thread.scrollHeight;
      refreshAdminTicketList();
    })
    .subscribe();
}

async function adminSendReply(ticketId) {
  const textEl = document.getElementById('replyText');
  const content = textEl?.value?.trim();
  if (!content) return;
  const { data: { user } } = await sb.auth.getUser();
  const { error } = await sb.from('ticket_messages').insert({ ticket_id: ticketId, sender_id: user.id, content });
  if (error) { toast(error.message, false); return; }
  textEl.value = '';
}

async function adminToggleTicket(ticketId, currentStatus) {
  const newStatus = currentStatus === 'open' ? 'closed' : 'open';
  const { error } = await sb.from('tickets').update({ status: newStatus }).eq('id', ticketId);
  if (error) { toast(error.message, false); return; }
  toast(`Ticket ${newStatus}`);
  openAdminTicket(ticketId);
}

// â”€â”€â”€ MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id)?.classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }

// Close modal on backdrop click
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-bg')) {
    e.target.classList.add('hidden');
  }
});

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
