<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Pacific Coast Ponds</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabase.js"></script>
  <style>
    :root{ --green:#1E5E37; --blue:#2CA7DF; --dark:#0F1C12; }
    body { font-family: Inter, ui-sans-serif, system-ui; }
    h1,h2,h3 { font-family: Oswald, sans-serif; text-transform: uppercase; letter-spacing: .5px; }
    .sidebar-link { display:flex; align-items:center; gap:.75rem; padding:.65rem 1rem; border-radius:.5rem; font-weight:600; font-size:.9rem; color:rgba(255,255,255,.75); transition:background .15s; cursor:pointer; }
    .sidebar-link:hover, .sidebar-link.active { background:rgba(255,255,255,.12); color:#fff; }
    .stat-card { background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1.5rem; }
    .btn-green { background:var(--green); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; transition:background .15s; }
    .btn-green:hover { background:var(--dark); }
    .btn-blue { background:var(--blue); color:#fff; padding:.6rem 1.25rem; border-radius:.5rem; font-weight:700; font-size:.85rem; text-transform:uppercase; letter-spacing:.4px; cursor:pointer; }
    .btn-outline { border:2px solid #e5e7eb; background:#fff; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; font-size:.85rem; cursor:pointer; }
    .btn-outline:hover { border-color:#9ca3af; }
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; display:flex; align-items:center; justify-content:center; padding:1rem; }
    .modal { background:#fff; border-radius:.75rem; box-shadow:0 25px 50px rgba(0,0,0,.25); width:100%; max-width:32rem; max-height:90vh; overflow-y:auto; padding:1.5rem; }
    .field { width:100%; padding:.65rem .75rem; border:2px solid #e5e7eb; border-radius:.5rem; font-size:.9rem; outline:none; }
    .field:focus { border-color:var(--green); }
    .badge { display:inline-block; padding:.2rem .65rem; border-radius:9999px; font-size:.7rem; font-weight:700; text-transform:uppercase; letter-spacing:.4px; }
    .badge-green  { background:#dcfce7; color:#166534; }
    .badge-blue   { background:#dbeafe; color:#1e40af; }
    .badge-gray   { background:#f3f4f6; color:#6b7280; }
    .badge-yellow { background:#fef9c3; color:#854d0e; }
    table { width:100%; border-collapse:collapse; }
    th { text-align:left; font-size:.7rem; text-transform:uppercase; letter-spacing:.5px; color:#9ca3af; padding:.6rem .75rem; border-bottom:1px solid #e5e7eb; }
    td { padding:.75rem; border-bottom:1px solid #f3f4f6; font-size:.875rem; vertical-align:middle; }
    tr:last-child td { border-bottom:none; }
    tr:hover td { background:#f9fafb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center bg-[var(--dark)]">
  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
    <img src="https://paccoastponds.com/assets/logo.webp" alt="Pacific Coast Ponds" class="h-12 mx-auto mb-6">
    <h1 class="text-2xl text-center mb-6">Admin Login</h1>
    <form id="loginForm" class="space-y-4">
      <input id="loginEmail"    type="email"    placeholder="Email"    required class="field" />
      <input id="loginPassword" type="password" placeholder="Password" required class="field" />
      <button type="submit" class="btn-green w-full py-3 text-base">Sign In</button>
    </form>
    <p id="loginError" class="mt-3 text-red-600 text-sm text-center hidden"></p>
  </div>
</div>

<!-- â”€â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="appShell" class="hidden min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-56 bg-[var(--dark)] flex flex-col fixed inset-y-0 left-0 z-30">
    <div class="p-5 border-b border-white/10">
      <p class="text-white font-bold uppercase text-sm">Pacific Coast Ponds</p>
      <p class="text-white/40 text-xs mt-0.5">Admin</p>
    </div>
    <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
      <div class="sidebar-link active" data-page="dashboard">âŠ &nbsp;Dashboard</div>
      <div class="sidebar-link" data-page="customers">ğŸ‘¤ &nbsp;Customers</div>
      <div class="sidebar-link" data-page="schedule">ğŸ“… &nbsp;Schedule</div>
      <div class="sidebar-link" data-page="techs">ğŸ”§ &nbsp;Technicians</div>
      <div class="sidebar-link" data-page="products">ğŸ“¦ &nbsp;Products</div>
      <div class="sidebar-link" data-page="billing">ğŸ’³ &nbsp;Billing</div>
      <div class="sidebar-link" data-page="messages">ğŸ’¬ &nbsp;Messages</div>
    </nav>
    <div class="p-3 border-t border-white/10">
      <div id="logoutBtn" class="sidebar-link">â†’ &nbsp;Sign Out</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="ml-56 flex-1 p-8 overflow-y-auto min-h-screen">
    <div id="pageContent"></div>
  </main>
</div>

<script>
// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  if (!d) return 'â€”';
  return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}
function fmtMoney(n) { return n != null ? '$' + parseFloat(n).toFixed(2) : 'â€”'; }
function show(id)  { const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
function hide(id)  { const el=document.getElementById(id); if(el) el.classList.add('hidden'); }
function toast(msg, ok=true) {
  const t = document.createElement('div');
  t.className = `fixed bottom-6 right-6 z-[100] px-5 py-3 rounded-lg text-white font-semibold shadow-xl ${ok?'bg-green-600':'bg-red-600'}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    const { data: p } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
    if (p?.role === 'admin') { showApp(); return; }
    await sb.auth.signOut();
  }
  showLogin();
}

function showLogin() {
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('appShell').classList.add('hidden');
}
function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appShell').classList.remove('hidden');
  loadPage('dashboard');
}

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');
  const { error } = await sb.auth.signInWithPassword({
    email: document.getElementById('loginEmail').value,
    password: document.getElementById('loginPassword').value
  });
  if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
  checkAuth();
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await sb.auth.signOut(); showLogin();
});

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('[data-page]').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('[data-page]').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
    loadPage(el.dataset.page);
  });
});

function loadPage(page) {
  const pages = {
    dashboard: renderDashboard,
    customers: renderCustomers,
    schedule:  renderSchedule,
    techs:     renderTechs,
    products:  renderProducts,
    billing:   renderBilling,
    messages:  renderMessages,
  };
  const el = document.getElementById('pageContent');
  if (pages[page]) pages[page](el);
}

// â”€â”€â”€ INVITE HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callInvite(email, full_name, phone, role, service_account_id) {
  const { data: { session } } = await sb.auth.getSession();
  const res = await fetch('/.netlify/functions/invite-user', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify({ email, full_name, phone, role, service_account_id })
  });
  const json = await res.json();
  if (!res.ok) throw new Error(json.error || 'Invite failed');
  return json;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDashboard(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-8">Dashboard</h1>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Active Customers</p><p class="text-4xl font-bold mt-2" id="sC">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Visits This Week</p><p class="text-4xl font-bold mt-2" id="sV">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Technicians</p><p class="text-4xl font-bold mt-2" id="sT">â€”</p></div>
      <div class="stat-card"><p class="text-xs uppercase text-gray-400 font-semibold">Unread Messages</p><p class="text-4xl font-bold mt-2" id="sM">â€”</p></div>
    </div>
    <div class="bg-white rounded-xl border p-6">
      <h2 class="text-xl font-bold mb-4">Upcoming Visits</h2>
      <div id="upcomingList" class="text-gray-400 text-sm">Loading...</div>
    </div>
  `;

  const now = new Date();
  const week = new Date(now); week.setDate(now.getDate() + 7);

  const [cRes, vRes, tRes, mRes] = await Promise.all([
    sb.from('service_accounts').select('id', { count:'exact', head:true }).not('customer_id','is',null),
    sb.from('service_visits').select('id', { count:'exact', head:true }).gte('scheduled_date', now.toISOString()).lte('scheduled_date', week.toISOString()),
    sb.from('technicians').select('id', { count:'exact', head:true }),
    sb.from('messages').select('id', { count:'exact', head:true }).eq('read_by_admin', false),
  ]);

  if (document.getElementById('sC')) {
    document.getElementById('sC').textContent = cRes.count ?? 0;
    document.getElementById('sV').textContent = vRes.count ?? 0;
    document.getElementById('sT').textContent = tRes.count ?? 0;
    document.getElementById('sM').textContent = mRes.count ?? 0;
  }

  const { data: upcoming } = await sb.from('service_visits')
    .select('id, scheduled_date, status, service_accounts(contact_name, profiles(full_name)), technicians(profiles(full_name))')
    .gte('scheduled_date', now.toISOString())
    .order('scheduled_date', { ascending: true })
    .limit(8);

  const uvEl = document.getElementById('upcomingList');
  if (!uvEl) return;
  if (!upcoming?.length) { uvEl.innerHTML = '<p class="text-gray-400">No upcoming visits scheduled.</p>'; return; }
  uvEl.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Status</th></tr></thead>
    <tbody>${upcoming.map(v => `<tr>
      <td>${fmtDate(v.scheduled_date)}</td>
      <td class="font-medium">${v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”'}</td>
      <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
      <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderCustomers(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Customers</h1>
      <button class="btn-green" onclick="openModal('addCustomerModal')">+ Add Customer</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="customerTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Customer</h2>
        <form id="addCustomerForm" class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <input name="contact_name"  placeholder="Full Name *" required class="field col-span-2" />
            <input name="contact_email" type="email" placeholder="Email *" required class="field" />
            <input name="contact_phone" type="tel" placeholder="Phone" class="field" />
          </div>
          <input name="address" placeholder="Service Address" class="field" />
          <input name="monthly_service_fee" type="number" step="0.01" placeholder="Monthly Service Fee ($)" class="field" />
          <textarea name="pond_notes" rows="2" placeholder="Pond notes (size, fish count, equipment...)" class="field"></textarea>
          <p class="text-xs text-gray-400">No account invite will be sent yet. You control when that happens.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Save Customer</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addCustomerModal')">Cancel</button>
          </div>
          <p id="addCustErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadCustomerTable();

  document.getElementById('addCustomerForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addCustErr');
    errEl.classList.add('hidden');

    const { error } = await sb.from('service_accounts').insert({
      contact_name:        fd.get('contact_name'),
      contact_email:       fd.get('contact_email'),
      contact_phone:       fd.get('contact_phone'),
      address:             fd.get('address'),
      monthly_service_fee: parseFloat(fd.get('monthly_service_fee')) || 0,
      pond_notes:          fd.get('pond_notes'),
    });

    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addCustomerModal');
    e.target.reset();
    toast('Customer added');
    loadCustomerTable();
  });
}

async function loadCustomerTable() {
  const { data, error } = await sb.from('service_accounts')
    .select('id, contact_name, contact_email, contact_phone, address, monthly_service_fee, invite_sent_at, customer_id, profiles(full_name)')
    .order('created_at', { ascending: false });

  const el = document.getElementById('customerTableWrap');
  if (!el) return;
  if (error) {
    el.innerHTML = `<p class="text-red-500 p-2">Error: ${error.message}</p>`; return;
  }
  if (!data?.length) {
    el.innerHTML = '<p class="text-gray-400 p-2">No customers yet.</p>'; return;
  }

  el.innerHTML = `<table>
    <thead><tr>
      <th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Monthly Fee</th><th>Status</th><th></th>
    </tr></thead>
    <tbody>
      ${data.map(c => {
        const name  = c.profiles?.full_name  || c.contact_name  || 'â€”';
        const email = c.profiles?.email      || c.contact_email || 'â€”';
        const phone = c.contact_phone || 'â€”';
        let badge, statusLabel;
        if (c.customer_id)       { badge = 'badge-green';  statusLabel = 'Active'; }
        else if (c.invite_sent_at) { badge = 'badge-yellow'; statusLabel = 'Invited'; }
        else                      { badge = 'badge-gray';   statusLabel = 'Not Invited'; }
        const canInvite = !c.invite_sent_at && c.contact_email;
        return `<tr>
          <td class="font-semibold">${name}</td>
          <td class="text-gray-500">${email}</td>
          <td class="text-gray-500">${phone}</td>
          <td class="text-gray-500">${c.address || 'â€”'}</td>
          <td>${fmtMoney(c.monthly_service_fee)}</td>
          <td><span class="badge ${badge}">${statusLabel}</span></td>
          <td class="text-right">
            ${canInvite ? `<button class="btn-blue text-xs px-3 py-1.5" onclick="sendCustomerInvite('${c.id}','${c.contact_email}','${(c.contact_name||'').replace(/'/g,"\\'")}','${(c.contact_phone||'')}')">Send Invite</button>` : ''}
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function sendCustomerInvite(saId, email, name, phone) {
  if (!confirm(`Send account invite to ${email}?`)) return;
  try {
    await callInvite(email, name, phone, 'customer', saId);
    toast('Invite sent to ' + email);
    loadCustomerTable();
  } catch(err) {
    toast(err.message, false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TECHNICIANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTechs(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Technicians</h1>
      <button class="btn-green" onclick="openModal('addTechModal')">+ Add Technician</button>
    </div>
    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="techTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Tech Modal -->
    <div id="addTechModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">New Technician</h2>
        <form id="addTechForm" class="space-y-3">
          <input name="full_name" placeholder="Full Name *" required class="field" />
          <input name="email" type="email" placeholder="Email *" required class="field" />
          <input name="phone" type="tel" placeholder="Phone" class="field" />
          <p class="text-xs text-gray-400">An account invite will be sent immediately to their email.</p>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Add & Send Invite</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addTechModal')">Cancel</button>
          </div>
          <p id="addTechErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadTechTable();

  document.getElementById('addTechForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addTechErr');
    errEl.classList.add('hidden');

    const btn = e.target.querySelector('button[type=submit]');
    btn.textContent = 'Sending...'; btn.disabled = true;

    try {
      await callInvite(fd.get('email'), fd.get('full_name'), fd.get('phone'), 'tech', null);
      closeModal('addTechModal');
      e.target.reset();
      toast('Technician added and invite sent');
      loadTechTable();
    } catch(err) {
      errEl.textContent = err.message; errEl.classList.remove('hidden');
    } finally {
      btn.textContent = 'Add & Send Invite'; btn.disabled = false;
    }
  });
}

async function loadTechTable() {
  const { data, error } = await sb.from('technicians')
    .select('id, created_at, profiles(full_name, email, phone)')
    .order('created_at', { ascending: false });

  const el = document.getElementById('techTableWrap');
  if (!el) return;
  if (error || !data?.length) {
    el.innerHTML = '<p class="text-gray-400 p-2">No technicians yet.</p>'; return;
  }
  el.innerHTML = `<table>
    <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Added</th></tr></thead>
    <tbody>
      ${data.map(t => `<tr>
        <td class="font-semibold">${t.profiles?.full_name || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.email || 'â€”'}</td>
        <td class="text-gray-500">${t.profiles?.phone || 'â€”'}</td>
        <td class="text-gray-400">${fmtDate(t.created_at)}</td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEDULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderSchedule(el) {
  el.innerHTML = `
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold">Schedule</h1>
      <button class="btn-green" onclick="openModal('addVisitModal')">+ Schedule Visit</button>
    </div>

    <!-- Filters -->
    <div class="flex gap-3 mb-5">
      <select id="schedFilter" class="field" style="width:auto">
        <option value="upcoming">Upcoming</option>
        <option value="all">All</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div class="bg-white rounded-xl border overflow-hidden">
      <div id="visitTableWrap" class="p-4 text-gray-400 text-sm">Loading...</div>
    </div>

    <!-- Add Visit Modal -->
    <div id="addVisitModal" class="modal-bg hidden">
      <div class="modal">
        <h2 class="text-2xl font-bold mb-5">Schedule a Visit</h2>
        <form id="addVisitForm" class="space-y-3">
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Customer *</label>
            <select name="service_account_id" required class="field mt-1" id="visitCustomerSelect">
              <option value="">Loading customers...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Technician *</label>
            <select name="tech_id" required class="field mt-1" id="visitTechSelect">
              <option value="">Loading techs...</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Date & Time *</label>
            <input name="scheduled_date" type="datetime-local" required class="field mt-1" />
          </div>
          <div>
            <label class="text-xs font-semibold text-gray-500 uppercase">Notes (visible to customer)</label>
            <textarea name="notes" rows="2" placeholder="Optional notes..." class="field mt-1"></textarea>
          </div>
          <div class="flex gap-3 pt-1">
            <button type="submit" class="btn-green flex-1 py-2.5">Schedule Visit</button>
            <button type="button" class="btn-outline flex-1" onclick="closeModal('addVisitModal')">Cancel</button>
          </div>
          <p id="addVisitErr" class="text-red-600 text-sm hidden"></p>
        </form>
      </div>
    </div>
  `;

  loadVisitTable('upcoming');
  populateVisitSelects();

  document.getElementById('schedFilter').addEventListener('change', e => {
    loadVisitTable(e.target.value);
  });

  document.getElementById('addVisitForm').addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const errEl = document.getElementById('addVisitErr');
    errEl.classList.add('hidden');

    const { error } = await sb.from('service_visits').insert({
      service_account_id: fd.get('service_account_id'),
      tech_id:            fd.get('tech_id') || null,
      scheduled_date:     new Date(fd.get('scheduled_date')).toISOString(),
      notes:              fd.get('notes') || null,
    });

    if (error) { errEl.textContent = error.message; errEl.classList.remove('hidden'); return; }
    closeModal('addVisitModal');
    e.target.reset();
    toast('Visit scheduled');
    loadVisitTable(document.getElementById('schedFilter').value);
  });
}

async function populateVisitSelects() {
  const [{ data: accounts }, { data: techs }] = await Promise.all([
    sb.from('service_accounts').select('id, contact_name, profiles(full_name)').order('contact_name'),
    sb.from('technicians').select('id, profiles(full_name)').order('created_at'),
  ]);

  const custSel = document.getElementById('visitCustomerSelect');
  const techSel = document.getElementById('visitTechSelect');
  if (!custSel || !techSel) return;

  custSel.innerHTML = '<option value="">Select customer...</option>' +
    (accounts||[]).map(a => `<option value="${a.id}">${a.profiles?.full_name || a.contact_name || 'Unknown'}</option>`).join('');

  techSel.innerHTML = '<option value="">Select tech (optional)...</option>' +
    (techs||[]).map(t => `<option value="${t.id}">${t.profiles?.full_name || 'Unknown'}</option>`).join('');
}

async function loadVisitTable(filter) {
  let query = sb.from('service_visits')
    .select('id, scheduled_date, status, notes, service_accounts(contact_name, profiles(full_name)), technicians(profiles(full_name))')
    .order('scheduled_date', { ascending: filter !== 'completed' });

  const now = new Date().toISOString();
  if (filter === 'upcoming')   query = query.gte('scheduled_date', now).not('status','eq','cancelled');
  if (filter === 'completed')  query = query.eq('status', 'completed');
  if (filter === 'cancelled')  query = query.eq('status', 'cancelled');

  const { data, error } = await query.limit(50);

  const el = document.getElementById('visitTableWrap');
  if (!el) return;
  if (error || !data?.length) { el.innerHTML = '<p class="text-gray-400 p-2">No visits found.</p>'; return; }

  el.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Customer</th><th>Tech</th><th>Notes</th><th>Status</th><th></th></tr></thead>
    <tbody>
      ${data.map(v => {
        const customer = v.service_accounts?.profiles?.full_name || v.service_accounts?.contact_name || 'â€”';
        return `<tr>
          <td class="font-medium">${fmtDate(v.scheduled_date)}</td>
          <td>${customer}</td>
          <td class="text-gray-500">${v.technicians?.profiles?.full_name || 'â€”'}</td>
          <td class="text-gray-400 text-xs max-w-xs truncate">${v.notes || ''}</td>
          <td><span class="badge ${v.status==='completed'?'badge-green':v.status==='cancelled'?'badge-gray':'badge-blue'}">${v.status}</span></td>
          <td class="text-right">
            ${v.status==='scheduled' ? `<button class="btn-outline text-xs px-2 py-1" onclick="cancelVisit('${v.id}')">Cancel</button>` : ''}
          </td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

async function cancelVisit(id) {
  if (!confirm('Cancel this visit?')) return;
  await sb.from('service_visits').update({ status: 'cancelled' }).eq('id', id);
  toast('Visit cancelled');
  loadVisitTable(document.getElementById('schedFilter')?.value || 'upcoming');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS (placeholder â€” next build)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderProducts(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Products</h1>
    <div class="bg-white rounded-xl border p-6 text-gray-400 text-sm">
      Product catalog coming in next build.
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILLING (placeholder â€” next build)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderBilling(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Billing</h1>
    <div class="bg-white rounded-xl border p-6 text-gray-400 text-sm">
      Monthly statements and Stripe invoicing coming in next build.
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES (placeholder â€” next build)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderMessages(el) {
  el.innerHTML = `
    <h1 class="text-3xl font-extrabold mb-6">Messages</h1>
    <div class="bg-white rounded-xl border p-6 text-gray-400 text-sm">
      Customer messaging coming in next build.
    </div>`;
}

// â”€â”€â”€ MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id)?.classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }

// Close modal on backdrop click
document.addEventListener('click', e => {
  if (e.target.classList.contains('modal-bg')) {
    e.target.classList.add('hidden');
  }
});

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
